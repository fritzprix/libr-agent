# Sprint Log

## 2025-10-10

- [x] Workspace MCP 도구에 execute_shell에 async 실행 지원 추가 (완료)
  - [x] async execute일 경우 process에 대한 정보를 응답
    - `run_mode: "async"` 파라미터로 백그라운드 실행 지원
    - 즉시 `process_id`와 명령어 정보를 포함한 응답 반환
  - [x] background로 실행할 경우 이 process의 상태 관리 기능을 추가하고
    - `ProcessRegistry`에 동기/비동기 프로세스 모두 등록
    - `CancellationToken`을 활용한 프로세스별 취소 지원
    - 세션 전환 시 자동으로 이전 세션의 실행 중인 프로세스 취소 및 종료
  - [x] get_service_context에 진행중인 process의 요약을 제공
    - 현재 세션의 실행 중인 프로세스 목록과 상태 정보 포함
  - [x] poll_process (or better name)을 통해 process의 상태 정보 및 완료 시 terminal output을 읽어올 수 있음
    - `poll_process`: 프로세스 상태, exit code, stdout/stderr 크기 확인
    - `read_process_output`: stdout/stderr 파일 내용 읽기 (tail/head 옵션 지원)
    - `list_processes`: 현재 세션의 모든 프로세스 목록 조회
  - [x] 추가 구현 사항
    - Sync 모드 최대 타임아웃을 환경 변수로 설정 가능하도록 개선 (`SYNAPTICFLOW_DEFAULT_EXECUTION_TIMEOUT`)
    - 기본값 30초, 초과 시 async 모드 사용 안내
    - 대용량 출력(100MB 제한) 스트리밍 및 파일 저장으로 메모리 효율성 개선
    - 동기/비동기 실행 모두 통일된 `spawn_and_stream_to_files` 헬퍼 사용
- [ ] Assistant를 검색하고 assistant가 assistant에게 task를 부여할 수 있는 MCP Server 구현
  - list_assistant
    - pagination 지원
  - search_assistant
    - query: string
    - assistant의 description을 기반으로 bm25 matching 검색 제공
  - spawn_assistant
    - assistant_id: string
    - query: string
  - poll_assistant
- [ ] light weight assistant runner 구현을 위한 기획
  - 현재 프로젝트의 타입과 호환되는 light weight assistant runner program을 rust로 작성하고자 한다.
  - stdio를 통한 RPC 통신으로 main process와 통신 필수적인 callback을 지원, main process의 아래 함수를 구현해야 함
    - on_aggregate_service_context(thread_id: string) : 해당 assistant에서 사용중인 built in tool의 context를 수집하여 전달
      - 각 built-in 도구에 구현된 get_service_context를 그대로 재사용함
    - on_llm_request(thread_id: string, messages: Message[]) => Message
    - on_tool_call(thread_id: string, MCPTool) => MCPResponse
    - send_message(from: string, to: string, message: string) => MCPResponse
    - recv_message(thread_id) => { messages: { from: string, to: string, message: string }[] or MCPResponse
  - on_llm_request 구조
    - on_llm_request()
      - look up relevant session with thread_id
      - look up assistant with thread_id
        - get built-in tools used by assistant
        - call get_service_context based on the built-in tools
      - add assistant system prompt into message stack
      - get MCP tools (including built-in tools) assistant using
      - const { submit } = use_ai_service() (혹은 이를 위한 전용 interface 필요)
      - session
        - thread_1
          - messages
        - thread_2
        - ...
  - message box 방식의 통신
    - 서로 다른 assistant는 부모 assistant와 child sibling과 공유된 message box를 받는다.
    - light weight runner에서 built-in tool로 이 message box 관련 도구가 제공되어야 하고 실제 이를 처리하는 것은 parent process 임
