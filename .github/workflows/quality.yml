name: 🔍 Code Quality

on:
  pull_request:
    branches: [ main, master, ref/chat ]

jobs:
  quality:
    name: 🔍 Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: � Setup Environment
      uses: ./.github/actions/setup-tauri-env
      with:
        install-tauri-deps: 'true'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'pnpm'

    - name: Enable Corepack and prepare pnpm
      run: |
        corepack enable
        corepack prepare pnpm@latest --activate

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: 🔍 ESLint
      run: pnpm lint

    - name: 🎨 Prettier Check
      run: |
        echo "Checking code formatting..."
        if pnpm format:check; then
          echo "✅ All files are properly formatted"
          exit 0
        else
          echo "⚠️ Code formatting issues found!"
          echo "💡 Run 'pnpm format' locally to fix formatting issues"
          echo "📋 Files that need formatting:"
          pnpm format:check 2>&1 | grep -E '\.(ts|tsx|js|jsx|json|css|scss|md)$' || true
          exit 1
        fi

    - name: 🔍 TypeScript Check
      run: pnpm tsc --noEmit

    - name: 🔍 Rust Clippy
      run: cd src-tauri && cargo clippy -- -D warnings

    - name: 🎨 Rust Format Check
      run: cd src-tauri && cargo fmt --check

  security:
    name: 🔒 Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: � Setup Environment
      uses: ./.github/actions/setup-tauri-env
      with:
        install-tauri-deps: 'false'

    - name: 🔒 npm audit
      run: pnpm audit --audit-level high
      continue-on-error: true

    - name: 🔒 Cargo audit
      run: |
        cargo install cargo-audit
        cd src-tauri && cargo audit
      continue-on-error: true
