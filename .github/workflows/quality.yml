name: ğŸ” Code Quality

on:
  pull_request:
    branches: [ main, master, ref/chat ]

jobs:
  quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ï¿½ Setup Environment
      uses: ./.github/actions/setup-tauri-env
      with:
        install-tauri-deps: 'true'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18
        cache: 'pnpm'

    - name: Enable Corepack and prepare pnpm
      run: |
        corepack enable
        corepack prepare pnpm@latest --activate

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: ğŸ” ESLint
      run: pnpm lint

    - name: ğŸ¨ Prettier Check
      run: |
        echo "Checking code formatting..."
        if pnpm format:check; then
          echo "âœ… All files are properly formatted"
          exit 0
        else
          echo "âš ï¸ Code formatting issues found!"
          echo "ğŸ’¡ Run 'pnpm format' locally to fix formatting issues"
          echo "ğŸ“‹ Files that need formatting:"
          pnpm format:check 2>&1 | grep -E '\.(ts|tsx|js|jsx|json|css|scss|md)$' || true
          exit 1
        fi

    - name: ğŸ” TypeScript Check
      run: pnpm tsc --noEmit

    - name: ğŸ” Rust Clippy
      run: cd src-tauri && cargo clippy -- -D warnings

    - name: ğŸ¨ Rust Format Check
      run: cd src-tauri && cargo fmt --check

  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ï¿½ Setup Environment
      uses: ./.github/actions/setup-tauri-env
      with:
        install-tauri-deps: 'false'

    - name: ğŸ”’ npm audit
      run: pnpm audit --audit-level high
      continue-on-error: true

    - name: ğŸ”’ Cargo audit
      run: |
        cargo install cargo-audit
        cd src-tauri && cargo audit
      continue-on-error: true
