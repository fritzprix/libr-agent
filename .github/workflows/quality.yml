name: ðŸ” Code Quality

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  quality:
    name: ðŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
    
    - name: ðŸ“¦ Install dependencies
      run: pnpm install

    - name: ðŸ” ESLint
      run: pnpm lint
      continue-on-error: true

    - name: ðŸŽ¨ Prettier Check
      run: |
        echo "Checking code formatting..."
        if pnpm format:check; then
          echo "âœ… All files are properly formatted"
          exit 0
        else
          echo "âš ï¸ Code formatting issues found!"
          echo "ðŸ’¡ Run 'pnpm format' locally to fix formatting issues"
          echo "ðŸ“‹ Files that need formatting:"
          pnpm format:check 2>&1 | grep -E '\.(ts|tsx|js|jsx|json|css|scss|md)$' || true
          exit 1
        fi

    - name: ðŸ” TypeScript Check
      run: pnpm tsc --noEmit

    - name: ðŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: ðŸ¦€ Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: ðŸ” Rust Clippy
      run: cd src-tauri && cargo clippy -- -D warnings

    - name: ðŸŽ¨ Rust Format Check
      run: cd src-tauri && cargo fmt --check

  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
    
    - name: ðŸ“¦ Install dependencies
      run: pnpm install

    - name: ðŸ”’ npm audit
      run: pnpm audit --audit-level high
      continue-on-error: true

    - name: ðŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: ðŸ¦€ Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: ðŸ”’ Cargo audit
      run: |
        cargo install cargo-audit
        cd src-tauri && cargo audit
      continue-on-error: true
