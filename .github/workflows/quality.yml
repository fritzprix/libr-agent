name: 🔍 Code Quality

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  quality:
    name: 🔍 Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
    
    - name: 📦 Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
    
    - name: 📦 Install dependencies
      run: pnpm install

    - name: 🔍 ESLint
      run: pnpm lint
      continue-on-error: true

    - name: 🎨 Prettier Check
      run: |
        echo "Checking code formatting..."
        if pnpm format:check; then
          echo "✅ All files are properly formatted"
          exit 0
        else
          echo "⚠️ Code formatting issues found!"
          echo "💡 Run 'pnpm format' locally to fix formatting issues"
          echo "📋 Files that need formatting:"
          pnpm format:check 2>&1 | grep -E '\.(ts|tsx|js|jsx|json|css|scss|md)$' || true
          exit 1
        fi

    - name: 🔍 TypeScript Check
      run: pnpm tsc --noEmit

    - name: 🦀 Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: 🦀 Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: 🔍 Rust Clippy
      run: cd src-tauri && cargo clippy -- -D warnings

    - name: 🎨 Rust Format Check
      run: cd src-tauri && cargo fmt --check

  security:
    name: 🔒 Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
    
    - name: 📦 Install pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 9
    
    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
    
    - name: 📦 Install dependencies
      run: pnpm install

    - name: 🔒 npm audit
      run: pnpm audit --audit-level high
      continue-on-error: true

    - name: 🦀 Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: 🦀 Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'

    - name: 🔒 Cargo audit
      run: |
        cargo install cargo-audit
        cd src-tauri && cargo audit
      continue-on-error: true
