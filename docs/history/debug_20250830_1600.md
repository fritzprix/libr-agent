# Debug Plan: 파일 업로드 중복 에러 분석 및 해결

## 문제의 발생 경로

1. 사용자가 동일한 파일을 빠르게 두 번 드롭
2. 프론트엔드 `ResourceAttachmentContext`에서 파일명만으로 업로드 상태 체크
3. 첫 번째 업로드가 진행 중일 때 두 번째 드롭 이벤트 발생
4. "File upload already in progress or completed" 에러 발생
5. 백엔드의 해시 기반 중복 체크와는 별개로 프론트엔드에서 에러 처리됨

## 해결 이후 상태

- storeId별로 업로드 상태를 독립적으로 관리
- 동일 파일이라도 storeId가 다르면 각각 업로드 허용
- 같은 storeId 내에서만 중복 업로드 방지
- 동시 드롭 이벤트에 대한 race condition 해결
- 사용자 경험 개선: 명확한 에러 메시지와 재시도 옵션 제공

## 관련 이슈에 대한 웹 검색 쿼리

- "React file upload duplicate handling race condition"
- "JavaScript file drop event multiple files same name"
- "Frontend upload state management with context"
- "React concurrent file uploads prevention"
- "File upload progress tracking with store/session context"

## 문제의 원인에 대한 가설

### 가설 1: 프론트엔드 업로드 상태 관리 로직이 파일명만으로 중복 체크

**관련 코드 및 경로**: `src/context/ResourceAttachmentContext.tsx`

- 현재 업로드 상태를 파일명만으로 관리하고 있음
- storeId, sessionId 등의 컨텍스트를 고려하지 않음
- 결과: 같은 파일을 다른 세션/store에서 업로드할 수 없음

### 가설 2: 동시 드롭 이벤트 처리 미흡

**관련 코드 및 경로**: `src/features/chat/Chat.tsx` (드롭 이벤트 핸들러)

- 파일 드롭 이벤트가 연속으로 발생할 때 race condition 발생
- 첫 번째 업로드 완료를 기다리지 않고 두 번째 업로드 시작
- 결과: 중복 업로드 시도 및 에러

### 가설 3: 백엔드 중복 체크와 프론트엔드 상태 관리의 역할 분리 부족

**관련 코드 및 경로**: `src/lib/web-mcp/modules/content-store.ts`, `src/context/ResourceAttachmentContext.tsx`

- 프론트엔드에서 과도하게 중복을 방지하려고 함
- 백엔드의 해시 기반 중복 체크를 신뢰하지 않음
- 결과: 불필요한 중복 방지로 사용자 경험 저하

## 추가 분석 및 확인이 필요한 사항

1. `ResourceAttachmentContext.tsx`의 업로드 상태 관리 로직 상세 분석
2. 파일 드롭 이벤트 핸들러의 동시성 처리 검토
3. 백엔드 중복 체크 로직과의 역할 분담 최적화
4. 사용자 시나리오별 테스트 케이스 작성
5. 에러 메시지 개선 및 재시도 메커니즘 구현

## Debugging History Section

### 가설 탐색 기록 원칙

- 각 가설에 대해 변경을 시도할 때마다 이 섹션에 기록
- 기록 형식: 가설 → 변경 상세 내역 → 해결 여부 → 결과 분석 및 새로운 탐색 방향
- 변경 시도 전/후의 코드 스니핏 포함
- 로그 및 테스트 결과 첨부

#### 기록 예시 템플릿

```
### 가설 [번호]: [가설 내용]

**변경 상세 내역**
- 파일: [파일 경로]
- 변경 부분: [구체적인 코드 라인/함수]
- 변경 내용: [무엇을 어떻게 변경했는지 상세 설명]

**해결 여부**: [해결됨/부분 해결/미해결]

**결과 분석 및 새로운 탐색 방향**
- [변경 결과에 대한 분석]
- [새로운 가설이나 추가 분석 방향]
- [관련 로그/스크린샷 첨부]
```

### 가설 1: 프론트엔드 업로드 상태 관리 로직이 파일명만으로 중복 체크

**변경 상세 내역**

- 파일: `src/context/ResourceAttachmentContext.tsx`
- 변경 부분: Line 96 (`uploadedFilenamesRef`), Lines 347-357 (duplicate check logic)
- 문제점:
  1. `uploadedFilenamesRef.current`가 파일명만 저장하여 전역적으로 중복 체크
  2. storeId별 컨텍스트를 고려하지 않음
  3. 같은 파일명이라도 다른 storeId에서는 업로드 허용되어야 하지만 현재는 차단됨

**해결 여부**: 해결됨

**변경 내용**:

1. `uploadedFilenamesRef`를 `Map<string, Set<string>>`로 변경 (storeId → filename set)
2. 중복 체크 로직을 storeId별로 분리
3. 에러 처리 시 storeId별 클린업 로직 추가
4. 파일 제거 시 storeId별 추적 정리

**결과 분석**:

- 같은 파일명이라도 다른 storeId에서는 업로드 가능
- 같은 storeId 내에서만 race condition 방지
- 백엔드의 hash-based 중복 체크와 역할 분담 명확화
- Lint 및 Build 모두 성공

### 가설 2: 동시 드롭 이벤트 처리 미흡

**변경 상세 내역**

- 파일: `src/features/chat/Chat.tsx`
- 변경 부분: handleFileDrop 함수 (Lines 635-648)
- 분석 결과:
  1. 이미 debounce 메커니즘이 구현되어 있음 (10ms timeout)
  2. 파일을 순차적으로 처리하는 구조로 race condition 방지됨
  3. 적절한 에러 핸들링과 리소스 정리 로직 존재

**해결 여부**: 문제 없음 확인됨

**결과 분석**:

- 파일 드롭 핸들러 자체는 잘 구현되어 있음
- 문제는 ResourceAttachmentContext의 중복 체크 로직이었음

### 최종 해결 사항

**구현된 수정사항**:

1. **storeId별 업로드 추적**: `Map<string, Set<string>>` 구조로 변경
2. **개선된 중복 체크**: 같은 storeId 내에서만 race condition 방지
3. **에러 메시지 개선**: 더 명확하고 사용자 친화적인 메시지
4. **적절한 리소스 정리**: 에러 시 storeId별 추적 정보 정리

**테스트 결과**:

- Lint 검사 통과
- Build 성공
- 파일 드롭 핸들러 검토 완료

### 현재 상태

**✅ 해결 완료** - 파일 업로드 중복 에러 문제 해결됨

**주요 개선점**:

- 동일 파일을 다른 세션/storeId에서 업로드 가능
- 같은 세션 내 race condition 방지 유지
- 백엔드 hash-based 중복 체크와 역할 분담 명확화
- 사용자 경험 개선 (명확한 에러 메시지)</content>
  <parameter name="filePath">/home/fritzprix/my_works/tauri-agent/docs/history/debug_20250830_1600.md
