# Debug Plan: similaritySearch BM25 Consolidation 오류

## 1. 문제의 발생 경로

### 1.1 사용자 요청 경로

1. 사용자가 `similaritySearch` 도구 호출
2. `content-store.ts`의 `similaritySearch` 함수 실행
3. `BM25SearchEngine.search()` 메서드 호출
4. BM25 라이브러리에서 `"winkBM25S: search is not possible unless learnings are consolidated!"` 오류 발생

### 1.2 코드 실행 경로

````
### 1.2 코드 실행 경로

```bash
similaritySearch() → BM25SearchEngine.search() → bm25.search() → 오류 발생
````

### 1.3 관련 파일 경로

- `/home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/modules/content-store.ts`
- BM25SearchEngine 클래스 내부 메서드들

## 2. 문제의 원인에 대한 가설

### 가설 1: BM25 인덱스 consolidate 누락 (가장 가능성 높음)

**설명**: BM25 인덱스에 청크를 추가한 후 `bm25.consolidate()`가 호출되지 않아 검색이 불가능한 상태

**관련 코드 및 경로**:

```typescript
// /home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/modules/content-store.ts
// BM25SearchEngine.addToIndex() 메서드
if (chunkMapping.size > 0) {
  try {
    bm25.consolidate();
  } catch (consolidateError) {
    logger.warn('BM25 consolidation failed, continuing anyway', {...});
  }
}
```

**증거**:

- `addToIndex`에서 청크가 추가될 때만 consolidate 호출
- 청크가 중복되거나 이미 존재하는 경우 consolidate 생략 가능성
- 오류 메시지가 "consolidation"을 명시적으로 언급

### 가설 2: BM25 인덱스 초기화 실패

**설명**: BM25 인덱스가 제대로 초기화되지 않았거나, 초기화 과정에서 consolidate가 누락됨

**관련 코드 및 경로**:

```typescript
// /home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/modules/content-store.ts
// BM25SearchEngine.initialize() 메서드
async initialize(): Promise<void> {
  if (this.isInitialized) {
    logger.info('Initializing BM25 search engine');
    this.isInitialized = true;
  }
}
```

**증거**:

- `initialize()` 메서드가 실제 BM25 인스턴스 초기화를 수행하지 않음
- `rebuildIndex()`에서만 BM25 인스턴스 생성 및 초기화

### 가설 3: 청크 추가 실패 또는 데이터 불일치

**설명**: 청크가 BM25 인덱스에 제대로 추가되지 않았거나, 청크 데이터와 인덱스 간 불일치 발생

**관련 코드 및 경로**:

```typescript
// /home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/modules/content-store.ts
// BM25SearchEngine.rebuildIndex() 메서드
private async rebuildIndex(storeId: string, chunks: FileChunk[]): Promise<void> {
  // ...청크 추가 로직...
  for (const chunk of chunks) {
    bm25.addDoc({ id: chunk.id, text: chunk.text });
  }
  // consolidate 호출 누락 가능성
}
```

**증거**:

- `rebuildIndex`에서 청크 추가 후 consolidate 호출 여부 확인 필요
- 청크 데이터 구조와 BM25 입력 형식 간 호환성 문제 가능성

## 3. 관련 이슈에 대한 웹 검색 쿼리

### 3.1 BM25 라이브러리 관련

- `"winkBM25S search is not possible unless learnings are consolidated"`
- `"wink-bm25 search consolidate error"`
- `"BM25 consolidate before search"`

### 3.2 일반적인 BM25 사용법

- `"BM25 index consolidation"`
- `"BM25 search after adding documents"`
- `"wink-bm25 consolidate method"`

### 3.3 JavaScript/TypeScript BM25 구현

- `"wink-bm25 consolidate usage"`
- `"BM25 search consolidation requirement"`

## 4. 추가 분석 및 확인이 필요한 사항

### 4.1 코드 레벨 분석

- [ ] `BM25SearchEngine.addToIndex()`에서 consolidate 호출 조건 검토
- [ ] `BM25SearchEngine.rebuildIndex()`에서 consolidate 호출 여부 확인
- [ ] BM25 인스턴스 초기화 및 라이프사이클 검토
- [ ] 청크 추가 시 데이터 변환 로직 검증

### 4.2 런타임 분석

- [ ] 실제 실행 시 BM25 인스턴스 상태 로깅 추가
- [ ] 청크 추가 후 consolidate 호출 여부 확인
- [ ] 검색 시도 전 인덱스 상태 검증 로직 추가

### 4.3 테스트 케이스

- [ ] 빈 스토어에 검색 시도
- [ ] 청크 추가 후 즉시 검색
- [ ] 여러 번 청크 추가 후 검색
- [ ] 인덱스 재구성 후 검색

### 4.4 라이브러리 의존성

- [ ] wink-bm25 버전 및 문서 확인
- [ ] BM25 consolidate API 스펙 검토
- [ ] 다른 BM25 라이브러리와의 비교

## 5. file 규칙

- 변경 내역 및 계획은 `./docs/history/debug_{yyyyMMdd_hhmm}.md`에 기록
