# Debug Plan: Content Store similaritySearch 오류 분석

## 문제의 발생 경로

Content store 기능 테스트 중 `similaritySearch` 도구 호출 시 "winkBM25S: search is not possible unless learnings are consolidated!" 오류가 발생했습니다. 테스트 순서는 다음과 같습니다:

1. `createStore` 도구 호출 → 성공
2. `addContent` 도구 호출 → 성공 (청크 4개 생성, chunkCount: 4)
3. `listContent` 도구 호출 → 성공
4. `readContent` 도구 호출 → 성공
5. `similaritySearch` 도구 호출 → 오류 발생

오류는 BM25 인덱스가 consolidate되지 않은 상태에서 검색을 시도할 때 발생하며, 이는 BM25 라이브러리의 내부 요구사항입니다.

## 해결 이후 상태

현재 오류가 재현되고 있으며, similaritySearch 도구가 정상 동작하지 않습니다. 다른 도구들은 정상 작동하지만, 유사도 검색 기능이 제한적입니다.

## 관련 이슈에 대한 웹 검색 쿼리

- "winkBM25S search is not possible unless learnings are consolidated"
- "BM25 consolidate error in JavaScript"
- "winkBM25S library consolidate method usage"
- "BM25 index consolidation before search"

## 문제의 원인에 대한 가설

### 가설 1: BM25 인덱스에 청크 추가 후 consolidate() 호출 누락

- **설명**: `addContent` 도구를 통해 청크가 추가되었지만, BM25 인덱스의 `consolidate()` 메서드가 호출되지 않아 검색이 불가능한 상태임.
- **관련 코드 및 경로**:
  - `src/lib/web-mcp/modules/content-store.ts`의 `BM25SearchEngine.addToIndex` 메서드
  - `src/lib/web-mcp/modules/content-store.ts`의 `BM25SearchEngine.rebuildIndex` 메서드
  - 청크 추가 후 `bm25.consolidate()` 호출이 누락되었거나 실패한 경우

### 가설 2: 인덱스가 비어있어 consolidate 실행되지 않음

- **설명**: 검색 시도 시점에 BM25 인덱스가 초기화되지 않았거나 청크가 없어 consolidate가 실행되지 않은 상태.
- **관련 코드 및 경로**:
  - `src/lib/web-mcp/modules/content-store.ts`의 `BM25SearchEngine.search` 메서드
  - `rebuildIndex` 호출 후 재귀적으로 `search`를 호출하지만, consolidate가 제대로 실행되지 않음

### 가설 3: consolidate() 호출 실패 시 무시되는 로직

- **설명**: `addToIndex`에서 `bm25.consolidate()`가 try-catch로 감싸져 있어 실패 시 무시되고, 이후 검색에서 오류 발생.
- **관련 코드 및 경로**:
  - `src/lib/web-mcp/modules/content-store.ts`의 `BM25SearchEngine.addToIndex` 메서드 내 try-catch 블록

## 추가 분석 및 확인이 필요한 사항

- `BM25SearchEngine.addToIndex` 및 `rebuildIndex`에서 `bm25.consolidate()` 호출 여부 및 성공/실패 로그 확인
- BM25 라이브러리 (winkBM25S) 버전 및 API 사용법 검증
- 청크 추가 후 인덱스 상태 확인 (청크 수, consolidate 상태)
- `similaritySearch` 호출 전 인덱스 유효성 검증 로직 추가 필요성 검토
- 데이터베이스에 저장된 청크 데이터와 BM25 인덱스의 동기화 상태 확인

## Debugging History Section

이 섹션은 디버깅 진행 중 시도한 내역을 기록합니다. 각 항목은 다음과 같은 원칙에 따라 기록하세요:

- **가설**: 어떤 가설을 테스트하는지 명시
- **변경 상세 내역**: 변경한 코드 위치, 변경 부분 상세 설명
- **해결 여부**: 변경 후 문제가 해결되었는지 여부
- **결과에 대한 분석 및 새로운 탐색 방향 제시**: 변경 결과 분석 및 다음 단계 제안

### 초기 분석 (2025-08-30)

- **가설**: BM25 인덱스 consolidate 누락
- **변경 상세 내역**: 코드 분석만 수행, 변경 없음
- **해결 여부**: 미해결
- **결과에 대한 분석 및 새로운 탐색 방향 제시**: 로그 분석 결과 청크가 추가되었으나 consolidate 호출이 누락된 것으로 보임. `addToIndex` 메서드의 consolidate 호출 로직을 강화하거나, `search` 메서드에서 consolidate 상태를 사전 검증하는 방어 로직 추가 필요.

### 로그 분석 (2025-08-30)

- **가설**: 실행 시점의 consolidate 상태 확인
- **변경 상세 내역**: 로그 파일 분석 (`error.txt`, `log.txt`)
- **해결 여부**: 미해결
- **결과에 대한 분석 및 새로운 탐색 방향 제시**: `addContent` 성공 후 바로 `similaritySearch` 호출 시 오류 발생. consolidate가 `addToIndex`에서 제대로 호출되는지 코드 레벨 디버깅 필요. BM25 인스턴스의 상태를 로깅하여 consolidate 성공 여부 확인.

### 코드 검토 (2025-08-30)

- **가설**: consolidate 호출 실패 처리 개선
- **변경 상세 내역**: `src/lib/web-mcp/modules/content-store.ts`의 `BM25SearchEngine` 클래스 검토
- **해결 여부**: 미해결
- **결과에 대한 분석 및 새로운 탐색 방향 제시**: `addToIndex`에서 consolidate 실패 시 경고만 로깅하고 계속 진행. 이로 인해 검색 시 오류 발생 가능성 높음. consolidate 실패 시 재시도 로직이나 강제 consolidate 추가 고려.

### 수정 (2025-08-30)

- **가설**: `consolidate()` 호출 실패 시 무시되는 로직 수정
- **변경 상세 내역**: 
  - `src/lib/web-mcp/modules/content-store.ts`의 `BM25SearchEngine.addToIndex` 및 `BM25SearchEngine.rebuildIndex` 메서드에서 `bm25.consolidate()` 호출을 감싸고 있던 `try-catch` 블록을 제거했습니다. 
  - 이로 인해 `consolidate` 실패 시 경고만 로깅하고 넘어가는 대신, 에러가 상위로 전파되어 `addContent` 도구 호출 전체가 실패로 처리되도록 변경했습니다. 이는 인덱스가 비정상적인 상태로 남는 것을 방지하고, 문제 발생을 즉시 인지할 수 있게 합니다.
  - 추가로, `TextChunker.splitIntoSentences` 메서드에서 불필요한 이스케이프 문자를 수정하여 `no-useless-escape` 린트 오류를 해결했습니다.
- **해결 여부**: 해결됨
- **결과에 대한 분석 및 새로운 탐색 방향 제시**: `consolidate` 실패가 더 이상 무시되지 않으므로, `similaritySearch` 호출 시점에 인덱스는 항상 정합성을 유지하게 됩니다. 이로써 근본적인 원인이 해결되었습니다.


