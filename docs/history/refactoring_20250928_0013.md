# Refactoring Plan: 디렉터리 펼침 기능 수정

## 작업의 목적

WorkspaceFilesPanel에서 디렉터리 클릭 시 하위 파일 목록을 로드하는 대신 파일 다운로드가 시도되는 문제를 해결하여, 올바른 디렉터리 펼침 기능을 구현한다.

## 현재의 상태 / 문제점

### 증상

- 디렉터리를 클릭하면 `download_workspace_file` API가 호출되어 "Failed to read file: Is a directory (os error 21)" 에러 발생
- 디렉터리 펼침 기능이 정상 작동하지 않음

### 로그 분석

```
[WorkspaceFilesPanel] Downloading file {"path":"my_directory"}
[RustBackendClient] invoke failed {"cmd":"download_workspace_file","err":"Failed to read file: Is a directory (os error 21)"}
```

### 근본 원인

- `renderNode`의 `onClick` 이벤트에서 디렉터리/파일 구분 로직이 불완전
- `node.isDirectory` 값이 제대로 설정되지 않거나, 분기 조건이 충분하지 않음
- 결과적으로 디렉터리 클릭 시 `handleDownloadFile`이 호출됨

## 관련 코드의 구조 및 동작 방식 Summary (Birdeye View)

### 주요 컴포넌트

- `WorkspaceFilesPanel.tsx`: 파일 트리 UI 컴포넌트
- `rust-backend-client.ts`: Tauri 백엔드 API 클라이언트

### 동작 흐름

1. 컴포넌트 마운트 → `loadDirectory('./')` → 루트 파일 목록 로드
2. 디렉터리 클릭 → `renderNode.onClick` → 분기 처리
   - 디렉터리: `toggleDirectory()` → `loadDirectory()` → 하위 목록 로드
   - 파일: `handleDownloadFile()` → 파일 다운로드
3. 트리 업데이트 → `updateNodeChildren()` → UI 리렌더링

### 문제 지점

- `renderNode.onClick`의 분기 조건이 `node.isDirectory`만 체크
- `node.isDirectory` 값이 부정확할 경우 잘못된 함수 호출

## 변경 이후의 상태 / 해결 판정 기준

### 해결 상태

- 디렉터리 클릭 시 `listWorkspaceFiles` API만 호출
- 파일 클릭 시 `downloadWorkspaceFile` API만 호출
- 에러 로그 없음: "Failed to read file: Is a directory" 제거
- 디렉터리 펼침/접기 기능 정상 작동

### 판정 기준

- [ ] 디렉터리 클릭 시 다운로드 에러 로그 발생하지 않음
- [ ] 디렉터리 클릭 시 하위 파일 목록 표시됨
- [ ] 파일 클릭 시 다운로드 기능 정상 작동
- [ ] `pnpm refactor:validate` 통과

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 대상 파일

- `src/features/chat/components/WorkspaceFilesPanel.tsx`

### 주요 수정 사항

#### 1. renderNode의 클릭 이벤트 분기 강화

```typescript
// 현재
onClick={() => {
  if (node.isDirectory) {
    toggleDirectory(node);
  } else {
    handleDownloadFile(node);
  }
}}

// 수정 후
onClick={() => {
  // 다중 조건으로 디렉터리 판별
  const isDir = node.isDirectory || node.children !== undefined || node.path.endsWith('/');
  if (isDir) {
    toggleDirectory(node);
  } else {
    handleDownloadFile(node);
  }
}}
```

#### 2. handleDownloadFile의 디렉터리 체크 강화

```typescript
// 현재
if (node.isDirectory) return;

// 수정 후
if (
  node.isDirectory ||
  node.path.endsWith('/') ||
  node.children !== undefined
) {
  logger.warn('Attempted to download a directory, ignoring', {
    path: node.path,
    isDirectory: node.isDirectory,
    hasChildren: node.children !== undefined,
  });
  return;
}
```

## 재사용 가능한 연관 코드 (파일 경로, 주요 기능, 인터페이스 등 포함)

### 관련 파일

- `src/lib/rust-backend-client.ts`: `listWorkspaceFiles`, `downloadWorkspaceFile` API
- `src/hooks/use-rust-backend.ts`: 백엔드 훅 인터페이스

### 주요 인터페이스

```typescript
interface FileNode {
  id: string;
  name: string;
  path: string;
  isDirectory: boolean;
  children?: FileNode[];
  isExpanded?: boolean;
  isLoading?: boolean;
  parent?: string;
}

interface WorkspaceFileItem {
  name: string;
  isDirectory: boolean;
  path: string;
  size?: number | null;
  modified?: string | null;
}
```

### 주요 함수

- `loadDirectory()`: 디렉터리 내용 로드
- `toggleDirectory()`: 디렉터리 확장/축소 토글
- `updateNodeChildren()`: 트리 노드 업데이트
- `renderNode()`: 트리 노드 렌더링

## Test Code 추가 및 수정 필요 부분에 대한 가이드 포함

### 단위 테스트 추가 권장사항

```typescript
// src/test/components/WorkspaceFilesPanel.test.tsx
describe('WorkspaceFilesPanel', () => {
  it('should call toggleDirectory when directory is clicked', () => {
    // 디렉터리 노드 클릭 시 toggleDirectory 호출 검증
  });

  it('should call handleDownloadFile when file is clicked', () => {
    // 파일 노드 클릭 시 handleDownloadFile 호출 검증
  });

  it('should not call downloadWorkspaceFile for directories', () => {
    // 디렉터리에 대한 다운로드 시도 방지 검증
  });
});
```

### 통합 테스트

- 디렉터리 클릭 → 하위 파일 표시 확인
- 파일 클릭 → 다운로드 API 호출 확인
- 에러 상황에서의 적절한 처리 확인

### 수동 테스트 가이드

1. 애플리케이션 실행 (`pnpm tauri dev`)
2. WorkspaceFilesPanel에서 디렉터리 클릭
3. 하위 파일 목록이 표시되는지 확인
4. 파일 클릭 시 다운로드가 시작되는지 확인
5. 브라우저 개발자 도구에서 에러 로그 없음 확인

## 추가 분석 과제

### 1. node.isDirectory 값 정확성 검증

- Rust 백엔드의 `list_workspace_files`에서 `isDirectory` 필드가 정확히 설정되는지 확인
- 필요시 백엔드 로깅 추가

### 2. 경로 처리 일관성

- 상대 경로 vs 절대 경로 처리 방식 통일
- `loadDirectory`의 경로 정규화 로직 검토

### 3. 성능 최적화

- 대용량 디렉터리의 렌더링 성능 모니터링
- 필요시 가상화 또는 페이징 고려
