# Refactoring Plan: 파일 첨부 UI 다수 파일 표시 및 상태 관리 개선

## 작업의 목적

파일 첨부 UI의 다수 파일 표시 및 메시지 전송 후 상태 초기화 문제를 해결하여,  
사용자가 여러 파일을 첨부하고 메시지를 전송할 때 UI가 정확하고 일관되게 동작하도록 개선한다.

## 현재의 상태 / 문제점

### 주요 문제점

1. **다수 파일 첨부 시 UI 표시 실패**: 여러 파일을 첨부해도 UI(첨부 리스트, 파일함)에 1개만 표시됨
2. **메시지 전송 후 상태 초기화 실패**: submit 후에도 첨부 대기 상태가 남거나 UI가 정상적으로 초기화되지 않음
3. **Race Condition**: 여러 파일 첨부 시 각 `addFile`의 `refreshSessionFiles()`가 서버 응답을 덮어씀
4. **clearFiles 동작 불완전**: submit 후 첨부 파일이 UI에서 완전히 사라지지 않음

### 기술적 원인

- **비동기 갱신 충돌**: 여러 파일 첨부 시 마지막 응답만 반영되어 일부 파일이 표시되지 않음
- **상태 관리 불일치**: 첨부 대기 파일과 저장된 파일이 동일한 state로 관리되어 UI 불일치 발생
- **서버 동기화 지연**: `listContent` 응답이 첨부 직후 모든 파일을 반환하지 않음

## 추가 분석 과제

### 선택적 분석 항목

1. **서버 응답 타이밍 분석**: `addContent` → `listContent` 사이의 지연 시간 측정
2. **UI 컴포넌트 상태 의존성 검토**: `ChatAttachedFiles`와 `SessionFilesPopover`의 렌더링 조건 분석
3. **메모리 누수 확인**: 다수 파일 첨부 시 blob URL 정리 여부 검증

## 변경 이후의 상태 / 해결 판정 기준

### 해결 판정 기준

1. **다수 파일 첨부 성공**: 3개 이상 파일 첨부 시 UI에 모두 정확히 표시됨
2. **메시지 전송 후 초기화**: submit 후 첨부 리스트가 완전히 비워지고 파일함에 파일이 유지됨
3. **Race Condition 제거**: 여러 파일 첨부 시도 시 모두 성공적으로 처리됨
4. **UI 일관성**: 첨부 리스트와 파일함의 표시 개수가 항상 일치함

### 변경 이후 상태

- **첨부 대기 파일**: `pendingFiles` state로 별도 관리
- **저장된 파일**: `sessionFiles`로 서버 동기화 유지
- **멀티 첨부 동기화**: 모든 첨부 완료 후 한 번만 `refreshSessionFiles()` 호출
- **submit 후 초기화**: `pendingFiles` 클리어, `sessionFiles` 유지

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. ResourceAttachmentContext.tsx - 상태 관리 분리 및 동기화 개선

#### 현재 코드 (문제점)

```tsx
// sessionFiles 하나로 첨부 대기와 저장 파일 모두 관리
const [sessionFiles, setSessionFiles] = useState<AttachmentReference[]>([]);

// addFile에서 매번 refreshSessionFiles 호출
await refreshSessionFiles(); // 여러 파일 시 race condition 발생
```

#### 개선 방향

```tsx
// 첨부 대기 파일과 저장 파일 분리 관리
const [pendingFiles, setPendingFiles] = useState<AttachmentReference[]>([]);
const [sessionFiles, setSessionFiles] = useState<AttachmentReference[]>([]);

// 멀티 첨부 시 배치 처리
const addFilesBatch = useCallback(
  async (files: File[]) => {
    // 모든 파일 첨부 완료 후 한 번만 refreshSessionFiles 호출
    await Promise.all(files.map((file) => addFile(file)));
    await refreshSessionFiles();
  },
  [addFile, refreshSessionFiles],
);
```

### 2. Chat.tsx - UI 컴포넌트 상태 분리

#### 현재 코드 (문제점)

```tsx
// ChatAttachedFiles: sessionFiles만 참조
const { files: attachedFiles } = useResourceAttachment();

// submit 후 clearFiles 호출
clearFiles(); // sessionFiles 초기화 불완전
```

#### 개선 방향

```tsx
// ChatAttachedFiles: pendingFiles 참조 (첨부 대기 중인 파일들)
const { pendingFiles } = useResourceAttachment();

// submit 후 pendingFiles만 클리어
clearPendingFiles(); // 첨부 대기 상태만 초기화
```

### 3. 파일 첨부 플로우 개선

#### 개선된 플로우

1. **첨부 시작**: 파일을 `pendingFiles`에 추가 (즉시 UI 반영)
2. **서버 저장**: 각 파일을 서버에 저장
3. **배치 갱신**: 모든 저장 완료 후 `sessionFiles` 한 번 갱신
4. **UI 동기화**: `pendingFiles` 클리어, `sessionFiles`로 최종 상태 표시

### 4. 주요 수정 파일 목록

- `src/context/ResourceAttachmentContext.tsx`: 상태 관리 분리, 배치 처리 로직
- `src/features/chat/Chat.tsx`: UI 컴포넌트 상태 참조 변경
- `src/features/chat/ChatInput.tsx`: 파일 첨부 핸들러 개선

## 구현 우선순위

1. **Phase 1**: 상태 관리 분리 (`pendingFiles` vs `sessionFiles`)
2. **Phase 2**: 멀티 첨부 배치 처리 로직 구현
3. **Phase 3**: UI 컴포넌트 상태 참조 변경
4. **Phase 4**: submit 후 초기화 로직 개선
5. **Phase 5**: 테스트 및 검증
