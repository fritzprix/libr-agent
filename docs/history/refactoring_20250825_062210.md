# BuiltIn Tool Provider / BrowserToolProvider refactor

Checklist

- [ ] Browser tools register with `features/tools` BuiltInToolProvider (`register`/`unregister`) instead of `context/BuiltInToolContext`
- [ ] Remove overlapping integration in `src/context/BuiltInToolContext.tsx` (or mark deprecated)
- [ ] Ensure name parsing is robust (split on first `__` only)
- [ ] Add unit tests for name parsing, routing, and browser tool scripts
- [ ] Lint, typecheck, and run a smoke build

Purpose
Improve separation of responsibilities by making `features/tools` the canonical BuiltIn tool registry. Move Browser tool registration from the legacy `BuiltInToolContext` to the `BuiltInToolProvider` API so providers register as services (serviceId + BuiltInService) and the single `features/tools` provider handles routing, naming and lifecycle.

# BuiltIn Tool Provider / BrowserToolProvider refactor

## Checklist

- [ ] Browser tools register with `features/tools` BuiltInToolProvider (`register`/`unregister`) instead of `context/BuiltInToolContext`
- [ ] Remove overlapping integration in `src/context/BuiltInToolContext.tsx` (or mark deprecated)
- [ ] Ensure name parsing is robust (split on first `__` only)
- [ ] Add unit tests for name parsing, routing, and browser tool scripts
- [ ] Lint, typecheck, and run a smoke build

## Purpose

Improve separation of responsibilities by making `features/tools` the canonical BuiltIn tool registry. Move Browser tool registration from the legacy `BuiltInToolContext` to the `BuiltInToolProvider` API so providers register as services (serviceId + BuiltInService) and the single `features/tools` provider handles routing, naming and lifecycle.

## Current state / problems

- `src/context/BuiltInToolContext.tsx` and `src/features/tools/index.tsx` both provide built-in tooling features and overlapping APIs, causing duplication and confusion.
- `BrowserToolProvider` currently calls `registerLocalTools` on the context; this couples browser tool registration to the old context.
- Tool name parsing uses `split('__')` in places which breaks for tool names containing `__` and is brittle.
- Script argument injection in browser tools uses naive string interpolation (risk of broken scripts or injection edge-cases).

## After-state / success criteria

- `BrowserToolProvider` registers a single `BuiltInService` with `features/tools` BuiltInToolProvider using `register(serviceId, service)` and calls `unregister` on cleanup.
- `BuiltInToolProvider` (features/tools) remains the single source of truth for available builtin tools and for routing `builtin.` names to the correct service.
- Tool name parsing uses the first `__` as the separator (serverId = before first `__`, toolName = remainder) and has unit tests covering edge cases containing multiple `__` segments.
<!-- UI components that surface tools will be reviewed in a follow-up; not part of this change set -->
- All changes pass lint/typecheck and available unit tests; new unit tests added for parsing/routing and for browser tool execution edge-cases.

## Files to change (high level)

- `src/features/tools/BrowserToolProvider.tsx`
  - Replace `registerLocalTools` usage with `useBuiltInTool().register`/`.unregister`.
  - Expose a `BuiltInService` whose `listTools` returns tool metadata and whose `executeTool` delegates to the local tool implementations.
  - Harden execution argument parsing and return an `MCPResponse` shape.

- `src/features/tools/index.tsx` (BuiltInToolProvider)
  - Ensure execute routing splits the `builtin.` name safely (first `__` only). Example change:

```tsx
// Before: const [serviceId, toolName] = strippedToolName.split('__');
const idx = strippedToolName.indexOf('__');
if (idx === -1) throw new Error('Invalid builtin tool identifier');
const serviceId = strippedToolName.slice(0, idx);
const toolName = strippedToolName.slice(idx + 2);
```

- `src/features/tools/RustMCPToolProvider.tsx`
- `src/features/tools/WebMCPToolProvider.tsx`
  - Register/unregister a service via `register(serviceId, service)` instead of depending on the old context. Ensure the `listTools` names match the short tool names expected by `BuiltInToolProvider` (the provider will add `builtin.${serviceId}__${toolName}`).

- `src/context/BuiltInToolContext.tsx`
  - Mark deprecated or remove duplicated registration responsibilities. If removal is not possible immediately, simplify to a thin adapter that forwards to `features/tools` provider.

## Code snippets (suggested edits)

- Safe name-splitting in `features/tools/index.tsx` executeTool:

```tsx
let strippedToolName = toolcall.function.name.startsWith(BUILTIN_PREFIX)
  ? toolcall.function.name.replace(BUILTIN_PREFIX, '')
  : toolcall.function.name;

const idx = strippedToolName.indexOf('__');
if (idx === -1)
  throw new Error(`Invalid builtin tool name: ${strippedToolName}`);
const serviceId = strippedToolName.slice(0, idx);
const toolName = strippedToolName.slice(idx + 2);
```

- Browser service registration (high level) in `BrowserToolProvider`:

```tsx
const serviceId = 'browser';
const service: BuiltInService = {
  listTools: () => browserTools.map(({ execute, ...meta }) => meta),
  executeTool: async (toolCall) => {
    /* find tool by name, parse args, call execute */
  },
};
register(serviceId, service);
// cleanup: unregister(serviceId)
```

## Tests to add

- Unit: name parsing edge cases: `builtin.filesystem__list_directory`, `builtin.filesystem__name__with__underscores`.
- Unit: Browser tool `elementExists` when `executeScript` returns boolean, JSON string, or plain string.
- Integration: register a fake service and call `BuiltInToolProvider.executeTool` to confirm routing and id injection.

## Migration steps

1. Implement `BrowserToolProvider` change to register with `features/tools` and add tests for routing.
3. Update `RustMCPToolProvider` and `WebMCPToolProvider` to register services using `register(serviceId, service)`.
4. Add name parsing fix in `features/tools/index.tsx` and add unit tests.
5. Remove or adapt `src/context/BuiltInToolContext.tsx` responsibilities; optionally add an adapter until full migration is complete.
6. Run lint, typecheck, tests, and smoke build. Iterate on any issues.

## Rollout and verification

- Create a small feature branch and run `pnpm lint`, `pnpm build`, and `pnpm test`.
- After verification, open PR with description and link to `docs/history` note.

## Docs/history entry (required by guide)

- Create `docs/history/refactoring_20250824_1520.md` (or similar timestamp) with a short summary and links to PR/commits.

## Expected risks and mitigations

- Risk: name collisions between legacy and new provider during migration. Mitigation: adapter layer that forwards legacy registerLocalTools calls into features/tools registry and logs conflicts.
- Risk: minor UI breakage where some components still call `useBuiltInTools`. Mitigation: search/replace usages and add temporary adapter that re-exports the new hook from the old module path.

## Timeline (estimates)

- Implement safe name parsing & tests: 2–3 hours
- BrowserToolProvider register/unregister change + tests: 2–3 hours
- Update Rust/Web MCP providers: 3–4 hours
- Full migration, testing, and cleanup: 1 day

---

Please tell me if you want me to apply the BrowserToolProvider patch and the name-splitting fix now; I can implement the code changes and run quick type/lint checks.
