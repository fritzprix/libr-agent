# MCP 응답 구조 표준화 및 AI Agent 상황 인지 개선 Refactoring Plan

## 작업의 목적

**혼재된 MCP 응답 패턴을 표준화**하고, **모든 UIResource 응답에 AI Agent가 상황을 인지할 수 있는 텍스트를 포함**하여 MCP 표준 완전 준수 및 일관된 사용자 경험을 제공한다.

### 핵심 목표

- **MCP 표준 완전 준수**: 모든 응답에서 `content` 배열 구조 활용하여 텍스트와 리소스 함께 제공
- **AI Agent 상황 인지 개선**: export 도구들이 "파일이 성공적으로 export되었습니다" 등의 텍스트 메시지 포함
- **응답 패턴 통일**: 일반 도구와 export 도구 간의 응답 구조 일관성 확보
- **향상된 사용자 경험**: AI Agent가 작업 결과를 정확히 인지하고 사용자에게 전달할 수 있도록 보장

## 현재의 상태 / 문제점

### 1. 혼재된 응답 패턴

**WorkspaceServer**에서 두 가지 서로 다른 응답 패턴을 사용:

#### 일반 도구들 (올바른 패턴) ✅

```rust
fn success_response(request_id: Value, message: &str) -> MCPResponse {
    MCPResponse::success(
        request_id,
        json!({
            "content": [{
                "type": "text",
                "text": message
            }]
        }),
    )
}
```

**사용 도구**: `read_file`, `write_file`, `grep`, `search_files` 등

#### Export 도구들 (문제 있는 패턴) ❌

```rust
fn success_response_with_content(request_id: Value, content: Value) -> MCPResponse {
    MCPResponse::success(
        request_id,
        json!({
            "content": [content]  // UIResource만 단독 반환
        }),
    )
}
```

**사용 도구**: `export_file`, `export_zip`

### 2. AI Agent 상황 인지 불가

**현재 export 도구 응답 구조**:

```json
{
  "content": [
    {
      "type": "resource",
      "resource": { "mimeType": "text/html", "text": "..." }
    }
  ]
}
```

**문제점**:

- AI Agent가 export 성공 여부를 텍스트로 인지할 수 없음
- 사용자가 AI에게 "파일을 export했나요?"라고 물어봐도 정확한 답변 불가
- UIResource만 렌더링되고 작업 완료 상황에 대한 맥락 정보 부족

### 3. 사용자 경험 불일치

- **파일 읽기**: AI가 "파일을 성공적으로 읽었습니다. 내용은 다음과 같습니다:" 등으로 상황 설명 가능
- **export 작업**: AI가 상황을 인지하지 못해 단순히 UIResource만 표시

### 4. MCP 표준 미완전 준수

**MCP 표준 권장사항**: `content` 배열에 여러 타입의 콘텐츠를 함께 포함하여 풍부한 응답 제공
**현재 구현**: export 도구들이 단일 타입 콘텐츠만 반환하여 표준 활용도 저하

## 추가 분석 과제

### 1. 다른 BuiltIn MCP 서버들의 응답 패턴 확인

- **FilesystemServer**: 파일 시스템 관련 도구들의 응답 구조 점검
- **SandboxServer**: 코드 실행 결과 응답에서 텍스트 + 결과 조합 방식 확인
- **기타 서버들**: 일관된 응답 패턴 적용 여부 검토

### 2. 프론트엔드 UIResourceRenderer 호환성

- **MCPContent 배열 처리**: 텍스트와 리소스가 함께 온 경우의 렌더링 방식
- **순서 의존성**: 텍스트가 리소스보다 먼저 표시되어야 하는지 확인
- **기존 UIResource 단독 응답과의 하위 호환성** 보장

### 3. AI Service 통합 영향도

- **ChatContext**: 응답 구조 변경이 대화 흐름에 미치는 영향
- **메시지 렌더링**: MessageRenderer에서 텍스트 + 리소스 조합 처리 방식
- **응답 파싱**: 기존 응답 파싱 로직의 수정 필요 여부

### 4. 다국어 지원 고려사항

- **메시지 다국화**: 상황 인지 텍스트의 국제화 처리 방안
- **동적 메시지 생성**: 파일명, 경로 등이 포함된 동적 메시지의 다국어 처리
- **일관성 유지**: 모든 언어에서 동일한 수준의 상황 인지 정보 제공

## 변경 이후의 상태 / 해결 판정 기준

### 1. 표준화된 응답 구조

- **통합된 응답 함수**: 텍스트와 리소스를 함께 반환하는 단일 함수 사용
- **일관된 패턴**: 모든 도구가 동일한 응답 구조 패턴 적용
- **MCP 표준 완전 준수**: `content` 배열에 여러 타입 콘텐츠 포함

### 2. 향상된 AI Agent 상황 인지

- **명시적 상황 설명**: 모든 export 작업에 대한 성공/실패 텍스트 메시지 포함
- **맥락 정보 제공**: 파일명, 경로, 작업 유형 등의 구체적 정보 포함
- **사용자 질의 대응**: AI가 "파일을 export했나요?" 등의 질문에 정확히 답변 가능

### 3. 일관된 사용자 경험

```json
{
  "content": [
    {
      "type": "text",
      "text": "파일 'document.pdf'가 성공적으로 export되었습니다. 아래 링크에서 다운로드할 수 있습니다."
    },
    {
      "type": "resource",
      "resource": { "mimeType": "text/html", "text": "..." }
    }
  ]
}
```

### 4. 판정 기준

- [ ] 모든 export 도구가 텍스트 + UIResource 조합으로 응답
- [ ] AI Agent가 export 작업 완료 상황을 정확히 인지
- [ ] 응답 구조가 MCP 표준을 완전히 준수
- [ ] 기존 일반 도구들의 기능에 영향 없음
- [ ] 프론트엔드에서 텍스트와 리소스가 모두 정상 렌더링
- [ ] 하위 호환성 유지로 기존 기능에 regression 없음
- [ ] 일관된 응답 패턴으로 개발자 경험 향상

## 수정이 필요한 코드 및 수정부분

### 1. 통합된 응답 함수 추가

**파일**: `src-tauri/src/mcp/builtin/workspace.rs`

**추가할 새로운 함수**:

```rust
/// Create a success response with both text description and UIResource content
fn success_response_with_text_and_resource(
    request_id: Value,
    message: &str,
    ui_resource: Value,
) -> MCPResponse {
    MCPResponse::success(
        request_id,
        json!({
            "content": [
                {
                    "type": "text",
                    "text": message
                },
                ui_resource
            ]
        }),
    )
}
```

### 2. export_file 도구 응답 수정

**파일**: `src-tauri/src/mcp/builtin/workspace.rs` (1740-1750라인)

**현재 코드**:

```rust
        let ui_resource = self.create_export_ui_resource(
            request_id_num,
            &format!("File Export: {}", display_name),
            &[source_path_str.to_string()],
            "Single File",
            &relative_path,
            html_content,
        );

        Self::success_response_with_content(request_id, ui_resource)
```

**수정 방향**:

```rust
        let ui_resource = self.create_export_ui_resource(
            request_id_num,
            &format!("File Export: {}", display_name),
            &[source_path_str.to_string()],
            "Single File",
            &relative_path,
            html_content,
        );

        let success_message = format!(
            "파일 '{}'이(가) 성공적으로 export되었습니다. 아래 링크에서 다운로드할 수 있습니다.",
            display_name
        );

        Self::success_response_with_text_and_resource(request_id, &success_message, ui_resource)
```

### 3. export_zip 도구 응답 수정

**파일**: `src-tauri/src/mcp/builtin/workspace.rs` (1880-1890라인)

**현재 코드**:

```rust
        let ui_resource = self.create_export_ui_resource(
            request_id_num,
            &format!("ZIP Package: {}", package_name),
            &files,
            "ZIP Package",
            &relative_path,
            html_content,
        );

        Self::success_response_with_content(request_id, ui_resource)
```

**수정 방향**:

```rust
        let ui_resource = self.create_export_ui_resource(
            request_id_num,
            &format!("ZIP Package: {}", package_name),
            &files,
            "ZIP Package",
            &relative_path,
            html_content,
        );

        let success_message = format!(
            "ZIP 패키지 '{}'이(가) 성공적으로 생성되었습니다. {}개 파일이 포함되어 있으며, 아래 링크에서 다운로드할 수 있습니다.",
            package_name,
            files.len()
        );

        Self::success_response_with_text_and_resource(request_id, &success_message, ui_resource)
```

### 4. 기존 함수 제거 또는 deprecated 처리

**파일**: `src-tauri/src/mcp/builtin/workspace.rs` (1426-1433라인)

**현재 함수**:

```rust
fn success_response_with_content(request_id: Value, content: Value) -> MCPResponse {
    MCPResponse::success(
        request_id,
        json!({
            "content": [content]
        }),
    )
}
```

**처리 방향**: 사용되지 않게 되면 제거하거나 deprecated 주석 추가

### 5. 오류 응답에도 일관성 적용 (선택적)

**파일**: `src-tauri/src/mcp/builtin/workspace.rs`

**고려사항**: 오류 응답에도 텍스트 형태로 일관된 메시지 제공

```rust
fn error_response_with_text(request_id: Value, code: i32, message: &str) -> MCPResponse {
    MCPResponse::error_with_content(
        request_id,
        code,
        json!({
            "content": [{
                "type": "text",
                "text": message
            }]
        })
    )
}
```

## 재사용 가능한 연관 코드

### 기존 활용 가능한 컴포넌트

**파일**: `src-tauri/src/mcp/builtin/workspace.rs`

- **기능**: MCP 응답 생성, UIResource 생성, 파일 시스템 작업
- **인터페이스**: `success_response()`, `create_export_ui_resource()`, `generate_request_id()`
- **재사용**: 기존 응답 생성 패턴과 UIResource 생성 로직 그대로 활용

**파일**: `src/lib/mcp-types.ts`

- **기능**: MCP 표준 타입 정의, 응답 구조 인터페이스
- **인터페이스**: `MCPContent[]`, `MCPTextContent`, `MCPResourceContent`
- **재사용**: 기존 타입 시스템 완전 활용, 추가 타입 정의 불필요

**파일**: `src/components/ui/UIResourceRenderer.tsx`

- **기능**: MCP 응답의 content 배열 렌더링
- **인터페이스**: `UIResourceRendererProps`, `MCPContent` 처리
- **재사용**: 현재 구조가 이미 content 배열 처리 지원

### 확장 필요한 인터페이스

**파일**: `src/components/MessageRenderer.tsx`

```tsx
// MCPContent 배열에서 텍스트와 리소스를 순차적으로 렌더링
const renderMCPContent = (content: MCPContent[]) => {
  return content.map((item, index) => {
    switch (item.type) {
      case 'text':
        return (
          <div key={index} className="mcp-text">
            {item.text}
          </div>
        );
      case 'resource':
        return <UIResourceRenderer key={index} resource={item.resource} />;
      default:
        return null;
    }
  });
};
```

**파일**: `src/context/ChatContext.tsx`

```tsx
// MCP 응답에서 텍스트 부분을 추출하여 대화 히스토리에 포함
const extractTextFromMCPResponse = (response: MCPResponse): string => {
  if (!response.result?.content) return '';

  return response.result.content
    .filter((item): item is MCPTextContent => item.type === 'text')
    .map((item) => item.text)
    .join('\n');
};
```

**파일**: `src-tauri/src/mcp/types.rs`

```rust
// Rust에서도 동일한 응답 패턴을 다른 서버들이 활용할 수 있도록 공통 유틸리티 제공
impl MCPResponse {
    pub fn success_with_text_and_resource(
        request_id: Value,
        text_message: &str,
        resource: Value,
    ) -> Self {
        // 공통 구현체
    }
}
```

### 테스트 및 검증 코드

**파일**: `src-tauri/src/mcp/builtin/workspace_test.rs` (신규 생성)

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_export_response_includes_text_and_resource() {
        // export 응답이 텍스트와 리소스를 모두 포함하는지 검증
    }

    #[test]
    fn test_response_mcp_standard_compliance() {
        // MCP 표준 준수 여부 검증
    }
}
```

이 계획을 통해 MCP 응답 구조를 완전히 표준화하고, AI Agent의 상황 인지 능력을 대폭 향상시킬 수 있습니다. 특히 export 작업의 결과를 AI가 정확히 이해하고 사용자에게 전달할 수 있게 되어 전체적인 사용자 경험이 크게 개선될 것입니다.
