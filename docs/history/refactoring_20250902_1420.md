# Anthropic 부분 JSON 스트리밍 처리 개선 리팩토링 계획

## 작업의 목적

Anthropic API의 도구 사용 시 발생하는 부분 JSON 스트리밍 파싱 오류와 빈 메시지로 인한 400 에러를 해결하여 안정적인 도구 호출 기능을 구현한다.

## 현재의 상태 / 문제점

### 1. 부분 JSON 파싱 오류

- Anthropic API의 `input_json_delta` 청크는 부분적인 JSON으로 스트리밍됨
- 현재 코드는 각 청크를 개별적으로 JSON 파싱 시도하여 실패
- 도구 호출이 제대로 처리되지 않음

### 2. 빈 메시지로 인한 400 에러

```text
"messages.1: all messages must have non-empty content except for the optional final assistant message"
```

- Assistant 메시지가 빈 `content`와 빈 `tool_calls`를 가진 채로 메시지 기록에 저장됨
- 후속 대화에서 이 빈 메시지가 Anthropic API로 전달되면서 400 에러 발생

### 3. 로그에서 확인된 문제 패턴

```json
[AnthropicService] Received chunk from Anthropic {"chunk":{"type":"content_block_delta","index":0,"delta":{"type":"input_json_delta","partial_json":"{\"query\":\"test"}}}
```

- 부분 JSON이 올바르게 누적되지 않고 개별 파싱 시도로 실패

## 추가 분석 과제

1. **Fine-grained tool streaming 베타 기능 활용 검토**
   - `fine-grained-tool-streaming-2025-05-14` 헤더 사용 여부 확인
   - 베타 기능의 안정성과 프로덕션 적용 가능성 평가

2. **도구 호출 완료 감지 로직 검증**
   - `content_block_stop` 이벤트 외에 다른 완료 신호 존재 여부
   - 스트림 중단 시나리오에서의 미완성 도구 호출 처리 방법

3. **메시지 필터링 정책 검토**
   - 빈 메시지를 완전히 제거할지, 플레이스홀더 메시지로 대체할지 결정
   - 대화 흐름에서 메시지 누락이 미치는 영향 분석

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. **도구 호출 정상 처리**: 부분 JSON이 완전히 누적되어 올바른 도구 호출 실행
2. **400 에러 제거**: 빈 메시지로 인한 API 에러 발생 하지 않음
3. **스트리밍 안정성**: 도구 호출 중 스트림 중단 시에도 적절한 에러 처리
4. **로그 품질 향상**: 도구 호출 처리 과정의 상세한 로깅으로 디버깅 용이성 확보

### 검증 방법

- 브라우저 도구 테스트 시나리오 실행하여 도구 호출 성공 확인
- 연속적인 대화에서 400 에러 미발생 확인
- 부분 JSON 누적 과정이 로그에 정확히 기록되는지 확인

## 수정이 필요한 코드 및 수정부분

### 1. `src/lib/ai-service/anthropic.ts`

**핵심 수정 영역:**

```typescript
// 추가: 도구 호출 누적 인터페이스
interface ToolCallAccumulator {
  id: string;
  name: string;
  partialJson: string;
  index: number;
}

// 수정: streamChat 메서드 내 청크 처리 로직
async *streamChat(...) {
  // 기존 코드...

  // 추가: 도구 호출 누적기 맵
  const toolCallAccumulators = new Map<number, ToolCallAccumulator>();

  for await (const chunk of completion) {
    // 수정: input_json_delta 처리 로직
    if (chunk.type === 'content_block_delta' && chunk.delta.type === 'input_json_delta') {
      // 부분 JSON 누적 및 완성 시 파싱 시도
    }

    // 추가: content_block_start에서 누적기 초기화
    // 추가: content_block_stop에서 최종 파싱 및 정리
  }
}

// 수정: convertToAnthropicMessages에서 빈 메시지 필터링
private convertToAnthropicMessages(messages: Message[]): AnthropicMessageParam[] {
  // 빈 content와 tool_calls를 가진 assistant 메시지 필터링 로직 추가
}
```

### 2. `src/hooks/use-ai-service.ts`

**핵심 수정 영역:**

```typescript
const submit = useCallback(async (...) => {
  // 기존 스트리밍 처리 코드...

  // 추가: 최종 메시지 검증 로직
  const hasContent = fullContent.trim().length > 0;
  const hasToolCalls = toolCalls.length > 0;

  if (!hasContent && !hasToolCalls) {
    // 빈 응답 처리 로직
    finalMessage = {
      // 플레이스홀더 메시지 또는 null 처리
    };
  }
}, []);
```

## 재사용 가능한 연관 코드

### 관련 파일 및 인터페이스

1. **`src/lib/ai-service/base-service.ts`**
   - `BaseAIService` 클래스: 공통 에러 처리 및 재시도 로직
   - `handleStreamingError` 메서드: 스트리밍 에러 처리 패턴

2. **`src/models/chat.ts`**
   - `Message` 인터페이스: 메시지 구조 정의
   - `ToolCall` 인터페이스: 도구 호출 구조 정의

3. **`src/lib/mcp-types.ts`**
   - `MCPTool` 인터페이스: 도구 정의 구조
   - `MCPResponse` 인터페이스: 도구 실행 결과 구조

4. **`src/lib/logger.ts`**
   - `getLogger` 함수: 컨텍스트별 로거 생성
   - 로깅 레벨 및 형식 정의

### 재사용 패턴

1. **JSON 파싱 안전성 패턴**

```typescript
try {
  const parsed = JSON.parse(jsonString);
  // 성공 처리
} catch (parseError) {
  // 부분 JSON 계속 누적 또는 에러 처리
}
```

2. **스트리밍 상태 관리 패턴**

```typescript
const accumulators = new Map<number, AccumulatorType>();
// 초기화, 업데이트, 정리 생명주기 관리
```

3. **메시지 필터링 패턴**

```typescript
const filteredMessages = messages.filter((msg) => {
  // 유효성 검사 로직
  return hasValidContent(msg);
});
```

이 리팩토링을 통해 Anthropic API의 스트리밍 도구 사용 기능이 안정적으로 작동하고, 사용자 경험이 크게 향상될 것으로 예상됩니다.
