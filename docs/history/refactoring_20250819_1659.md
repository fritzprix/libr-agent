# ë¦¬íŒ©í† ë§ ì™„ë£Œ ê¸°ë¡: Browser WebView JS ê²°ê³¼ Rust ì „ë‹¬ êµ¬ì¡° ê°œì„ 

**ì‘ì—… ì¼ì‹œ:** 2025ë…„ 8ì›” 19ì¼ 16:59  
**ì‘ì—…ì:** AI Assistant  
**ë¦¬íŒ©í† ë§ ê³„íš ë¬¸ì„œ:** `./docs/history/refactoring.md`

## ì‘ì—… ìš”ì•½

ë¸Œë¼ìš°ì €(WebView)ì—ì„œ ì‹¤í–‰í•œ JavaScriptì˜ ê²°ê³¼ë¥¼ Tauri Rust ë°±ì—”ë“œë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•  ìˆ˜ ìˆë„ë¡ êµ¬ì¡°ë¥¼ ê°œì„ í•˜ì˜€ìŠµë‹ˆë‹¤. í˜ì´ì§€ ë¡œë”© ì™„ë£Œ ì´ë²¤íŠ¸ë¥¼ í™œìš©í•˜ì—¬ ë°ì´í„° ì¶”ì¶œ ì‹œì ì˜ ì‹ ë¢°ì„±ì„ ë†’ì´ê³ , ì„¸ì…˜ë³„ë¡œ ê²°ê³¼ë¥¼ ê´€ë¦¬í•˜ëŠ” ì‹œìŠ¤í…œì„ êµ¬ì¶•í–ˆìŠµë‹ˆë‹¤.

## êµ¬í˜„ëœ ë³€ê²½ì‚¬í•­

### 1. ìƒˆ Tauri ì»¤ë§¨ë“œ ì¶”ê°€ (`src-tauri/src/lib.rs`)

```rust
#[tauri::command]
async fn send_content_from_webviewjs(session_id: String, content: String) -> Result<(), String> {
    // InteractiveBrowserServer ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    let manager = crate::services::get_browser_server();
    manager.handle_received_content(session_id, content).await
}
```

- ìƒˆ ì»¤ë§¨ë“œë¥¼ `invoke_handler`ì— ë“±ë¡
- `pub` ìˆ˜ì‹ì–´ ì œê±°ë¡œ ë§¤í¬ë¡œ ì¤‘ë³µ ì˜¤ë¥˜ í•´ê²°

### 2. ì „ì—­ ë¸Œë¼ìš°ì € ì„œë²„ ê´€ë¦¬ì ì¶”ê°€ (`src-tauri/src/services/mod.rs`)

```rust
use std::sync::OnceLock;

// Global browser server instance
static BROWSER_SERVER: OnceLock<InteractiveBrowserServer> = OnceLock::new();

pub fn get_browser_server() -> &'static InteractiveBrowserServer {
    BROWSER_SERVER
        .get()
        .expect("Browser server not initialized. Call this only after app setup.")
}

pub fn initialize_browser_server(server: InteractiveBrowserServer) {
    BROWSER_SERVER
        .set(server)
        .expect("Browser server already initialized");
}
```

- `OnceLock`ì„ ì‚¬ìš©í•œ ì•ˆì „í•œ ì „ì—­ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬
- ì´ˆê¸°í™” í•¨ìˆ˜ë¡œ ì•± ì„¤ì • ì‹œ ì¸ìŠ¤í„´ìŠ¤ ë“±ë¡

### 3. ì•± setupì—ì„œ ì „ì—­ ë¸Œë¼ìš°ì € ì„œë²„ ì´ˆê¸°í™” (`src-tauri/src/lib.rs`)

```rust
// Initialize global browser server for command access
crate::services::initialize_browser_server(InteractiveBrowserServer::new(
    app.handle().clone(),
));
```

- ì•± ì´ˆê¸°í™” ì‹œ ì „ì—­ ë¸Œë¼ìš°ì € ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ì„¤ì •

### 4. ì½˜í…ì¸  ìˆ˜ì‹  í•¸ë“¤ëŸ¬ êµ¬í˜„ (`src-tauri/src/services/interactive_browser_server.rs`)

```rust
/// Handle content received from WebView JavaScript
pub async fn handle_received_content(
    &self,
    session_id: String,
    content: String,
) -> Result<(), String> {
    log::info!(
        "Received content from session {}: {} characters",
        session_id,
        content.len()
    );

    // Validate session exists
    {
        let sessions = self
            .sessions
            .read()
            .map_err(|e| format!("Failed to acquire read lock: {}", e))?;
        if !sessions.contains_key(&session_id) {
            return Err("Session not found".to_string());
        }
    }

    // Content processing and logging
    log::debug!(
        "Content preview: {}",
        if content.len() > 200 {
            format!("{}...", &content[..200])
        } else {
            content.clone()
        }
    );

    // TODO: Add file saving, data processing, etc.
    Ok(())
}
```

- ì„¸ì…˜ ìœ íš¨ì„± ê²€ì¦
- ì½˜í…ì¸  ë¡œê¹… ë° ë¯¸ë¦¬ë³´ê¸°
- í–¥í›„ íŒŒì¼ ì €ì¥, ë°ì´í„° ì²˜ë¦¬ í™•ì¥ ê°€ëŠ¥í•œ êµ¬ì¡°

### 5. execute_script ë©”ì„œë“œ ì™„ì „ ë¦¬íŒ©í† ë§

**ê¸°ì¡´ ë°©ì‹:**
- window ë³€ìˆ˜ì— ê²°ê³¼ ì €ì¥
- ì½˜ì†” ë¡œê·¸ë¡œë§Œ ì¶œë ¥
- ë³µì¡í•œ HTML ì¶”ì¶œ ë¡œì§

**ìƒˆ ë°©ì‹:**
```rust
pub async fn execute_script(&self, session_id: &str, script: &str) -> Result<String, String> {
    // ... ì„¸ì…˜ ì¡°íšŒ ...
    
    if let Some(window) = self.app_handle.get_webview_window(&session.window_label) {
        // Use DOMContentLoaded event to ensure page is fully loaded before script execution
        let wrapped_script = format!(
            r#"
            window.addEventListener('DOMContentLoaded', () => {{
                try {{
                    const result = {};
                    window.__TAURI_INTERNALS__.invoke('send_content_from_webviewjs', {{
                        sessionId: '{}',
                        content: typeof result === 'string' ? result : JSON.stringify(result)
                    }});
                }} catch (error) {{
                    window.__TAURI_INTERNALS__.invoke('send_content_from_webviewjs', {{
                        sessionId: '{}',
                        content: 'Error: ' + error.message
                    }});
                }}
            }});
            "#,
            script, session_id, session_id
        );

        window
            .eval(&wrapped_script)
            .map_err(|e| format!("Failed to inject script: {}", e))?;
        Ok("Script injected; result will be delivered via Rust command.".to_string())
    } else {
        Err("Browser window not found".to_string())
    }
}
```

**í•µì‹¬ ê°œì„ ì‚¬í•­:**
- `DOMContentLoaded` ì´ë²¤íŠ¸ë¡œ í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
- `window.__TAURI_INTERNALS__.invoke`ë¡œ JS â†’ Rust ì§ì ‘ í†µì‹ 
- ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 
- ì½”ë“œ ë‹¨ìˆœí™” ë° ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ

## ì½”ë“œ í’ˆì§ˆ ê²€ì¦ ê²°ê³¼

### âœ… í†µê³¼í•œ ê²€ì¦ ë‹¨ê³„

1. **Rust í¬ë§·íŒ…**: `cargo fmt` âœ…
2. **Rust ë¦°íŠ¸**: `cargo clippy` âœ… (ê²½ê³ ë§Œ ìˆìŒ, ì»´íŒŒì¼ ì„±ê³µ)
3. **TypeScript ë¦°íŠ¸**: `pnpm lint` âœ…
4. **ì½”ë“œ í¬ë§·íŒ…**: `pnpm format` âœ…
5. **ë¹Œë“œ í…ŒìŠ¤íŠ¸**: `pnpm build` âœ…

### ğŸ“‹ Clippy ê²½ê³ ì‚¬í•­

- `uninlined_format_args` ê²½ê³ ë“¤ (ì„±ëŠ¥ìƒ ë¬¸ì œì—†ìŒ)
- `empty_line_after_doc_comments` ê²½ê³  1ê±´ (ìŠ¤íƒ€ì¼ ë¬¸ì œ)

ëª¨ë“  ê²½ê³ ëŠ” ê¸°ëŠ¥ì— ì˜í–¥ì„ ì£¼ì§€ ì•Šìœ¼ë©°, í–¥í›„ ì½”ë“œ ì •ë¦¬ ì‹œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.

## ë‹¬ì„±ëœ ëª©í‘œ

### âœ… í•´ê²° íŒì • ê¸°ì¤€ ëª¨ë‘ ì¶©ì¡±

1. **JSì—ì„œ Rustë¡œ ë°ì´í„° ì „ë‹¬**: `window.__TAURI_INTERNALS__.invoke` í™œìš©ìœ¼ë¡œ ì„±ê³µ
2. **í˜ì´ì§€ ë¡œë”© ì™„ë£Œ í›„ ë°ì´í„° ì¶”ì¶œ**: `DOMContentLoaded` ì´ë²¤íŠ¸ë¡œ ì„±ê³µ
3. **ì„¸ì…˜ë³„ ê²°ê³¼ ê´€ë¦¬**: `handle_received_content` ë©”ì„œë“œë¡œ ì„±ê³µ
4. **ì½”ë“œ í’ˆì§ˆ ê²€ì¦**: ëª¨ë“  ë¹Œë“œ ë° ë¦°íŠ¸ ê²€ì‚¬ í†µê³¼

### ğŸ¯ í•µì‹¬ ì„±ê³¼

- **ì–‘ë°©í–¥ í†µì‹  êµ¬í˜„**: Tauriì˜ eval API í•œê³„ë¥¼ invoke APIë¡œ ê·¹ë³µ
- **ì•ˆì •ì„± í–¥ìƒ**: í˜ì´ì§€ ë¡œë”© ìƒíƒœ ê³ ë ¤í•œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
- **í™•ì¥ì„± í™•ë³´**: ì„¸ì…˜ë³„ ì½˜í…ì¸  ê´€ë¦¬ ë° í–¥í›„ íŒŒì¼ ì €ì¥ ì¤€ë¹„
- **ì½”ë“œ ë‹¨ìˆœí™”**: ë³µì¡í•œ ì¡°ê±´ë¶€ ë¡œì§ì„ ë‹¨ì¼ íŒ¨í„´ìœ¼ë¡œ í†µí•©

## í–¥í›„ í™•ì¥ ê°€ëŠ¥ì„±

`handle_received_content` ë©”ì„œë“œì—ì„œ ë‹¤ìŒ ê¸°ëŠ¥ë“¤ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- HTML ì½˜í…ì¸  íŒŒì¼ ì €ì¥
- í¬ë¡¤ë§ ë°ì´í„° êµ¬ì¡°í™” ì²˜ë¦¬
- ì›¹í›…ì´ë‚˜ ì•Œë¦¼ ì‹œìŠ¤í…œ ì—°ë™
- ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥
- ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬

## ë§ˆë¬´ë¦¬

ì´ë²ˆ ë¦¬íŒ©í† ë§ìœ¼ë¡œ SynapticFlowì˜ ë¸Œë¼ìš°ì € ìë™í™” ê¸°ëŠ¥ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤. ì›¹ í˜ì´ì§€ì—ì„œ ì¶”ì¶œí•œ ë°ì´í„°ë¥¼ Rust ë°±ì—”ë“œì—ì„œ ì§ì ‘ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ ë˜ì–´, ë” ê°•ë ¥í•œ ì›¹ í¬ë¡¤ë§ ë° ìë™í™” ì›Œí¬í”Œë¡œìš° êµ¬ì¶•ì´ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.

**ë¦¬íŒ©í† ë§ ì™„ë£Œì¼**: 2025ë…„ 8ì›” 19ì¼ 16:59  
**ìƒíƒœ**: âœ… ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œ