# ExtractContentTool 개선 계획

## 작업의 목적

SynapticFlow의 브라우저 도구 중 ExtractContentTool의 출력 품질과 안정성을 개선하여, 웹 페이지 콘텐츠 추출 기능을 더욱 실용적이고 신뢰할 수 있도록 만든다.

## 현재의 상태 / 문제점

### 1. Turndown Markdown 출력 품질 문제

- **문제**: Turndown 라이브러리가 생성하는 Markdown에 불필요한 이중 줄바꿨(`\n\n\n`), 행 끝 공백, 행 시작 공백 등이 포함되어 가독성이 떨어짐
- **영향**: 추출된 Markdown 콘텐츠의 품질이 낮아 후처리 작업이나 사용자 경험에 부정적 영향

### 2. DOM Map 추출 실패 문제

- **문제**: `parseHTMLToDOMMap` 함수가 대부분의 웹 페이지에서 빈 배열(`[]`)을 반환
- **원인**:
  - `includeInteractiveOnly: true` 설정으로 인터랙티브 요소만 추출하려 하나, 일반 페이지에는 해당 요소가 부족
  - `maxDepth: 3` 제한으로 깊은 DOM 구조 탐색 불가
  - CSS selector 기반 요소 선택을 위한 전체 DOM 구조 부재
- **영향**: 브라우저 자동화 도구에서 요소 선택을 위한 DOM Map 정보를 얻을 수 없음

## 추가 분석 과제

### 선택적 분석 항목

1. **성능 영향 분석**: DOM Map 옵션 완화가 메모리 사용량과 처리 시간에 미치는 영향 측정
2. **다양한 웹사이트 테스트**: 개선 후 다양한 유형의 웹사이트(SPA, 정적 사이트, 복잡한 DOM 구조)에서의 동작 검증
3. **Interactive 요소 식별 로직**: 전체 DOM을 유지하면서도 interactive 요소를 효율적으로 식별하는 후처리 방법 검토

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. **Markdown 품질 개선**
   - 추출된 Markdown에서 3개 이상의 연속 줄바꿈 제거
   - 행 끝/시작 불필요한 공백 제거
   - 전체적으로 깔끔하고 읽기 쉬운 형식 유지

2. **DOM Map 정상 동작**
   - 일반적인 웹 페이지에서 빈 배열이 아닌 의미있는 DOM 구조 반환
   - CSS selector로 요소 선택이 가능한 완전한 DOM 경로 정보 제공
   - 최대 10 레벨 깊이까지 DOM 구조 탐색 가능

### 검증 방법

- 테스트 웹 페이지에서 ExtractContentTool 실행 후 결과 확인
- Markdown format과 dom-map format 모두에서 정상적인 출력 확인
- DOM Map에서 추출된 selector 정보로 실제 요소 선택 가능 여부 테스트

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. ExtractContentTool.ts - Markdown 정리 로직 추가

**파일 경로**: `src/features/tools/browser-tools/ExtractContentTool.ts`

**수정 전**:

```typescript
if (format === 'markdown') {
  const turndownService = new TurndownService({
    headingStyle: 'atx',
    codeBlockStyle: 'fenced',
    bulletListMarker: '-',
    emDelimiter: '*',
  });
  turndownService.addRule('removeScripts', {
    filter: ['script', 'style', 'noscript'],
    replacement: () => '',
  });
  turndownService.addRule('preserveLineBreaks', {
    filter: 'br',
    replacement: () => '\n',
  });

  const markdown = turndownService.turndown(rawHtml);
  result.content = markdown;
  result.format = 'markdown';
}
```

**수정 후**:

```typescript
if (format === 'markdown') {
  const turndownService = new TurndownService({
    headingStyle: 'atx',
    codeBlockStyle: 'fenced',
    bulletListMarker: '-',
    emDelimiter: '*',
  });
  turndownService.addRule('removeScripts', {
    filter: ['script', 'style', 'noscript'],
    replacement: () => '',
  });
  turndownService.addRule('preserveLineBreaks', {
    filter: 'br',
    replacement: () => '\n',
  });

  let markdown = turndownService.turndown(rawHtml);

  // Cleanup: Remove double line breaks and extra spaces
  markdown = markdown
    .replace(/\n{3,}/g, '\n\n') // Replace 3+ newlines with 2
    .replace(/[ \t]+\n/g, '\n') // Remove trailing spaces before newline
    .replace(/\n[ \t]+/g, '\n') // Remove leading spaces after newline
    .trim();

  result.content = markdown;
  result.format = 'markdown';
}
```

### 2. html-parser.ts - DOM Map 기본 옵션 개선

**파일 경로**: `src/lib/html-parser.ts`

**수정 전**:

```typescript
const DEFAULT_DOM_MAP_OPTIONS: Required<DOMMapOptions> = {
  maxDepth: 3,
  maxChildren: 10,
  maxTextLength: 50,
  includeInteractiveOnly: true,
};
```

**수정 후**:

```typescript
const DEFAULT_DOM_MAP_OPTIONS: Required<DOMMapOptions> = {
  maxDepth: 10,
  maxChildren: 20,
  maxTextLength: 100,
  includeInteractiveOnly: false,
};
```

### 3. ExtractContentTool.ts - DOM Map 호출 옵션 개선

**파일 경로**: `src/features/tools/browser-tools/ExtractContentTool.ts`

**수정 전**:

```typescript
} else if (format === 'dom-map') {
  // DOM Map extraction using TypeScript parser
  const domMapResult = parseHTMLToDOMMap(rawHtml, {
    maxDepth: Math.min(maxDepth, 3),
    maxChildren: 10,
    maxTextLength: 50,
    includeInteractiveOnly: true,
  });
```

**수정 후**:

```typescript
} else if (format === 'dom-map') {
  // DOM Map extraction using TypeScript parser
  const domMapResult = parseHTMLToDOMMap(rawHtml, {
    maxDepth: Math.min(maxDepth, 10),
    maxChildren: 20,
    maxTextLength: 100,
    includeInteractiveOnly: false,
  });
```

## 재사용 가능한 연관 코드

### 핵심 파일 및 기능

1. **`src/lib/html-parser.ts`**
   - `parseHTMLToDOMMap()`: DOM 구조를 맵 형태로 변환
   - `parseHTMLToStructured()`: HTML을 구조화된 JSON으로 변환
   - `DEFAULT_DOM_MAP_OPTIONS`: DOM Map 추출 기본 옵션
   - **인터페이스**: `DOMMapOptions`, `DOMMapNode`, `DOMMapResult`

2. **`src/features/tools/browser-tools/ExtractContentTool.ts`**
   - `extractContentTool`: 브라우저 콘텐츠 추출 도구의 메인 함수
   - TurndownService 설정 및 사용
   - **의존성**: `turndown` 라이브러리, `html-parser.ts`

3. **`src/features/tools/browser-tools/types.ts`**
   - `BrowserLocalMCPTool`: 브라우저 도구 인터페이스
   - `BROWSER_TOOL_SCHEMAS`: 공통 스키마 정의

### 관련 유틸리티

1. **`src/lib/logger.ts`**
   - `getLogger()`: 컨텍스트별 로거 생성
   - 디버그 및 에러 로깅에 사용

2. **`src/lib/mcp-types.ts`**
   - MCP 프로토콜 관련 타입 정의
   - `createMCPErrorResponse()`, `createMCPSuccessResponse()` 등

### 테스트 가능한 컴포넌트

- **브라우저 세션 관리**: 실제 브라우저 세션에서 테스트 필요
- **HTML 파싱 로직**: 단위 테스트로 다양한 HTML 구조 검증 가능
- **Markdown 변환**: TurndownService 결과물의 정리 로직 검증 가능

## 작업 우선순위

1. **1단계**: html-parser.ts의 기본 옵션 수정 (기반 작업)
2. **2단계**: ExtractContentTool.ts의 Markdown 정리 로직 추가
3. **3단계**: ExtractContentTool.ts의 DOM Map 호출 옵션 수정
4. **4단계**: 테스트 및 검증

작업 완료 후에는 다양한 웹사이트에서 실제 동작을 확인하여 개선 효과를 검증한다.
