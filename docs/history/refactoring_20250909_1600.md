# Browser HTML Parsing Refactoring Plan

## 작업의 목적

ExtractContentTool의 JSON 형식 처리에서 브라우저 스크립트 주입 방식을 제거하고, TypeScript 기반의 HTML 파싱으로 전환하여 타입 안전성, 린트 검증, 빌드 타임 검증을 개선합니다.

## 현재의 상태 / 문제점

### 1. 브라우저 스크립트 주입 방식의 문제점

- `ExtractContentTool.ts`에서 JSON 형식 추출 시 `executeScript`를 통해 브라우저에 JavaScript 코드를 주입
- 런타임 오류를 사전에 감지하기 어려움
- TypeScript 린터나 빌드 타임 검증이 불가능
- 유지보수 및 리팩토링 시 타입 안전성 보장 어려움

### 2. 분산된 HTML 파싱 로직

- `ExtractContentTool.ts`: 마크다운 및 JSON 추출
- `dom-map-extractor.ts`: DOM Map 추출
- 유사한 기능이 여러 파일에 분산되어 코드 중복 및 일관성 부족

### 3. 프로젝트 가이드라인 위반

- 가이드라인에서 "script 삽입은 최소화" 권장
- TypeScript `any` 타입 사용 금지 정책과 런타임 스크립트 검증 불가능성 충돌

## 추가 분석 과제

### 1. 기존 DOM Map 기능 호환성 검증

- `dom-map-extractor.ts`의 기존 기능과 새로운 통합 파서의 출력 호환성
- 브라우저 네비게이션 기능에 미치는 영향 분석

### 2. 성능 비교 분석

- 브라우저 스크립트 vs TypeScript DOMParser 성능 차이
- 대용량 HTML 처리 시 메모리 사용량 비교

### 3. 브라우저 호환성 확인

- DOMParser API의 브라우저 호환성
- Tauri WebView 환경에서의 동작 검증

## 변경 이후의 상태 / 해결 판정 기준

### 1. 타입 안전성 확보

- ✅ 모든 HTML 파싱 로직이 TypeScript에서 타입 검증됨
- ✅ ESLint 규칙 준수 (no-any 등)
- ✅ 빌드 타임에 모든 파싱 오류 감지 가능

### 2. 코드 통합 및 일관성

- ✅ HTML 파싱 관련 기능이 단일 모듈(`src/lib/html-parser.ts`)에 통합
- ✅ `dom-map-extractor.ts` 파일 제거
- ✅ 일관된 인터페이스와 옵션 체계

### 3. 기능 확장

- ✅ 마크다운, JSON, DOM-map 세 가지 형식 지원
- ✅ 설정 가능한 파싱 옵션 (깊이, 링크 포함, 텍스트 길이 등)
- ✅ 포괄적인 단위 테스트 커버리지

### 4. 성능 및 안정성

- ✅ 브라우저 스크립트 주입 없이 HTML 처리
- ✅ 모든 테스트 케이스 통과
- ✅ 빌드 성공 및 린트 오류 없음

## 수정이 필요한 코드 및 수정부분

### 1. 새로운 HTML Parser 모듈 생성

**파일**: `src/lib/html-parser.ts`

```typescript
// 새로 생성할 통합 HTML 파서
export interface ParsedElement {
  tag: string;
  text?: string;
  id?: string;
  class?: string;
  href?: string;
  src?: string;
  alt?: string;
  title?: string;
  children: ParsedElement[];
}

export interface DOMMapNode {
  tag: string;
  selector: string;
  id?: string;
  class?: string;
  text?: string;
  type?: string;
  href?: string;
  placeholder?: string;
  value?: string;
  name?: string;
  role?: string;
  ariaLabel?: string;
  children: DOMMapNode[];
}

// 핵심 함수들
export function parseHTMLToStructured(
  htmlString: string,
  options: ParseOptions,
): StructuredContent;
export function parseHTMLToDOMMap(
  htmlString: string,
  options: DOMMapOptions,
): DOMMapResult;
export function extractHTMLMetadata(htmlString: string): PageMetadata;
```

### 2. ExtractContentTool 리팩토링

**파일**: `src/features/tools/browser-tools/ExtractContentTool.ts`

**변경 전 (JSON 형식 처리 부분)**:

```typescript
// 브라우저 스크립트 주입 방식
const structuredContent = await executeScript(
  sessionId,
  `(function() { /* 복잡한 JS 파싱 로직 */ })()`,
);
```

**변경 후**:

```typescript
import { parseHTMLToStructured, parseHTMLToDOMMap } from '@/lib/html-parser';

// TypeScript 파싱 방식
if (format === 'json') {
  const structuredResult = parseHTMLToStructured(rawHtml, parseOptions);
  if (structuredResult.error) {
    return createMCPErrorResponse(-32603, `Failed to parse HTML: ${structuredResult.error}`, ...);
  }
  result = {
    title: structuredResult.metadata.title,
    timestamp: structuredResult.metadata.timestamp,
    content: structuredResult.content,
    format: 'json',
  };
} else if (format === 'dom-map') {
  const domMapResult = parseHTMLToDOMMap(rawHtml, domMapOptions);
  // DOM Map 처리 로직
}
```

### 3. DOM Map Extractor 제거

**파일**: `src/features/tools/browser-tools/dom-map-extractor.ts`

- 파일 전체 삭제 예정
- 기능은 `html-parser.ts`로 이관

### 4. 테스트 코드 생성

**파일**: `src/lib/__tests__/html-parser.test.ts`

```typescript
describe('HTML Parser', () => {
  describe('parseHTMLToStructured', () => {
    test('should parse simple HTML structure', () => {
      // 구조화된 파싱 테스트
    });

    test('should handle links correctly based on includeLinks option', () => {
      // 링크 처리 옵션 테스트
    });
  });

  describe('parseHTMLToDOMMap', () => {
    test('should create DOM map for navigation', () => {
      // DOM Map 생성 테스트
    });

    test('should filter out ad and tracking elements', () => {
      // 광고/추적 요소 필터링 테스트
    });
  });
});
```

## 재사용 가능한 연관 코드

### 1. 기존 HTML 처리 관련 코드

- **파일**: `src/features/tools/browser-tools/ExtractContentTool.ts`
  - 마크다운 변환 로직 (TurndownService 사용)
  - HTML 메타데이터 추출 로직
  - MCP 응답 생성 로직

### 2. 브라우저 도구 공통 인터페이스

- **파일**: `src/features/tools/browser-tools/types.ts`
  - `BrowserLocalMCPTool` 인터페이스
  - 브라우저 스키마 정의

### 3. MCP 응답 유틸리티

- **파일**: `src/lib/mcp-response-utils.ts`
  - `createMCPStructuredResponse`
  - `createMCPErrorResponse`
  - 응답 형식 표준화 함수들

### 4. 로깅 시스템

- **파일**: `src/lib/logger.ts`
  - `getLogger` 함수
  - 컨텍스트별 로깅 시스템

### 5. 기존 DOM Map 로직 참조

- **파일**: `src/features/tools/browser-tools/dom-map-extractor.ts`
  - DOM 요소 필터링 로직
  - 선택자 생성 알고리즘
  - 중요도 기반 요소 우선순위 지정

## 작업 단계

### Phase 1: HTML Parser 모듈 개발

1. `src/lib/html-parser.ts` 생성
2. 기본 파싱 기능 구현
3. 단위 테스트 작성 및 검증

### Phase 2: ExtractContentTool 리팩토링

1. 새로운 파서 통합
2. DOM-map 형식 지원 추가
3. 기존 기능 호환성 확인

### Phase 3: 정리 및 검증

1. `dom-map-extractor.ts` 제거
2. 통합 테스트 실행
3. 빌드 및 린트 검증
4. 성능 테스트

## 위험도 및 완화 방안

### 위험도: 중간

- 기존 브라우저 자동화 기능에 영향 가능성
- DOM Map 기능 변경으로 인한 네비게이션 로직 영향

### 완화 방안

- 단계별 구현 및 테스트
- 기존 API 호환성 유지
- 충분한 테스트 케이스 확보
- 롤백 계획 수립

## 예상 소요 시간

- Phase 1: 2-3시간
- Phase 2: 1-2시간
- Phase 3: 1시간
- **총 예상 시간: 4-6시간**
