# ExtractContentTool 기능 테스트 구현 리팩토링 계획

**작성일시**: 2025년 9월 9일  
**작성자**: GitHub Copilot

## 작업의 목적

ExtractContentTool의 핵심 기능들을 포괄적으로 검증할 수 있는 테스트 코드를 구현하여, 브라우저 자동화 도구의 안정성과 신뢰성을 확보한다.

## 현재의 상태 / 문제점

### 현재 상태

- ExtractContentTool은 웹페이지의 HTML 콘텐츠를 Markdown 또는 JSON 형태로 추출하는 기능을 제공
- TurndownService를 사용한 Markdown 변환 및 커스텀 JavaScript를 통한 구조화된 JSON 추출 지원
- CSS 셀렉터 기반 타겟팅, 최대 깊이 제한, 링크 포함/제외 등 다양한 옵션 제공
- 스크립트/스타일 태그 필터링, 숨겨진 요소 제외 등의 정제 기능 포함

### 문제점

1. **테스트 커버리지 부족**: 현재 ExtractContentTool에 대한 포괄적인 단위 테스트가 존재하지 않음
2. **엣지 케이스 검증 부재**: 다양한 HTML 구조, 특수 문자, 중첩 깊이 등에 대한 검증 부족
3. **기능별 분리된 테스트 부재**: Markdown/JSON 추출, 옵션별 동작, 에러 처리 등이 개별적으로 검증되지 않음
4. **Mock HTML 데이터 부족**: 실제 웹페이지의 다양한 요소들을 시뮬레이션할 수 있는 테스트 데이터 부재

## 추가 분석 과제

1. **executeScript 함수 동작 방식**: Tauri 기반 브라우저 스크립트 실행 메커니즘의 정확한 동작 방식 파악
2. **MCP 응답 형식 표준화**: createMCPStructuredResponse와 createMCPErrorResponse의 정확한 반환 타입 정의
3. **TurndownService 설정 최적화**: 현재 설정이 다양한 HTML 요소에 대해 최적화되어 있는지 검증

## 변경 이후의 상태 / 해결 판정 기준

### 목표 상태

1. **포괄적인 테스트 스위트 구축**: 모든 주요 기능과 엣지 케이스를 커버하는 테스트 코드
2. **Mock 기반 독립적 테스트**: 실제 브라우저 의존성 없이 실행 가능한 단위 테스트
3. **기능별 세분화된 테스트**: Markdown 추출, JSON 추출, 옵션 처리, 에러 핸들링 등 분리된 테스트 케이스

### 해결 판정 기준

- [ ] 모든 입력 매개변수 조합에 대한 테스트 케이스 존재
- [ ] Markdown과 JSON 형식 모두에 대한 추출 테스트 통과
- [ ] 다양한 HTML 구조 (중첩, 테이블, 폼, 미디어 등)에 대한 검증 완료
- [ ] 에러 시나리오 (잘못된 셀렉터, 스크립트 실행 실패 등) 처리 검증
- [ ] 테스트 실행 시간 5초 이내 유지

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. 메인 테스트 파일: `src/test/extract-content-tool.test.ts`

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { extractContentTool } from '@/features/tools/browser-tools/ExtractContentTool';

// Mock HTML 파일 로드 유틸리티
const loadMockHtml = (section: string) => {
  // test_mock-test-page.html에서 특정 섹션 추출
};

// Mock 설정
vi.mock('@/lib/logger');
vi.mock('@/lib/mcp-response-utils');
vi.mock('@paralleldrive/cuid2');

describe('ExtractContentTool', () => {
  // 기본 설정, Markdown 추출, JSON 추출, 에러 처리 테스트
});
```

### 2. Mock HTML 데이터 개선: `src/test/fixtures/extract-content-test.html`

```html
<!-- 다양한 테스트 시나리오를 위한 구조화된 HTML -->
<div id="test-basic"><!-- 기본 요소 테스트 --></div>
<div id="test-forms"><!-- 폼 요소 테스트 --></div>
<div id="test-media"><!-- 미디어 요소 테스트 --></div>
<div id="test-nested"><!-- 중첩 구조 테스트 --></div>
<div id="test-special"><!-- 특수 문자/인코딩 테스트 --></div>
```

### 3. 테스트 유틸리티: `src/test/utils/html-test-utils.ts`

```typescript
export const createMockExecuteScript = (htmlResponses: string[]) => {
  return vi
    .fn()
    .mockResolvedValueOnce(htmlResponses[0])
    .mockResolvedValueOnce(htmlResponses[1]);
};

export const validateMarkdownOutput = (content: string) => {
  // Markdown 형식 검증 로직
};

export const validateJSONStructure = (data: any) => {
  // JSON 구조 검증 로직
};
```

## 재사용 가능한 연관 코드

### 관련 파일 및 인터페이스

1. **ExtractContentTool 구현**
   - 파일: `src/features/tools/browser-tools/ExtractContentTool.ts`
   - 주요 기능: HTML 콘텐츠 추출 및 변환
   - 인터페이스: `BrowserLocalMCPTool`

2. **브라우저 도구 타입 정의**
   - 파일: `src/features/tools/browser-tools/types.ts`
   - 인터페이스: `BrowserLocalMCPTool`, `ExecuteScriptFunction`

3. **MCP 응답 유틸리티**
   - 파일: `src/lib/mcp-response-utils.ts`
   - 함수: `createMCPStructuredResponse`, `createMCPErrorResponse`

4. **브라우저 도구 스키마**
   - 파일: `src/features/tools/browser-tools/helpers.ts`
   - 상수: `BROWSER_TOOL_SCHEMAS`

5. **기존 테스트 설정**
   - 파일: `src/test/setup.ts`
   - 기능: Vitest 테스트 환경 설정

### 재사용 가능한 패턴

1. **Mock 설정 패턴**: 기존 `dom-map-extraction.test.ts`의 mock 설정 방식 참조
2. **HTML 파싱 패턴**: `dom-map-test.html`의 구조화된 테스트 데이터 접근 방식
3. **비동기 테스트 패턴**: Vitest의 async/await 테스트 패턴

## 구현 단계

### Phase 1: 기본 테스트 인프라 구축

- Mock 설정 및 기본 테스트 케이스 작성
- HTML 테스트 데이터 정리 및 구조화

### Phase 2: 핵심 기능 테스트

- Markdown 추출 기능 테스트
- JSON 추출 기능 테스트
- 매개변수별 동작 검증

### Phase 3: 엣지 케이스 및 에러 처리

- 다양한 HTML 구조 테스트
- 에러 시나리오 처리 검증
- 성능 및 메모리 사용량 테스트

### Phase 4: 통합 및 검증

- 전체 테스트 스위트 실행 및 검증
- 코드 커버리지 확인
- 성능 벤치마크 측정
