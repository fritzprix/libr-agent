# Refactoring Plan: Content Store 중복 컨텐츠 처리 개선

## 작업의 목적

- Content Store의 중복 컨텐츠 처리 로직을 개선하여, storeId별로 인덱스를 분리하고 동일 컨텐츠라도 다른 storeId에서는 허용하도록 함
- 같은 storeId 내에서는 파일 해시 기반으로 중복을 방지하여 저장 공간 및 검색 효율성 향상
- BM25SearchEngine의 인덱스 관리를 storeId별로 독립적으로 수행하여 멀티 세션 지원 강화

## 현재의 상태 / 문제점

- 현재 BM25SearchEngine은 전역적으로 인덱스를 관리하여, 동일 컨텐츠가 다른 storeId에서 중복 저장될 수 있음
- chunk 단위에서는 중복 방지가 되지만, 전체 컨텐츠(파일) 단위에서는 중복 체크 로직이 부족
- addContent 함수에서 컨텐츠 중복 여부를 체크하지 않아 DB에 동일 파일이 여러 번 저장될 수 있음
- 검색 인덱스가 storeId별로 분리되지 않아 멀티 세션 환경에서 효율적이지 않음

## 추가 분석 과제

- 파일 해시 계산 방식의 브라우저 호환성 검토 (Node.js crypto vs Web Crypto API)
- DB 스키마 변경 필요성 분석 (contentHash 필드 추가)
- 기존 데이터 마이그레이션 전략 수립

## 변경 이후의 상태 / 해결 판정 기준

- storeId별로 BM25 인덱스가 독립적으로 관리됨
- 동일 컨텐츠라도 storeId가 다르면 각각 저장 가능
- 같은 storeId 내에서는 contentHash로 중복 방지됨
- 검색 성능 및 저장 공간 효율성 향상
- 테스트 케이스: 동일 파일을 다른 storeId에 추가 시 각각 저장되는지, 같은 storeId에 추가 시 중복 방지되는지 확인

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. BM25SearchEngine 클래스 개선

- storeId별 인덱스 분리 로직 강화
- preprocessText 메서드의 정규식 패턴 검토 (한글 지원 포함)

### 2. addContent 함수 개선

- 파일 해시 계산 및 중복 체크 로직 추가
- DB 조회 및 저장 로직 수정

### 3. DB 서비스 인터페이스 확장

- findByHashAndStore 메서드 추가
- contentHash 필드 지원

### 주요 코드 스니핏 예시

```typescript
// 파일 해시 계산 함수 추가
function computeContentHash(content: string): string {
  // 브라우저 환경 고려한 해시 계산
  // Node.js: crypto.createHash, Browser: crypto.subtle
}

// addContent 함수 내 중복 체크 로직
const contentHash = computeContentHash(finalContent);
const existing = await dbService.fileContents.findByHashAndStore(contentHash, input.storeId);
if (existing) {
  // 중복 시 기존 정보 반환
  return existing;
}
```

## 구현 우선순위

1. 파일 해시 계산 함수 구현 및 브라우저 호환성 확보
2. DB 스키마 및 서비스 메서드 확장
3. addContent 함수 중복 체크 로직 추가
4. BM25SearchEngine storeId별 인덱스 관리 검증
5. 테스트 및 마이그레이션
