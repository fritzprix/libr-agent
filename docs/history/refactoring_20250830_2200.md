# BM25 검색 엔진 코드 분리 리팩토링 계획

## 작업의 목적

- BM25 검색 엔진 관련 코드를 `content-store.ts`에서 독립적인 모듈로 분리하여 코드의 모듈성과 유지보수성을 향상시키기
- 검색 엔진 로직과 컨텐츠 스토어 비즈니스 로직의 관심사 분리를 통해 코드 재사용성과 테스트 용이성을 높이기
- `BM25SearchEngine` 클래스의 복잡도를 낮추고, 실제로 아무 작업도 수행하지 않는 `initialize()` 메서드의 문제를 해결하기

## 현재의 상태 / 문제점

### 현재 구조

- `BM25SearchEngine` 클래스가 `content-store.ts` 파일 내에 200줄 이상의 코드로 구현되어 있음
- BM25 관련 타입 정의(`BM25SearchResult`, `LocalBM25Instance`)가 같은 파일에 혼재
- `initialize()` 메서드가 실제 초기화 작업 없이 플래그만 설정하는 문제가 있음
- 검색 엔진과 컨텐츠 스토어 로직이 강하게 결합되어 있어 독립적인 테스트와 재사용이 어려움

### 주요 문제점

1. **관심사 혼재**: 검색 엔진 로직과 파일 관리 로직이 같은 파일에 존재
2. **코드 복잡도**: 단일 파일이 너무 커서 유지보수가 어려움
3. **재사용성 부족**: BM25 엔진을 다른 모듈에서 재사용하기 어려움
4. **테스트 용이성 저하**: 검색 엔진만 독립적으로 테스트하기 어려움
5. **초기화 로직 부재**: `initialize()` 메서드가 실제 초기화 작업을 수행하지 않음

## 추가 분석 과제 (선택적)

- wink-bm25-text-search 패키지의 최신 버전 호환성 검토
- BM25 파라미터 튜닝을 위한 성능 벤치마킹
- 메모리 사용량 최적화를 위한 인덱스 관리 전략 검토

## 변경 이후의 상태 / 해결 판정 기준

### 목표 구조

```text
src/lib/web-mcp/modules/bm25/
├── bm25-search-engine.ts    # BM25SearchEngine 클래스
├── types.ts                 # BM25 관련 타입 정의
└── index.ts                 # 모듈 익스포트
```

### 해결 판정 기준

1. **모듈성**: BM25 관련 코드가 완전히 분리되어 독립적인 모듈로 존재
2. **컴파일 성공**: TypeScript 컴파일 에러 없이 빌드 성공
3. **기능 보존**: 기존 검색 기능이 모두 정상 동작
4. **테스트 가능성**: BM25 엔진을 독립적으로 유닛 테스트할 수 있음
5. **재사용성**: 다른 모듈에서 BM25 엔진을 쉽게 임포트하여 사용할 수 있음
6. **초기화 개선**: `initialize()` 메서드가 실제 초기화 작업을 수행하도록 개선

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. 새 파일 생성: `src/lib/web-mcp/modules/bm25/types.ts`

```typescript
// BM25 관련 타입 정의
export type BM25SearchResult = [string, number];

export interface LocalBM25Instance {
  defineConfig: (config: object) => void;
  addDoc: (doc: { id: string; text: string }) => void;
  consolidate: () => void;
  search: (query: string) => BM25SearchResult[];
}
```

### 2. 새 파일 생성: `src/lib/web-mcp/modules/bm25/bm25-search-engine.ts`

```typescript
import type { FileChunk } from '@/lib/db';
import type { ISearchEngine, SearchOptions, SearchResult } from '@/models/search-engine';
import type { BM25SearchResult, LocalBM25Instance } from './types';

export class BM25SearchEngine implements ISearchEngine {
  // ... 기존 BM25SearchEngine 구현을 이동
  // initialize() 메서드에 실제 초기화 로직 추가
}
```

### 3. 수정 파일: `src/lib/web-mcp/modules/content-store.ts`

```typescript
// BM25 관련 import 추가
import { BM25SearchEngine } from './bm25/bm25-search-engine';

// BM25 관련 코드 제거 및 import로 대체
// const searchEngine = new BM25SearchEngine();
```

### 4. 새 파일 생성: `src/lib/web-mcp/modules/bm25/index.ts`

```typescript
export { BM25SearchEngine } from './bm25-search-engine';
export type { BM25SearchResult, LocalBM25Instance } from './types';
```

## 작업 순서 요약

1. BM25 관련 타입을 `types.ts`로 분리
2. `BM25SearchEngine` 클래스를 `bm25-search-engine.ts`로 이동 및 개선
3. `content-store.ts`에서 BM25 관련 코드 제거 및 import로 대체
4. 모듈 익스포트 파일(`index.ts`) 생성
5. 컴파일 및 기능 테스트 수행
6. 필요시 추가 분석 과제 수행

## 예상 작업 시간

- 코드 분리 및 이동: 2-3시간
- 초기화 로직 개선: 1시간
- 테스트 및 검증: 1-2시간
- 총 예상 시간: 4-6시간
