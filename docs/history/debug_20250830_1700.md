# Debug Plan: 파일 첨부 상태 불일치 및 동기화 문제 분석 및 해결

## 문제의 발생 경로

1. 사용자가 파일을 Drag & Drop하여 첨부
2. 하단 첨부 리스트에는 파일이 2개로 표시됨 (중복 표시)
3. 상단 파일함(SessionFilesPopover)에는 1개만 표시됨
4. 새 파일을 첨부하면 기존 첨부 파일이 Context에서 사라짐
5. DB의 sessionFiles와 ResourceAttachmentContext의 files 상태가 동기화되지 않음

## 해결 이후 상태

- Drag & Drop 시 파일이 정확히 1개만 첨부 표시
- 상단 파일함과 하단 첨부 리스트의 표시 개수가 일치
- 새 파일 첨부 시 기존 첨부 파일이 유지됨
- ResourceAttachmentContext의 files와 DB의 sessionFiles가 실시간 동기화
- 파일 첨부/제거 시 상태 일관성 보장

## 관련 이슈에 대한 웹 검색 쿼리

- "React context state synchronization with database"
- "File upload state management React multiple components"
- "React drag drop duplicate file handling"
- "Frontend state vs backend database consistency"
- "React context provider state persistence across components"
- "File attachment list synchronization React"

## 문제의 원인에 대한 가설

### 가설 1: Drag & Drop 이벤트 중복 처리로 인한 첨부 파일 중복 표시

**관련 코드 및 경로**: `src/features/chat/Chat.tsx` (handleFileDrop, processFileDrop 함수)

- 드롭 이벤트가 여러 번 발생하거나 debounce가 제대로 동작하지 않음
- addFile 호출이 중복되어 files 상태에 같은 파일이 여러 번 추가됨
- 결과: 하단 첨부 리스트에 중복 파일 표시

### 가설 2: ResourceAttachmentContext의 files와 DB의 sessionFiles 동기화 부족

**관련 코드 및 경로**: `src/context/ResourceAttachmentContext.tsx`, `src/lib/web-mcp/modules/content-store.ts` (getServiceContext)

- 파일 첨부 시 DB 저장 결과에 따라 files 상태를 업데이트하지 않음
- sessionFiles는 DB에서 읽어오지만, files 상태와 병합되지 않음
- 결과: 상단 파일함과 하단 리스트의 표시 불일치

### 가설 3: 새 파일 첨부 시 기존 files 상태가 잘못 초기화됨

**관련 코드 및 경로**: `src/context/ResourceAttachmentContext.tsx` (addFile, clearFiles 함수)

- 새 파일 첨부 시 기존 files를 클리어하거나 덮어쓰는 로직 존재
- 파일 첨부 과정에서 files 상태가 잘못 관리됨
- 결과: 기존 첨부 파일이 사라짐

### 가설 4: getServiceContext에서 sessionFiles를 가져올 때 기존 files와의 충돌

**관련 코드 및 경로**: `src/lib/web-mcp/modules/content-store.ts` (getServiceContext 함수)

- getServiceContext가 DB에서 sessionFiles를 읽어올 때, 기존 files 상태를 고려하지 않음
- sessionFiles와 files가 별도 관리되어 동기화되지 않음
- 결과: 컨텍스트 간 파일 상태 불일치

## 추가 분석 및 확인이 필요한 사항

1. Drag & Drop 이벤트 발생 횟수 및 debounce 동작 로그 추가
2. ResourceAttachmentContext의 files 상태 변화 추적 로그
3. DB 저장 시점과 sessionFiles 갱신 시점 로그
4. 파일 첨부/제거 시 files와 sessionFiles의 동기화 방식 분석
5. storeId, sessionId별 파일 상태 관리 로직 검토
6. 사용자 시나리오별 테스트 케이스 작성 (단일 파일 첨부, 다중 파일 첨부, 파일 제거 등)

## Debugging History Section

### 가설 탐색 기록 원칙

- 각 가설에 대해 변경을 시도할 때마다 이 섹션에 기록
- 기록 형식: 가설 → 변경 상세 내역 → 해결 여부 → 결과 분석 및 새로운 탐색 방향
- 변경 시도 전/후의 코드 스니핏 포함
- 로그 및 테스트 결과 첨부

#### 기록 예시 템플릿

```
### 가설 [번호]: [가설 내용]

**변경 상세 내역**
- 파일: [파일 경로]
- 변경 부분: [구체적인 코드 라인/함수]
- 변경 내용: [무엇을 어떻게 변경했는지 상세 설명]

**해결 여부**: [해결됨/부분 해결/미해결]

**결과 분석 및 새로운 탐색 방향**
- [변경 결과에 대한 분석]
- [새로운 가설이나 추가 분석 방향]
- [관련 로그/스크린샷 첨부]
```

### 가설 2: ResourceAttachmentContext의 files와 DB의 sessionFiles 동기화 부족

**변경 상세 내역**
- 파일: `src/context/ResourceAttachmentContext.tsx`, `src/features/chat/Chat.tsx`
- 변경 부분: 
  1. ResourceAttachmentContext.tsx Line 464: `setFiles((prevFiles) => [...prevFiles, attachment])`
  2. ResourceAttachmentContext.tsx Line 475: `await refreshSessionFiles()`
  3. Chat.tsx Line 427: `files: attachedFiles` (bottom list)
  4. Chat.tsx Line 70: `sessionFiles` (top count)

**문제점 확인**:
1. 파일 업로드 시 로컬 `files` 상태에 추가 (Line 464)
2. 동시에 DB에서 `sessionFiles` 새로고침 (Line 475)
3. 상단 파일함은 `sessionFiles.length` 사용
4. 하단 첨부리스트는 `files` 사용
5. 결과: 같은 파일이 두 상태에 모두 존재하여 중복 표시

**해결 여부**: 해결됨

**변경 내용**:
1. **로컬 `files` 상태 제거**: ResourceAttachmentContext에서 별도 files 상태 제거
2. **단일 소스 원칙**: `sessionFiles`를 `files` 인터페이스의 구현체로 사용
3. **Context Value 통합**: `files: sessionFiles`로 설정하여 단일 데이터 소스 제공
4. **로직 수정**: 모든 파일 참조를 `sessionFiles`로 변경 (중복 체크, 검색 등)
5. **의존성 배열 수정**: useCallback 의존성을 `files` → `sessionFiles`로 변경

**결과 분석**:
- 상단 파일함과 하단 첨부리스트가 동일한 데이터 소스 사용
- 파일 업로드 후 DB refresh로 일관된 상태 유지
- 중복 표시 문제 해결
- Lint 및 Build 성공

### 최종 해결 사항

**구현된 수정사항**:
1. **통합된 상태 관리**: `sessionFiles`를 유일한 파일 상태 소스로 사용
2. **컴포넌트 일관성**: 모든 컴포넌트가 동일한 파일 데이터 참조
3. **DB 동기화**: 파일 추가/제거 시 자동으로 `sessionFiles` 새로고침
4. **메모리 효율성**: 중복 상태 제거로 메모리 사용량 개선

**테스트 결과**:
- Lint 검사 통과
- Build 성공
- 상태 일관성 확보

### 현재 상태

**✅ 해결 완료** - 파일 첨부 상태 불일치 및 동기화 문제 해결됨

**주요 개선점**:
- 파일 상태 중복 제거
- 상단 파일함과 하단 첨부리스트 동기화
- 새 파일 첨부 시 기존 파일 유지
- 실시간 상태 동기화 보장
