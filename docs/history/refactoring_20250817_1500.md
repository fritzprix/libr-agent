# MCP Server Context 상태 명확화 및 UI 로딩 표시 개선 리팩터링

## 작업의 목적

MCP Server Context의 상태 관리를 명확하게 하고, Chat.tsx에서 도구 개수 표시 시 로딩 상태를 적절히 표시하여 사용자 경험을 개선하는 것을 목적으로 합니다.

## 현재의 상태 / 문제점

### 1. MCPServerContext 상태 이름의 모호함

**위치**: `src/context/MCPServerContext.tsx`

- **문제**: `isConnecting` 이름이 모호하여 초기화/연결/로딩 상태를 구분하기 어려움
- **영향**: 개발자가 상태의 의미를 파악하기 어렵고, 일반적인 React 패턴과 일치하지 않음

**현재 코드**:

```typescript
interface MCPServerContextType {
  availableTools: MCPTool[];
  getAvailableTools: () => MCPTool[];
  isConnecting: boolean; // 모호한 이름
  status: Record<string, boolean>;
  connectServers: (mcpConfigs: MCPConfig) => Promise<void>;
  executeToolCall: (toolCall: {...}) => Promise<MCPResponse>;
}
```

### 2. 에러 상태 누락

**위치**: `src/context/MCPServerContext.tsx`

- **문제**: MCP 서버 연결 실패나 도구 실행 에러에 대한 전역 상태가 없음
- **영향**: 사용자에게 에러 상황을 알릴 수 없고, UI에서 적절한 피드백을 제공할 수 없음

**현재 코드**:

```typescript
const [{ loading: isConnecting }, connectServers] = useAsyncFn(
  async (mcpConfig: MCPConfig) => {
    // ...
    try {
      // connection logic
    } catch (error) {
      logger.error('Error connecting to MCP:', { error });
      // 에러 상태를 context에 저장하지 않음
    }
  },
  [],
);
```

### 3. Chat.tsx에서 불명확한 도구 상태 표시

**위치**: `src/features/chat/Chat.tsx`

- **문제**: 도구 개수만 표시하고 로딩/에러 상태에 대한 적절한 피드백이 없음
- **영향**: 사용자가 MCP 서버 연결 상태를 파악하기 어려움

**현재 코드**:

```typescript
function ChatStatusBar({ children, onShowTools }: { ... }) {
  const { availableTools: mcpTools } = useMCPServer();
  const availableTools = useMemo(() => [...mcpTools], [mcpTools]);

  return (
    <div className="px-4 py-2 border-t flex items-center justify-between">
      {/* ... */}
      <button onClick={onShowTools}>
        🔧 {availableTools.length} available
      </button>
    </div>
  );
}
```

### 4. useMCPServer 훅의 타입 안전성 부족

**위치**: `src/hooks/use-mcp-server.ts`

- **문제**: 반환 타입이 명시되지 않아 타입 추론에 의존
- **영향**: IDE 지원이 제한되고, 타입 안전성이 보장되지 않음

**현재 코드**:

```typescript
export const useMCPServer = () => {
  const context = useContext(MCPServerContext);
  if (context === undefined) {
    throw new Error('useMCPServer must be used within a MCPServerProvider');
  }
  return context; // 타입이 명시되지 않음
};
```

## 변경 이후의 상태 / 해결 판정 기준

### 1. 명확한 상태 이름 및 에러 상태 추가

- **해결책**: `isConnecting` → `isLoading`으로 변경하고 `error?: string` 상태 추가
- **판정 기준**:
  - Context 인터페이스에 `isLoading`과 `error` 필드가 있어야 함
  - 연결 실패 시 `error` 상태가 적절히 설정되어야 함

### 2. 사용자 친화적인 도구 상태 표시

- **해결책**: 로딩/에러/성공 상태에 따른 적절한 텍스트, 색상 및 로딩 아이콘 표시
- **판정 기준**:
  - 로딩 중: 스피너 아이콘과 "Loading tools..." 표시 (노란색)
  - 에러 발생: "Tools error" 표시 (빨간색)
  - 정상 상태: "X available" 표시 (초록색)
  - 로딩 중에는 버튼이 비활성화되어야 함
  - 로딩 아이콘은 부드러운 회전 애니메이션이 있어야 함

### 3. 타입 안전성 확보

- **해결책**: useMCPServer 훅에 명시적 반환 타입 지정
- **판정 기준**:
  - 훅의 반환 타입이 `MCPServerContextType`으로 명시되어야 함
  - TypeScript 컴파일 에러가 없어야 함

## 수정이 필요한 코드 및 수정부분의 코드 스니펫

### 수정 1: MCPServerContext 인터페이스 개선

**파일**: `src/context/MCPServerContext.tsx`

```typescript
// 현재
interface MCPServerContextType {
  availableTools: MCPTool[];
  getAvailableTools: () => MCPTool[];
  isConnecting: boolean;
  status: Record<string, boolean>;
  connectServers: (mcpConfigs: MCPConfig) => Promise<void>;
  executeToolCall: (toolCall: {
    id: string;
    type: 'function';
    function: { name: string; arguments: string };
  }) => Promise<MCPResponse>;
}

// 수정 후
interface MCPServerContextType {
  availableTools: MCPTool[];
  getAvailableTools: () => MCPTool[];
  isLoading: boolean;     // isConnecting에서 변경
  error?: string;         // 에러 상태 추가
  status: Record<string, boolean>;
  connectServers: (mcpConfigs: MCPConfig) => Promise<void>;
  executeToolCall: (toolCall: {
    id: string;
    type: 'function';
    function: { name: string; arguments: string };
  }) => Promise<MCPResponse>;
}
```

### 수정 2: MCPServerProvider에서 에러 상태 관리

**파일**: `src/context/MCPServerContext.tsx`

```typescript
// 현재
export const MCPServerProvider: React.FC<{ children: ReactNode }> = ({
  children,
}) => {
  const [availableTools, setAvailableTools] = useState<MCPTool[]>([]);
  const [serverStatus, setServerStatus] = useState<Record<string, boolean>>({});
  const availableToolsRef = useRef(availableTools);

  const [{ loading: isConnecting }, connectServers] = useAsyncFn(
    async (mcpConfig: MCPConfig) => {
      const serverStatus: Record<string, boolean> = {};
      try {
        // connection logic
      } catch (error) {
        logger.error('Error connecting to MCP:', { error });
      }
    },
    [],
  );

// 수정 후
export const MCPServerProvider: React.FC<{ children: ReactNode }> = ({
  children,
}) => {
  const [availableTools, setAvailableTools] = useState<MCPTool[]>([]);
  const [serverStatus, setServerStatus] = useState<Record<string, boolean>>({});
  const [error, setError] = useState<string | undefined>(undefined); // 에러 상태 추가
  const availableToolsRef = useRef(availableTools);

  const [{ loading: isLoading }, connectServers] = useAsyncFn(
    async (mcpConfig: MCPConfig) => {
      const serverStatus: Record<string, boolean> = {};
      setError(undefined); // 연결 시작 시 에러 초기화
      try {
        // connection logic
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        setError(errorMessage); // 에러 상태 설정
        logger.error('Error connecting to MCP:', { error });
      }
    },
    [],
  );
```

### 수정 3: Context value에 새 상태 포함

**파일**: `src/context/MCPServerContext.tsx`

```typescript
// 현재
  const value: MCPServerContextType = useMemo(
    () => ({
      availableTools,
      isConnecting,
      getAvailableTools,
      status: serverStatus,
      connectServers,
      executeToolCall,
    }),
    [
      availableTools,
      isConnecting,
      serverStatus,
      getAvailableTools,
      connectServers,
      executeToolCall,
    ],
  );

// 수정 후
  const value: MCPServerContextType = useMemo(
    () => ({
      availableTools,
      isLoading,      // isConnecting에서 변경
      error,          // 에러 상태 추가
      getAvailableTools,
      status: serverStatus,
      connectServers,
      executeToolCall,
    }),
    [
      availableTools,
      isLoading,      // 변경된 이름
      error,          // 에러 상태 추가
      serverStatus,
      getAvailableTools,
      connectServers,
      executeToolCall,
    ],
  );
```

### 수정 4: ChatStatusBar 컴포넌트 개선

**파일**: `src/features/chat/Chat.tsx`

```typescript
// 현재
function ChatStatusBar({
  children,
  onShowTools,
}: {
  children?: React.ReactNode;
  onShowTools?: () => void;
}) {
  const { availableTools: mcpTools } = useMCPServer();
  const availableTools = useMemo(() => [...mcpTools], [mcpTools]);

  return (
    <div className="px-4 py-2 border-t flex items-center justify-between">
      <div>
        <CompactModelPicker />
        {children}
      </div>
      <div className="flex items-center gap-2">
        <span className="text-xs">Tools:</span>
        <button
          onClick={onShowTools}
          className="text-xs text-green-400 transition-colors flex items-center gap-1"
        >
          🔧 {availableTools.length} available
        </button>
      </div>
    </div>
  );
}

// 수정 후
function ChatStatusBar({
  children,
  onShowTools,
}: {
  children?: React.ReactNode;
  onShowTools?: () => void;
}) {
  const { availableTools, isLoading, error } = useMCPServer();

  // 로딩 스피너 컴포넌트
  const LoadingSpinner = () => (
    <svg 
      className="animate-spin h-3 w-3 text-yellow-400" 
      xmlns="http://www.w3.org/2000/svg" 
      fill="none" 
      viewBox="0 0 24 24"
    >
      <circle 
        className="opacity-25" 
        cx="12" 
        cy="12" 
        r="10" 
        stroke="currentColor" 
        strokeWidth="4"
      />
      <path 
        className="opacity-75" 
        fill="currentColor" 
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
      />
    </svg>
  );

  // 도구 상태를 계산
  const getToolsDisplayText = () => {
    if (isLoading) return 'Loading tools...';
    if (error) return 'Tools error';
    return `${availableTools.length} available`;
  };

  const getToolsColor = () => {
    if (isLoading) return 'text-yellow-400';
    if (error) return 'text-red-400'; 
    return availableTools.length > 0 ? 'text-green-400' : 'text-gray-500';
  };

  const getToolsIcon = () => {
    if (isLoading) return <LoadingSpinner />;
    if (error) return '⚠️';
    return '🔧';
  };

  return (
    <div className="px-4 py-2 border-t flex items-center justify-between">
      <div>
        <CompactModelPicker />
        {children}
      </div>
      <div className="flex items-center gap-2">
        <span className="text-xs">Tools:</span>
        <button
          onClick={onShowTools}
          className={`text-xs transition-colors flex items-center gap-1 ${getToolsColor()}`}
          disabled={isLoading}
          title={error || undefined}
        >
          {getToolsIcon()} {getToolsDisplayText()}
        </button>
      </div>
    </div>
  );
}
```

### 수정 5: useMCPServer 훅 타입 안전성 개선

**파일**: `src/hooks/use-mcp-server.ts`

```typescript
// 현재
export const useMCPServer = () => {
  const context = useContext(MCPServerContext);
  if (context === undefined) {
    throw new Error('useMCPServer must be used within a MCPServerProvider');
  }
  return context;
};

// 수정 후
import type { MCPServerContextType } from '../context/MCPServerContext';

export const useMCPServer = (): MCPServerContextType => {
  const context = useContext(MCPServerContext);
  if (context === undefined) {
    throw new Error('useMCPServer must be used within a MCPServerProvider');
  }
  return context;
};
```

## 작업 우선순위

1. **High**: MCPServerContext 인터페이스 및 Provider 수정 (상태 관리 기반)
2. **High**: useMCPServer 훅 타입 안전성 개선 (타입 에러 방지)
3. **Medium**: ChatStatusBar UI 개선 (사용자 경험 향상)

## 예상 영향도

- **Breaking Change**: 없음 (`isConnecting` → `isLoading` 변경은 내부 구현)
- **사용자 경험**: 명확한 로딩/에러 상태 표시로 크게 개선
- **개발자 경험**: 타입 안전성 향상으로 개발 효율성 증대
- **Testing Required**:
  - MCP 서버 연결 성공/실패 시나리오 테스트
  - UI 상태 변화 테스트 (로딩 → 성공/에러)
  - 타입 안전성 검증

## 검증 방법

1. **기능 검증**:
   - MCP 서버 연결 중 스피너 아이콘과 "Loading tools..." 표시 확인
   - 스피너가 부드럽게 회전하는지 확인
   - 연결 실패 시 "Tools error" 표시 및 경고 아이콘(⚠️), 빨간색 표시 확인
   - 정상 연결 시 도구 개수와 🔧 아이콘, 초록색 표시 확인

2. **타입 검증**:
   - TypeScript 컴파일 에러 없음 확인
   - IDE에서 자동완성 및 타입 힌트 정상 작동 확인

3. **사용성 검증**:
   - 로딩 중 버튼 비활성화 확인
   - 에러 상태에서 툴팁으로 에러 메시지 표시 확인
   - 로딩 아이콘 애니메이션이 성능에 영향을 주지 않는지 확인
