# MCP Response Double Wrapping 해결 및 타입 안전성 강화

**작성일**: 2025-09-06 07:20  
**작업자**: GitHub Copilot  
**브랜치**: ref/chat

## 작업의 목적

SynapticFlow의 MCP (Model Context Protocol) 응답 시스템에서 발생하는 double wrapping 문제를 해결하고, 타입 안전성을 강화하여 일관된 JSON-RPC 2.0 표준 준수를 달성한다.

## 현재의 상태 / 문제점

### 1. Double Wrapping 문제

**현상**: Tool 실행 결과가 중첩된 content 구조로 반환됨

```json
// 문제 상황
{
  "content": [
    {
      "type": "text",
      "text": "{\"content\":\"...actual data...\",\"format\":\"markdown\",...}"
    }
  ]
}
```

**원인 분석 (전체 MCP 백엔드 조사 완료)**:

#### A. **Browser Tools** ⚠️ **문제 확인됨**

- **위치**: `src/features/tools/browser-tools/`
- **문제**: ExtractContentTool이 `createMCPStructuredResponse()` 호출 → BrowserToolProvider가 `isMCPResponse()` 체크 없이 재래핑
- **영향**: 구조화된 응답이 text 필드에 JSON 문자열로 중첩됨

#### B. **Rust Builtin Tools** ✅ **정상**

- **위치**: `src-tauri/src/mcp/builtin/workspace/`
- **구조**: `create_success_response()` → 표준 MCPResponse 직접 생성
- **응답**: `normalizeToolResult`에서 이미 MCPResponse인 경우 그대로 반환 (수정 완료)

#### C. **External MCP Servers** ⚠️ **정규화 필요**

- **위치**: `src/context/MCPServerContext.tsx`
- **처리**: `callMCPTool()` → Rust 백엔드 → `normalizeToolResult()` 재처리
- **문제**: 외부 서버 응답이 이미 MCPResponse 형태일 경우 이중 래핑 가능성

#### D. **Web MCP Tools** ✅ **표준 준수**

- **위치**: `src/lib/web-mcp/modules/`
- **구조**: `planning-server.ts`의 `callTool()` → `normalizeToolResult()` 호출
- **응답**: 표준 MCPResponse 구조로 반환

### 2. 타입 안전성 부족

**전체 백엔드 타입 안전성 분석**:

#### A. **Browser Tools** ❌ **약한 타입**

```typescript
// 현재: 약한 타입
execute: (args: Record<string, unknown>) => Promise<unknown>;

// 목표: 강한 타입
execute: (args: Record<string, unknown>) => Promise<MCPResponse>;
```

#### B. **Rust Builtin Tools** ✅ **강한 타입**

```rust
// Rust에서 이미 강타입
async fn call_tool(&self, tool_name: &str, args: Value) -> MCPResponse
```

#### C. **External MCP Servers** ⚠️ **중간 타입**

```typescript
// Rust 백엔드로 위임, normalizeToolResult로 보장
executeToolCall: (toolCall: ToolCall) => Promise<MCPResponse>;
```

#### D. **Web MCP Tools** ✅ **강한 타입**

```typescript
// 이미 강타입
async callTool(name: string, args: unknown): Promise<MCPResponse>
```

### 3. 보안 유틸리티 미활용

**Rust 백엔드 보안 검증**:

- **위치**: `src-tauri/src/mcp/builtin/workspace/utils.rs`
- **상태**: `SecurityValidator` 구현되어 있으나 file_operations.rs에서 미사용
- **영향**: 파일 경로 검증 없이 직접 처리

### 4. 응답 처리 파이프라인 복잡성

**통합 MCP 시스템 구조**:

```text
1. ToolCall → use-unified-mcp.ts
2. Backend 라우팅:
   - Browser Tools → BrowserToolProvider → tool.execute()
   - Rust Tools → RustMCPToolProvider → Tauri command
   - External MCP → MCPServerContext → Rust backend
   - Web MCP → mcp-proxy.ts → mcp-worker.ts
3. 모든 결과 → normalizeToolResult() (mcp-types.ts)
```

**문제점**:

- Browser Tools만 Provider 레벨에서 추가 래핑
- 일관성 없는 응답 처리 방식
- 타입 안전성 격차

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. **응답 구조 일관성**

   ```json
   // 올바른 단일 구조
   {
     "jsonrpc": "2.0",
     "id": "...",
     "result": {
       "content": [
         {
           "type": "text",
           "text": "actual content here"
         }
       ],
       "structuredContent": {
         /* optional structured data */
       }
     }
   }
   ```

2. **타입 안전성**
   - 모든 tool execute 함수가 `Promise<MCPResponse>` 반환
   - 컴파일 타임에 타입 에러 발생

3. **보안성**
   - 모든 file operations에 path validation 적용
   - SecurityValidator 사용 확산

### 검증 방법

1. **단위 테스트**: extractContent tool 응답 구조 검증
2. **통합 테스트**: 전체 tool execution 파이프라인 테스트
3. **타입 체크**: `pnpm build` 성공 및 타입 에러 부재

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. Browser Tools 타입 강화

#### `src/features/tools/browser-tools/types.ts`

```typescript
// BEFORE: 약한 타입
export type LocalMCPTool = MCPTool & {
  execute: (args: Record<string, unknown>) => Promise<unknown>;
};

// AFTER: 강한 타입
export type StrictLocalMCPTool = MCPTool & {
  execute: (args: Record<string, unknown>) => Promise<MCPResponse>;
};
```

#### `src/features/tools/browser-tools/ExtractContentTool.ts`

```typescript
// BEFORE: JSON 문자열 반환 (Line 205)
return JSON.stringify(result, null, 2);

// AFTER: 구조화된 MCPResponse 직접 반환
return {
  jsonrpc: '2.0',
  id: createId(),
  result: {
    content: [{ type: 'text', text: result.content || 'No content' }],
    structuredContent: result,
  },
};
```

#### `src/features/tools/BrowserToolProvider.tsx`

```typescript
// BEFORE: 무조件 text wrapping (Line 160-168)
return {
  jsonrpc: '2.0',
  id: toolCall.id,
  result: {
    content: [
      {
        type: 'text',
        text:
          typeof result === 'string' ? result : JSON.stringify(result, null, 2),
      },
    ],
  },
};

// AFTER: MCPResponse 타입 체크 및 직접 반환
if (isMCPResponse(result)) {
  return { ...result, id: toolCall.id };
}
// fallback for legacy tools
return createMCPTextResponse(
  typeof result === 'string' ? result : JSON.stringify(result, null, 2),
  toolCall.id,
);
```

### 2. Rust Security Validator 적용

#### `src-tauri/src/mcp/builtin/workspace/file_operations.rs`

```rust
// BEFORE: 직접 path 처리
let file_path = workspace_dir.join(&file_path_str);

// AFTER: SecurityValidator 사용
use super::utils::SecurityValidator;

let security = SecurityValidator::default();
let validated_path = security.validate_path(&file_path_str)
    .map_err(|e| format!("Path validation failed: {}", e))?;
```

### 3. 타입 안전성 유틸리티 추가

#### `src/lib/mcp-response-utils.ts` (신규 파일)

```typescript
import { MCPResponse, MCPContent } from './mcp-types';
import { createId } from '@paralleldrive/cuid2';

export function createMCPTextResponse(
  text: string,
  id?: string | number | null,
): MCPResponse {
  return {
    jsonrpc: '2.0',
    id: id ?? createId(),
    result: {
      content: [{ type: 'text', text }],
    },
  };
}

export function isMCPResponse(obj: unknown): obj is MCPResponse {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'jsonrpc' in obj &&
    (obj as MCPResponse).jsonrpc === '2.0'
  );
}
```

## 재사용 가능한 연관 코드

### 파일 경로 및 주요 기능

#### 핵심 타입 정의

- `src/lib/mcp-types.ts`: MCPResponse, MCPContent 타입 정의
- `src/models/chat.ts`: ToolCall 인터페이스

#### Tool 실행 시스템

- `src/hooks/use-unified-mcp.ts`: 통합 MCP tool 실행
- `src/hooks/use-tool-processor.ts`: Tool call 처리 로직
- `src/features/tools/index.tsx`: BuiltIn tool context

#### 응답 정규화

- `src/lib/mcp-types.ts::normalizeToolResult()`: Tool 결과 표준화 (이미 수정됨)
- `src/features/tools/RustMCPToolProvider.tsx`: Rust tool 응답 처리

#### 보안 검증

- `src-tauri/src/mcp/builtin/utils.rs`: SecurityValidator 구현
- `src-tauri/src/mcp/builtin/workspace/`: File operation tools

### 주요 인터페이스

#### MCPResponse 표준

```typescript
interface MCPResponse {
  jsonrpc: '2.0';
  id: string | number | null;
  result?: MCPResult;
  error?: MCPError;
}

interface MCPResult {
  content?: MCPContent[];
  structuredContent?: Record<string, unknown>;
}
```

#### Tool 실행 인터페이스

```typescript
interface ToolCall {
  id: string;
  function: {
    name: string;
    arguments: string | Record<string, unknown>;
  };
}
```

### 유틸리티 함수

- `createId()`: 고유 ID 생성
- `getLogger()`: 로깅 시스템
- `isMCPError()`, `isMCPSuccess()`: 응답 타입 가드

## 작업 순서 권장사항

1. **타입 정의 강화** (저위험)
2. **Browser Tools 수정** (중위험)
3. **Security Validator 적용** (저위험)
4. **통합 테스트** (검증)

이를 통해 안전하고 점진적인 리팩토링이 가능하며, 각 단계에서 검증을 통해 regression을 방지할 수 있다.
