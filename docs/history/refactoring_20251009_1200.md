# Refactoring Plan: History UI Enhancement - Add First User Message Preview and Date Display

## 작업의 목적

History 페이지의 세션 목록을 더 직관적이고 유용하게 개선하여 사용자가 각 대화의 내용을 빠르게 파악하고 생성 시점을 확인할 수 있도록 한다. 구체적으로:

- 각 세션 항목에 첫 번째 사용자 메시지의 텍스트 프리뷰를 표시하여 어떤 대화인지 한눈에 파악 가능
- 세션 생성 날짜와 상대 시간을 표시하여 시간적 맥락 제공
- UI 레이아웃을 한 줄 카드 형식으로 개선하여 정보 밀도 향상

## 현재의 상태 / 문제점

### 현재 UI 상태

- `History.tsx`에서 세션 목록을 `SessionList` → `SessionItem`으로 렌더링
- 각 세션 항목에는 세션 이름(`session.name`)만 표시됨
- 세션 생성 시점이나 내용에 대한 정보가 전혀 없음
- 사용자가 많은 세션을 보유한 경우 어떤 대화인지 구분하기 어려움

### 기술적 문제점

- 세션 데이터(`Session` 인터페이스)에는 메시지 배열이 포함되지 않음 (정규화된 DB 구조)
- 첫 사용자 메시지를 표시하려면 별도 DB 쿼리 필요
- 날짜 포맷팅과 상대 시간 계산 로직이 없음
- 성능 고려: 세션 목록이 많을 때 각 항목별 DB 쿼리가 부담스러움

### 사용자 경험 문제점

- 세션 이름만으로는 대화 내용을 유추하기 어려움
- 생성 시점을 모르니 시간적 우선순위 파악 불가
- 목록이 길어질수록 탐색성이 저하됨

## 관련 코드의 구조 및 동작 방식 Summary (Bird's Eye View)

### 데이터 흐름

1. `History.tsx` → `useSessionContext()` → 세션 페이지 목록 획득
2. `SessionList.tsx` → 세션 배열을 `SessionItem.tsx`으로 매핑
3. `SessionItem.tsx` → 각 세션의 이름과 기본 액션 표시

### DB 구조

- `sessions` 테이블: 세션 메타데이터 (`Session` 인터페이스)
- `messages` 테이블: 메시지 데이터 (`Message` 인터페이스)
- 연결: `Message.sessionId` ↔ `Session.id`

### 메시지 구조

- `Message.content: MCPContent[]` (멀티파트 콘텐츠)
- 텍스트 추출: `processMessageContent()` 또는 `content.filter(type === 'text').map(text).join()`
- 첫 사용자 메시지: `role === 'user'` 중 `createdAt` 오름차순 첫 번째

### 현재 렌더링 제한사항

- `SessionItem`은 `Session` 객체만 props로 받음
- 메시지 데이터 접근을 위해 DB 쿼리 필요
- UI는 단순 텍스트 + 드롭다운 메뉴 구조

## 변경 이후의 상태 / 해결 판정 기준

### 목표 UI 상태

```text
[ICON] My conversation title
       first user message preview text...
                   AssistantA · 2025-10-09 · 2h ago   [⋮]
```

### 성공 판정 기준

- [ ] 각 세션 항목에 첫 사용자 메시지 프리뷰 표시 (최대 120자, 말줄임)
- [ ] 세션 생성 날짜와 상대 시간 표시 (예: "2025-10-09 · 2h ago")
- [ ] 프리뷰 로딩 중 skeleton/placeholder 표시
- [ ] 메시지가 없는 세션의 경우 "(No messages)" 표시
- [ ] UI 성능: 10개 세션 로딩 시 2초 이내 완료
- [ ] 접근성: 날짜에 툴팁으로 정확한 타임스탬프 표시
- [ ] 반응형: 모바일에서 프리뷰 텍스트 숨김 처리

### 기술적 해결 기준

- [ ] DB 쿼리 성능: 각 세션별 lazy loading으로 N+1 문제 방지
- [ ] 메모리 누수 방지: 컴포넌트 unmount 시 쿼리 취소
- [ ] 타입 안전성: 모든 날짜/텍스트 처리에 null/undefined 체크
- [ ] 에러 처리: DB 쿼리 실패 시 graceful degradation

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. SessionItem.tsx - 메인 변경 파일

```typescript
// 추가 import
import { useEffect, useState } from 'react';
import { LocalDatabase } from '@/lib/db';
import { Message } from '@/models/chat';
import { processMessageContent } from '@/lib/ai-service/base-service';

// 추가 유틸 함수들
function extractPlainTextFromContent(content: MCPContent[] | undefined): string {
  if (!content || !Array.isArray(content)) return '';
  return content
    .filter((c) => (c as any).type === 'text')
    .map((t: any) => t.text ?? '')
    .join(' ')
    .trim();
}

function shortPreview(text: string, max = 120): string {
  if (!text) return '(No messages)';
  return text.length > max ? text.slice(0, max).trim() + '…' : text;
}

function formatSessionTimestamp(date?: Date | string | undefined): string {
  if (!date) return 'Unknown date';
  const d = typeof date === 'string' ? new Date(date) : date;
  if (isNaN(d.getTime())) return 'Invalid date';

  const now = Date.now();
  const diff = Math.floor((now - d.getTime()) / 1000);
  if (diff < 60) return `${diff}s ago`;
  if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
  return d.toLocaleDateString();
}

// SessionItem 컴포넌트에 추가
const [preview, setPreview] = useState<string | null>(null);
const [isLoadingPreview, setIsLoadingPreview] = useState(false);

useEffect(() => {
  let mounted = true;
  setIsLoadingPreview(true);

  async function loadPreview() {
    try {
      const db = LocalDatabase.getInstance();
      const items = await db.messages
        .where('sessionId')
        .equals(session.id)
        .and((m: Message) => m.role === 'user')
        .sortBy('createdAt');

      if (!mounted) return;

      const firstMessage = items.length > 0 ? items[0] : null;
      const text = extractPlainTextFromContent(firstMessage?.content);
      setPreview(shortPreview(text));
    } catch (e) {
      if (!mounted) return;
      setPreview('(Error loading preview)');
    } finally {
      if (mounted) setIsLoadingPreview(false);
    }
  }

  loadPreview();
  return () => {
    mounted = false;
  };
}, [session.id]);

// 렌더링 부분 변경 (기존 구조 유지하면서 추가)
<div className="flex items-center group hover:bg-gray-700 rounded-md transition-colors w-full min-w-0 px-1">
  <div className="flex flex-1 min-w-0">
    {/* 기존 버튼 구조 유지 */}
    <Button ...>
      {isCollapsed ? (
        sessionIcon
      ) : (
        <div className="flex-1 min-w-0 text-left">
          <div className="truncate text-ellipsis overflow-hidden block max-w-full font-medium">
            {displayName}
          </div>
          {!isCollapsed && (
            <div className="text-sm text-gray-400 mt-1 line-clamp-1">
              {isLoadingPreview ? 'Loading preview...' : preview}
            </div>
          )}
        </div>
      )}
    </Button>
  </div>

  {/* 날짜 표시 추가 */}
  {!isCollapsed && (
    <div className="flex-shrink-0 ml-2 text-xs text-gray-500">
      {formatSessionTimestamp(session.createdAt)}
    </div>
  )}

  {/* 기존 드롭다운 유지 */}
  {!isCollapsed && (
    <div className="flex-shrink-0 ml-1">
      <DropdownMenu>...</DropdownMenu>
    </div>
  )}
</div>
```

### 2. History.tsx - 스타일 조정 (선택적)

```typescript
// SessionList에 추가 props 전달 가능하게 수정
<SessionList
  sessions={sessions}
  showSearch={true}
  className="flex-1"
  emptyMessage="No sessions yet. Start a conversation to create your first session."
  showPreviews={true} // 새로운 prop
/>
```

### 3. SessionList.tsx - props 확장 (선택적)

```typescript
interface SessionListProps {
  sessions: Session[];
  showSearch?: boolean;
  className?: string;
  emptyMessage?: string;
  showPreviews?: boolean; // 추가
}
```

## 재사용 가능한 연관 코드 (파일 경로, 주요 기능, 인터페이스 등 포함)

### DB 관련

- `src/lib/db/service.ts`: `getMessagesPageForSession()` - 메시지 페이징 조회
- `src/lib/db/index.ts`: `LocalDatabase.getInstance()` - DB 인스턴스
- `src/lib/db/crud.ts`: 메시지 CRUD 인터페이스

### 메시지 처리

- `src/lib/ai-service/base-service.ts`: `processMessageContent()` - MCPContent에서 텍스트 추출
- `src/lib/utils.ts`: `stringToMCPContentArray()` - 텍스트를 MCPContent로 변환
- `src/lib/mcp-types.ts`: `MCPContent` 인터페이스 정의

### UI 컴포넌트

- `src/components/ui/skeleton.tsx`: 로딩 상태 표시용
- `src/components/ui/tooltip.tsx`: 날짜 툴팁용

### 컨텍스트

- `src/context/SessionContext.tsx`: 세션 목록 관리
- `src/context/SessionHistoryContext.tsx`: 세션 내 메시지 관리

## Test Code 추가 및 수정 필요 부분에 대한 가이드 포함

### 단위 테스트 (SessionItem.test.tsx)

```typescript
import { render, screen, waitFor } from '@testing-library/react';
import SessionItem from './SessionItem';
import { LocalDatabase } from '@/lib/db';

// Mock DB
jest.mock('@/lib/db', () => ({
  LocalDatabase: {
    getInstance: jest.fn(() => ({
      messages: {
        where: jest.fn(() => ({
          equals: jest.fn(() => ({
            and: jest.fn(() => ({
              sortBy: jest.fn(() => Promise.resolve([
                {
                  content: [{ type: 'text', text: 'Test user message' }],
                  role: 'user',
                  createdAt: new Date()
                }
              ]))
            }))
          }))
        }))
      }
    }))
  }
}));

describe('SessionItem', () => {
  it('displays first user message preview', async () => {
    const mockSession = {
      id: 'test-session',
      name: 'Test Session',
      createdAt: new Date('2025-10-09T10:00:00Z'),
      assistants: [{ name: 'Test Assistant' }]
    };

    render(<SessionItem session={mockSession} />);

    await waitFor(() => {
      expect(screen.getByText('Test user message')).toBeInTheDocument();
    });

    expect(screen.getByText(/ago$/)).toBeInTheDocument(); // 상대 시간 표시 확인
  });

  it('shows loading state initially', () => {
    // 로딩 상태 테스트
  });

  it('handles no messages gracefully', async () => {
    // 빈 메시지 케이스 테스트
  });
});
```

### 통합 테스트 (History.test.tsx)

```typescript
// History 컴포넌트가 SessionList에 올바른 props를 전달하는지 확인
// 실제 DB 쿼리 없이 mock으로 세션 데이터 제공
```

### E2E 테스트 (선택적)

- Playwright로 History 페이지 로딩 후 프리뷰 표시 확인
- 세션 클릭 시 올바른 라우팅 동작 확인

### 테스트 실행 가이드

```bash
# 단위 테스트
pnpm test -- SessionItem.test.tsx

# 통합 테스트
pnpm test -- History.test.tsx

# E2E (별도 설정 필요)
pnpm test:e2e
```

### 테스트 커버리지 목표

- 프리뷰 로딩 성공 케이스: 80%
- 에러 처리 케이스: 90%
- 엣지 케이스 (빈 메시지, 긴 텍스트): 100%

## 추가 분석 과제

### 성능 최적화 분석

- 현재 lazy loading 방식의 성능 측정 (Chrome DevTools)
- Batch loading 방식 구현 시 성능 비교
- Denormalization (세션에 firstMessagePreview 필드 추가) 고려

### 접근성 분석

- 스크린 리더로 프리뷰 텍스트 읽기 확인
- 키보드 네비게이션으로 날짜 툴팁 접근성 검증

### 모바일 UX 분석

- 다양한 화면 크기에서 프리뷰 텍스트 표시/숨김 동작 테스트
- 터치 인터랙션 최적화 검토
