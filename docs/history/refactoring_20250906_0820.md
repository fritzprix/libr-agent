# Planning Server 스키마 단순화 및 MCP-UI 표준 준수 Refactoring Plan

## 작업의 목적

Gemini API의 `MALFORMED_FUNCTION_CALL` 오류를 해결하기 위해 Planning Server의 복잡한 중첩 객체 스키마를 단순화하고, 동시에 공식 `@mcp-ui/server` 패키지를 사용하여 MCP-UI 표준 준수를 달성합니다. 이를 통해 Gemini API 호환성 문제를 해결하면서도 기능의 핵심은 유지하고 UI 리소스 생성을 표준화합니다.

## 현재의 상태 / 문제점

### 1. Gemini API 호환성 문제

- **위치**: `src/lib/web-mcp/modules/planning-server.ts` Tool 정의 부분
- **문제**: 복잡한 중첩 객체 스키마가 Gemini Function Schema 변환 과정에서 `MALFORMED_FUNCTION_CALL` 오류 유발
- **구체적 사례**:
  - `update_goal.inputSchema.properties.updates` - 중첩 객체 구조
  - `update_todo.inputSchema.properties.updates` - 중첩 객체 구조
  - `add_observation.inputSchema.properties.tags` - 배열 타입
  - `sequential_thinking` - 4개 필드 + boolean 타입의 복잡한 스키마

### 2. 불필요한 복잡성

- **Goal과 Todo에 name/description 중복**: Goal은 세션당 하나이므로 name 필드 불필요
- **복잡한 상태 관리**: ID 기반 관리 대신 단순한 인덱스 기반으로 충분
- **과도한 메타데이터**: observations, sequential_thinking 등의 복잡한 기능이 핵심 목적과 부합하지 않음

### 3. MCP-UI 커스텀 구현

- **위치**: `createGoalTodosUIResource` 함수
- **문제**: 자체 구현된 UIResource 대신 공식 `@mcp-ui/server` 표준 미준수
- **결과**: 다른 MCP-UI 클라이언트와의 상호 운용성 부족

### 4. 로그 증거

```
finishReason: "MALFORMED_FUNCTION_CALL"
promptTokenCount: 10704
hasTools: true
```

## 추가 분석 과제

1. **스키마 변환 검증**: 변경된 단순 스키마가 `src/lib/ai-service/tool-converters.ts`에서 올바르게 변환되는지 확인
2. **UI 렌더링 호환성**: `@mcp-ui/server` 패키지로 생성된 UIResource가 기존 `UIResourceRenderer`와 정상 작동하는지 검증
3. **다른 AI 서비스 영향도**: Gemini 외 다른 AI 서비스(OpenAI, Anthropic 등)에서도 단순화된 스키마가 정상 작동하는지 테스트

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. **Gemini API 호환성**: `MALFORMED_FUNCTION_CALL` 오류 완전 해결
2. **기능 보존**: Goal 생성/수정, Todo 추가/토글 등 핵심 기능 유지
3. **스키마 단순성**: 모든 Tool 스키마가 1-depth 플랫 구조 (중첩 객체 없음)
4. **MCP-UI 표준 준수**: `@mcp-ui/server` 패키지 사용으로 표준 호환성 달성
5. **토큰 효율성**: 불필요한 필드 제거로 프롬프트 크기 감소

### 검증 방법

1. **API 테스트**: Gemini API로 Planning Server 도구들 실행하여 오류 없음 확인
2. **기능 테스트**: Goal 생성, Todo 추가/토글, UIResource 렌더링 정상 작동 확인
3. **호환성 테스트**: 다른 AI 서비스에서도 정상 작동 확인
4. **로그 검증**: `promptTokenCount` 감소 및 `MALFORMED_FUNCTION_CALL` 부재 확인

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. Planning Server 전체 단순화

**파일**: `src/lib/web-mcp/modules/planning-server.ts`
**수정 범위**: 전체 파일 리팩토링

```typescript
// 변경 전 - 복잡한 인터페이스
interface Goal {
  id: number;
  name: string;
  description?: string;
  status: 'active' | 'completed' | 'paused';
  createdAt: Date;
}

interface Todo {
  id: number;
  name: string;
  description?: string;
  status: 'pending' | 'in_progress' | 'completed';
  createdAt: Date;
}

// 변경 후 - 단순화된 인터페이스
interface SimpleTodo {
  name: string;
  status: 'pending' | 'completed';
}

class EphemeralState {
  private goal: string | null = null; // 단순 문자열
  private todos: SimpleTodo[] = [];   // 단순 배열
  
  // Goal은 단순 문자열로 관리
  createGoal(goal: string): string { ... }
  
  // 배열 인덱스 기반 Todo 관리
  toggleTodo(index: number): SimpleTodo | null { ... }
}
```

### 2. Tool 스키마 완전 단순화

**파일**: `src/lib/web-mcp/modules/planning-server.ts`
**수정 위치**: tools 배열 정의

```typescript
// 변경 전 - 중첩 객체 스키마
{
  name: 'update_goal',
  inputSchema: {
    type: 'object',
    properties: {
      updates: {                    // ❌ 중첩 객체
        type: 'object',
        properties: {
          name: { type: 'string' },
          description: { type: 'string' },
          status: { type: 'string', enum: [...] },
        },
      },
    },
    required: ['updates'],
  },
}

// 변경 후 - 플랫 스키마
{
  name: 'create_goal',
  inputSchema: {
    type: 'object',
    properties: {
      goal: { type: 'string' },     // ✅ 단순 필드
    },
    required: ['goal'],
  },
}
```

### 3. MCP-UI 표준 적용

**파일**: `src/lib/web-mcp/modules/planning-server.ts`
**수정 위치**: UIResource 생성 함수

```typescript
// 변경 전 - 커스텀 UIResource
import type { UIResource } from '@/lib/mcp-types';

function createGoalTodosUIResource(
  goal: Goal | null,
  todos: Todo[],
): UIResource {
  return {
    uri: `ui://planning/overview/${Date.now()}`,
    mimeType: 'text/html',
    text: htmlContent,
  };
}

// 변경 후 - 공식 @mcp-ui/server 사용
import { createUIResource } from '@mcp-ui/server';

function createGoalTodosUIResource(
  goal: string | null,
  todos: SimpleTodo[],
) {
  return createUIResource({
    uri: `ui://planning/overview/${Date.now()}`,
    content: {
      type: 'rawHtml',
      htmlString: htmlContent,
    },
    encoding: 'text',
  });
}
```

### 4. 도구 개수 최소화

**파일**: `src/lib/web-mcp/modules/planning-server.ts`
**수정 위치**: tools 배열

```typescript
// 변경 전 - 8개 복잡한 도구
const tools: MCPTool[] = [
  'create_goal', 'update_goal', 'add_todo', 'update_todo', 
  'list_todos', 'add_observation', 'sequential_thinking', 'clear_session'
];

// 변경 후 - 6개 단순한 도구
const simplifiedTools: MCPTool[] = [
  'create_goal', 'clear_goal', 'add_todo', 
  'toggle_todo', 'clear_todos', 'clear_session'
];
```

## 재사용 가능한 연관 코드

### 핵심 파일 및 의존성

- **주요 수정 파일**: `src/lib/web-mcp/modules/planning-server.ts`
- **타입 정의**: `src/lib/mcp-types.ts` - MCPTool, WebMCPServer, MCPResponse 인터페이스
- **도구 변환**: `src/lib/ai-service/tool-converters.ts` - Gemini 스키마 변환 로직
- **UI 렌더링**: `src/components/ui/UIResourceRenderer.tsx` - UIResource 렌더링 컴포넌트

### MCP-UI 관련 의존성

- **새로운 의존성**: `@mcp-ui/server` 패키지 (설치 필요)
- **기존 UI 시스템**: `src/components/ui/UIResourceRenderer.tsx`와의 호환성 유지
- **문서 참조**: `docs/mcp-ui-integration.md` - MCP-UI 통합 가이드

### Tool Converter 연관성

- **스키마 검증**: `src/lib/ai-service/tool-converters.ts`의 `convertMCPToolToProviderFormat` 함수
- **Gemini 변환**: `convertPropertiesToGeminiTypes` 함수에서 단순화된 스키마 처리 확인
- **타입 안정성**: 새로운 단순 스키마가 기존 변환 로직과 호환되는지 검증

### 시스템 프롬프트 연관성

- **컨텍스트 제공**: `getServiceContext()` 메서드의 출력 포맷 단순화
- **도구 설명**: 시스템 프롬프트에서 도구 사용법 안내 업데이트
- **토큰 최적화**: 불필요한 메타데이터 제거로 컨텍스트 크기 감소

### 테스트 시나리오

1. **단위 테스트**: 각 단순화된 도구 함수의 입출력 검증
2. **통합 테스트**: Gemini API와의 실제 연동 테스트
3. **UI 테스트**: UIResource 렌더링 정상 작동 확인
4. **회귀 테스트**: 기존 기능 보존 여부 검증
