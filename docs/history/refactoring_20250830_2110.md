# Refactoring Plan: Content Store Module Improvements

## 작업의 목적

Content store 모듈의 안정성과 성능을 향상시키기 위해 BM25 검색 엔진의 버그 수정, 데이터베이스 효율성 개선, 그리고 코드 구조 최적화를 수행합니다. 특히 유사도 검색 기능의 신뢰성을 높이고, 병렬 처리 시 발생할 수 있는 경쟁 조건을 방지하며, 대용량 데이터 처리 시 성능을 개선하는 것이 목표입니다.

## 현재의 상태 / 문제점

### 1. BM25 검색 엔진 버그

- `consolidate()` 호출 누락으로 인한 검색 실패 ("search is not possible unless learnings are consolidated!" 오류)
- 병렬 호출 시 인덱스 초기화 경쟁 조건 발생 가능성
- 청킹 전략이 검색 품질에 부정적 영향

### 2. 데이터베이스 효율성 문제

- `listContent` 함수에서 전체 데이터를 조회한 후 필터링하는 비효율적인 방식
- 대용량 데이터 처리 시 성능 저하

### 3. 코드 구조 및 유지보수성

- 로깅 과다로 인한 성능 영향 가능성
- 도구 입력 검증 부족으로 런타임 오류 발생 가능성
- 청킹 로직이 검색 엔진과 밀접하게 결합되어 있음

## 추가 분석 과제 (선택적)

- BM25 라이브러리의 최신 버전 호환성 검토 및 업데이트 필요성
- 청킹 전략의 최적화 (청크 크기, 중첩 등) 및 검색 정확도 영향 분석
- 데이터베이스 인덱스 최적화 및 쿼리 성능 프로파일링
- 병렬 처리 시의 메모리 사용량 및 GC 영향 분석

## 변경 이후의 상태 / 해결 판정 기준

### 해결 판정 기준

1. **BM25 검색 엔진 안정성**: 유사도 검색이 100% 성공률로 수행되며, consolidate 오류가 발생하지 않음
2. **성능 개선**: `listContent` 쿼리 시간이 50% 이상 개선되고, 대용량 데이터 처리 시 메모리 사용량이 안정적임
3. **코드 품질**: 코드 커버리지가 80% 이상 유지되며, 주요 함수의 복잡도가 낮아짐
4. **병렬 처리 안정성**: 다중 동시 요청 시 경쟁 조건 없이 정상 작동
5. **유지보수성**: 새로운 검색 엔진이나 청킹 전략 교체가 용이함

### 변경 이후 상태

- BM25 인덱스 관리가 강화되어 검색 실패율 0%
- 데이터베이스 쿼리가 최적화되어 대용량 데이터 처리 성능 향상
- 코드 구조가 모듈화되어 유지보수 및 확장 용이
- 로깅 레벨이 조정되어 성능 영향 최소화
- 입력 검증이 강화되어 런타임 오류 감소

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. BM25SearchEngine 클래스 개선

- **현재 코드 (문제점)**:

  ```typescript
  async addToIndex(storeId: string, newChunks: FileChunk[]): Promise<void> {
    // ... existing code ...
    if (chunkMapping.size > 0) {
      try {
        bm25.consolidate();
      } catch (consolidateError) {
        logger.warn('BM25 consolidation failed, continuing anyway', { ... });
      }
    }
  }
  ```

- **개선 방향**: consolidate 실패 시 재시도 로직 추가, 인덱스 잠금 메커니즘 구현

### 2. listContent 함수 최적화

- **현재 코드 (문제점)**:

  ```typescript
  async function listContent(input: ListContentInput): Promise<{...}> {
    const allPages = await dbService.fileContents.getPage(1, 1000);
    const allContentsInStore = allPages.items.filter(
      (item: FileContent) => item.storeId === storeId,
    );
  }
  ```

- **개선 방향**: 데이터베이스 레벨에서 storeId 필터링 쿼리 구현

### 3. 청킹 전략 모듈화

- **현재 코드 (문제점)**: TextChunker 클래스가 BM25SearchEngine과 밀접하게 결합
- **개선 방향**: 청킹 인터페이스 분리 및 전략 패턴 적용

### 4. 로깅 레벨 조정

- **현재 코드 (문제점)**: 모든 로그가 console에 출력되어 성능 영향
- **개선 방향**: 환경별 로깅 레벨 설정 및 조건부 로깅

### 5. 입력 검증 강화

- **현재 코드 (문제점)**: 런타임 입력 검증 부족
- **개선 방향**: Zod 또는 Joi를 사용한 스키마 기반 검증 추가

---

**다음 단계**:

1. BM25SearchEngine의 consolidate 및 인덱스 관리 로직 우선 개선
2. 데이터베이스 쿼리 최적화 구현
3. 청킹 전략 모듈화 및 인터페이스 분리
4. 로깅 및 입력 검증 개선
5. 단위 테스트 및 통합 테스트 작성
