# Planning Server UIResource Integration Refactoring Plan

## 작업의 목적

Planning Server의 todo/goal 업데이트 도구 사용 시, 현재 목표와 할 일 목록의 전체 현황을 시각적으로 표현하는 UIResource를 응답에 포함하여 사용자 경험을 개선합니다.

## 현재의 상태 / 문제점

### 1. 현재 응답 구조

- Planning Server의 모든 도구는 `normalizeToolResult`를 통해 텍스트 기반 응답만 반환
- Goal/Todo 업데이트 후 현재 상태를 확인하려면 별도의 `list_todos` 도구를 호출해야 함
- 시각적 피드백 부재로 사용자가 전체 진행 상황을 한눈에 파악하기 어려움

### 2. 기술적 제약사항

- 기존 `normalizeToolResult` 패턴을 유지해야 함 (일관성)
- `@mcp-ui/server`를 활용한 표준 UIResource 생성 필요
- MCPResponse 구조와 MCPContent 타입 준수 필요

## 추가 분석 과제

1. **UIResource HTML 템플릿 최적화**
   - 다양한 Goal/Todo 상태에 대한 시각적 표현 방식 검토
   - 반응형 디자인 및 접근성 고려사항 분석

2. **성능 영향도 분석**
   - HTML 생성 비용과 메모리 사용량 검토
   - 대량의 Todo 항목 처리 시 성능 최적화 방안

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. `create_goal`, `update_goal`, `add_todo`, `update_todo` 도구 실행 시 UIResource가 응답에 포함됨
2. UIResource는 현재 Goal과 모든 Todo의 상태를 HTML 형태로 표시
3. 기존 텍스트 응답도 유지되어 API 호환성 보장
4. `@mcp-ui/server`의 표준 구조를 준수하여 MCP-UI 호환성 확보
5. 기존 `normalizeToolResult` 패턴과 일관성 유지

### 검증 방법

- Goal 생성/수정 후 HTML 형태의 현황 표시 확인
- Todo 추가/수정 후 전체 목록의 시각적 표시 확인
- 기존 도구들의 동작 변경 없음 확인

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. Planning Server Import 추가

**파일:** `src/lib/web-mcp/modules/planning-server.ts`

```typescript
// 추가할 import
import { createUIResource } from '@mcp-ui/server';
import type { UIResource } from '@mcp-ui/server';
```

### 2. HTML 생성 헬퍼 함수 추가

```typescript
/**
 * Goal과 Todo 현황을 HTML로 생성
 */
function generateGoalTodosHTML(goal: Goal | null, todos: Todo[]): string {
  const goalSection = goal
    ? `
      <div class="goal-section" style="margin-bottom: 16px; padding: 12px; border-left: 4px solid #2563eb; background: #f8fafc;">
        <h3 style="margin: 0 0 8px 0; color: #1e40af;">🎯 Current Goal</h3>
        <div style="font-weight: bold; color: #1f2937;">${goal.name}</div>
        ${goal.description ? `<div style="color: #6b7280; margin-top: 4px;">${goal.description}</div>` : ''}
        <div style="margin-top: 8px;">
          <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; background: ${
            goal.status === 'completed'
              ? '#dcfce7; color: #166534'
              : goal.status === 'paused'
                ? '#fef3c7; color: #92400e'
                : '#dbeafe; color: #1d4ed8'
          };">
            ${goal.status}
          </span>
        </div>
      </div>
    `
    : `
      <div class="goal-section" style="margin-bottom: 16px; padding: 12px; border-left: 4px solid #d1d5db; background: #f9fafb;">
        <h3 style="margin: 0; color: #6b7280;">🎯 No Active Goal</h3>
      </div>
    `;

  const todosSection = `
    <div class="todos-section">
      <h3 style="margin: 0 0 12px 0; color: #1f2937;">📋 Todo List (${todos.length})</h3>
      ${
        todos.length === 0
          ? '<div style="color: #6b7280; font-style: italic;">No todos yet</div>'
          : todos
              .map(
                (todo) => `
          <div style="margin-bottom: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; background: #ffffff;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="padding: 2px 6px; border-radius: 8px; font-size: 11px; background: ${
                todo.status === 'completed'
                  ? '#dcfce7; color: #166534'
                  : todo.status === 'in_progress'
                    ? '#fef3c7; color: #92400e'
                    : '#f3f4f6; color: #374151'
              };">
                ${todo.status}
              </span>
              <span style="font-weight: 500; color: #1f2937;">${todo.name}</span>
            </div>
            ${todo.description ? `<div style="margin-top: 4px; color: #6b7280; font-size: 14px;">${todo.description}</div>` : ''}
          </div>
        `,
              )
              .join('')
      }
    </div>
  `;

  return `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0; padding: 16px; line-height: 1.5;">
      <h2 style="margin: 0 0 16px 0; color: #1f2937; border-bottom: 2px solid #e5e7eb; padding-bottom: 8px;">
        📊 Goals & Todos Overview
      </h2>
      ${goalSection}
      ${todosSection}
      <div style="margin-top: 16px; padding: 8px; background: #f3f4f6; border-radius: 6px; font-size: 12px; color: #6b7280;">
        Last updated: ${new Date().toLocaleString()}
      </div>
    </div>
  `;
}
```

### 3. UIResource 생성 헬퍼 함수 추가

```typescript
/**
 * Goal/Todo UIResource 생성
 */
function createGoalTodosUIResource(
  goal: Goal | null,
  todos: Todo[],
): UIResource {
  const htmlContent = generateGoalTodosHTML(goal, todos);

  return createUIResource({
    uri: `ui://planning/overview/${Date.now()}`,
    content: {
      type: 'rawHtml',
      htmlString: htmlContent,
    },
    encoding: 'text',
  });
}
```

### 4. normalizeToolResult 확장 함수 추가

```typescript
/**
 * UIResource를 포함한 Tool 결과 정규화
 */
function normalizeToolResultWithUI(
  result: unknown,
  toolName: string,
  uiResource?: UIResource,
): MCPResponse {
  const baseResponse = normalizeToolResult(result, toolName);

  if (uiResource && baseResponse.result?.content) {
    // UIResource를 content 배열 앞쪽에 추가
    baseResponse.result.content.unshift({
      type: 'resource',
      resource: uiResource,
    });
  }

  return baseResponse;
}
```

### 5. callTool 메서드 수정

```typescript
// 기존 코드에서 수정할 부분
async callTool(name: string, args: unknown): Promise<MCPResponse> {
  const typedArgs = args as Record<string, unknown>;

  switch (name) {
    case 'create_goal': {
      const result = state.createGoal(
        typedArgs.name as string,
        typedArgs.description as string,
      );
      const uiResource = createGoalTodosUIResource(state.getGoal(), state.listTodos());
      return normalizeToolResultWithUI(result, 'create_goal', uiResource);
    }

    case 'update_goal': {
      const result = state.updateGoal(
        typedArgs.updates as Partial<Pick<Goal, 'name' | 'description' | 'status'>>,
      );
      const uiResource = createGoalTodosUIResource(state.getGoal(), state.listTodos());
      return normalizeToolResultWithUI(result, 'update_goal', uiResource);
    }

    case 'add_todo': {
      const result = state.addTodo(
        typedArgs.name as string,
        typedArgs.description as string,
      );
      const uiResource = createGoalTodosUIResource(state.getGoal(), state.listTodos());
      return normalizeToolResultWithUI(result, 'add_todo', uiResource);
    }

    case 'update_todo': {
      const result = state.updateTodo(
        typedArgs.todoId as number,
        typedArgs.updates as Partial<Pick<Todo, 'name' | 'description' | 'status'>>,
      );
      const uiResource = createGoalTodosUIResource(state.getGoal(), state.listTodos());
      return normalizeToolResultWithUI(result, 'update_todo', uiResource);
    }

    // 기존 케이스들은 그대로 유지
    default:
      // ... 기존 로직
  }
}
```

## 재사용 가능한 연관 코드

### 관련 파일 및 인터페이스

1. **핵심 파일:**
   - `src/lib/web-mcp/modules/planning-server.ts` - 메인 수정 대상
   - `src/lib/mcp-types.ts` - MCPResponse, UIResource 타입 정의

2. **의존성:**
   - `@mcp-ui/server` - createUIResource 함수
   - `@mcp-ui/server/types` - UIResource, CreateUIResourceOptions 타입

3. **재사용 가능한 패턴:**
   - `normalizeToolResultWithUI` 함수는 다른 MCP 서버에서도 활용 가능
   - HTML 생성 패턴은 다른 상태 표시 UI에서 재사용 가능

### 주요 인터페이스

```typescript
// @mcp-ui/server에서 제공
interface CreateUIResourceOptions {
  uri: `ui://${string}`;
  content: {
    type: 'rawHtml';
    htmlString: string;
  };
  encoding: 'text' | 'blob';
}

// 현재 시스템의 UIResource (호환됨)
interface UIResource {
  uri?: string;
  mimeType: string;
  text?: string;
  blob?: string;
  title?: string;
  annotations?: Record<string, unknown>;
}
```

## 구현 단계

1. **Phase 1:** Import 및 헬퍼 함수 추가
2. **Phase 2:** normalizeToolResultWithUI 함수 구현
3. **Phase 3:** callTool 메서드의 해당 케이스들 수정
4. **Phase 4:** 테스트 및 검증

이 계획은 기존 코드 구조와 패턴을 최대한 유지하면서도 MCP-UI 표준을 준수하는 UIResource 통합을 제공합니다.
