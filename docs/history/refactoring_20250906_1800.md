# MCP Sampling ì‹œìŠ¤í…œ ë° UI Action ì²˜ë¦¬ êµ¬í˜„ ê³„íš

## ì‘ì—…ì˜ ëª©ì 

MCP (Model Context Protocol) ìŠ¤í™ì— ì¤€ìˆ˜í•˜ëŠ” ì˜¬ë°”ë¥¸ Sampling ì‹œìŠ¤í…œì„ êµ¬í˜„í•˜ê³ , MCP-UIì˜ UI Action ì²˜ë¦¬ë¥¼ ì™„ì„±í•˜ì—¬ AI ì—ì´ì „íŠ¸ê°€ ì‚¬ìš©ìì™€ ìƒí˜¸ì‘ìš©í•  ìˆ˜ ìˆëŠ” ì™„ì „í•œ í™˜ê²½ì„ êµ¬ì¶•í•œë‹¤.

### ì£¼ìš” ëª©í‘œ

1. **MCP Sampling ìŠ¤í™ ì¤€ìˆ˜**: ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ LLM ì¶”ë¡ ì„ ìš”ì²­í•˜ëŠ” ì˜¬ë°”ë¥¸ ë°©í–¥ êµ¬í˜„
2. **Tauri Events ê¸°ë°˜ í†µì‹ **: Backend â†’ Frontend ì´ë²¤íŠ¸ ì±„ë„ êµ¬ì¶•
3. **UI Action ì²˜ë¦¬ ì™„ì„±**: ëª¨ë“  MCP-UI ì•¡ì…˜ íƒ€ì…ì— ëŒ€í•œ ì™„ì „í•œ êµ¬í˜„
4. **ê¸°ì¡´ ì‹œìŠ¤í…œ í†µí•©**: í˜„ì¬ Chat/Tool ì‹œìŠ¤í…œê³¼ì˜ ì›í™œí•œ í†µí•©

---

## í˜„ì¬ì˜ ìƒíƒœ / ë¬¸ì œì 

### 1. **ì˜ëª»ëœ Sampling êµ¬í˜„**

```rust
// âŒ ì˜ëª»ëœ ë°©í–¥: í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì—ê²Œ sampling ìš”ì²­
pub async fn sample_from_model(&self, server_name: &str, request: SamplingRequest) -> MCPResponse
```

```typescript
// âŒ ì˜ëª»ëœ ë°©í–¥: í´ë¼ì´ì–¸íŠ¸ê°€ ì„œë²„ì—ê²Œ sampling ìš”ì²­
export async function sampleFromModel(
  serverName: string,
  prompt: string,
): Promise<SamplingResponse>;
```

**ë¬¸ì œì **: MCP ìŠ¤í™ì—ì„œëŠ” **ì„œë²„ê°€ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ** LLM ì¶”ë¡ ì„ ìš”ì²­í•´ì•¼ í•˜ëŠ”ë°, í˜„ì¬ëŠ” ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ êµ¬í˜„ë¨

### 2. **Backend â†’ Frontend í†µì‹  ì±„ë„ ë¶€ì¬**

- í˜„ì¬ëŠ” Frontend â†’ Backend í†µì‹ ë§Œ ê°€ëŠ¥ (Tauri commands)
- ì„œë²„ì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¡œ sampling ìš”ì²­ì„ ë³´ë‚¼ ë°©ë²•ì´ ì—†ìŒ

### 3. **ë¶ˆì™„ì „í•œ UI Action ì²˜ë¦¬**

```tsx
// í˜„ì¬ MessageRenderer.tsxì˜ handleUIAction
const handleUIAction = useCallback(
  async (result: UIActionResult) => {
    switch (result.type) {
      case 'tool':
        // ë¶€ë¶„ êµ¬í˜„ë¨ (await ëˆ„ë½)
        break;
      case 'intent':
      case 'prompt':
      case 'link':
      case 'notify':
        // ëª¨ë‘ ë¹ˆ ì¼€ì´ìŠ¤
        break;
    }
  },
  [executeToolCall],
);
```

### 4. **íƒ€ì… ì •ì˜ ë¶ˆì¼ì¹˜**

- í˜„ì¬ Sampling íƒ€ì…ì´ MCP ìŠ¤í™ê³¼ ë§ì§€ ì•ŠìŒ
- `sampling/createMessage` ìŠ¤í™ ë¯¸ì¤€ìˆ˜

---

## ì¶”ê°€ ë¶„ì„ ê³¼ì œ

### 1. **Tauri Events ì„±ëŠ¥ ë° ì•ˆì •ì„±**

- ëŒ€ëŸ‰ì˜ sampling ìš”ì²­ ì‹œ ì´ë²¤íŠ¸ ì‹œìŠ¤í…œ ì„±ëŠ¥ ê²€ì¦
- ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ ì‹œë‚˜ë¦¬ì˜¤ì—ì„œì˜ íƒ€ì„ì•„ì›ƒ ì²˜ë¦¬

### 2. **ë™ì‹œì„± ì œì–´ ë©”ì»¤ë‹ˆì¦˜**

- ì—¬ëŸ¬ MCP ì„œë²„ì—ì„œ ë™ì‹œì— sampling ìš”ì²­ì´ ì˜¬ ë•Œì˜ ì²˜ë¦¬ ë°©ì‹
- ê¸°ì¡´ ChatContextì˜ pending ìƒíƒœì™€ì˜ ì¶©ëŒ ë°©ì§€

### 3. **UI Action í™•ì¥ì„±**

- í–¥í›„ ì¶”ê°€ë  ìˆ˜ ìˆëŠ” ìƒˆë¡œìš´ ì•¡ì…˜ íƒ€ì…ì— ëŒ€í•œ í™•ì¥ êµ¬ì¡°
- ì‚¬ìš©ì ì •ì˜ ì•¡ì…˜ ì²˜ë¦¬ ë°©ì•ˆ

---

## ë³€ê²½ ì´í›„ì˜ ìƒíƒœ / í•´ê²° íŒì • ê¸°ì¤€

### 1. **ì˜¬ë°”ë¥¸ MCP Sampling í”Œë¡œìš° êµ¬í˜„**

```
âœ… MCP Server â†’ (sampling request) â†’ SynapticFlow Client â†’ LLM â†’ (response) â†’ MCP Server
```

**íŒì • ê¸°ì¤€**:

- Rust Builtin MCP ì„œë²„ì—ì„œ sampling ìš”ì²­ ê°€ëŠ¥
- Web Worker MCP ì„œë²„ì—ì„œ sampling ìš”ì²­ ê°€ëŠ¥
- ìš”ì²­ ID ê¸°ë°˜ ì •í™•í•œ ì‘ë‹µ ë§¤ì¹­

### 2. **ì™„ì „í•œ UI Action ì²˜ë¦¬**

**íŒì • ê¸°ì¤€**:

- `tool`: MCP ë„êµ¬ í˜¸ì¶œ ì‹¤í–‰
- `intent`: ìì—°ì–´ë¡œ ë³€í™˜í•˜ì—¬ AIì—ê²Œ ì „ë‹¬
- `prompt`: ìƒˆë¡œìš´ ì‚¬ìš©ì ë©”ì‹œì§€ ìƒì„±
- `link`: ì™¸ë¶€ ë§í¬ ì—´ê¸°
- `notify`: ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ

### 3. **í†µí•©ëœ í†µì‹  ì‹œìŠ¤í…œ**

**íŒì • ê¸°ì¤€**:

- Frontend â†’ Backend (ê¸°ì¡´ Tauri commands)
- Backend â†’ Frontend (ìƒˆë¡œìš´ Tauri events)
- ì–‘ë°©í–¥ í†µì‹ ì˜ ì•ˆì •ì„± í™•ë³´

---

## ìˆ˜ì •ì´ í•„ìš”í•œ ì½”ë“œ ë° ìˆ˜ì •ë¶€ë¶„

### Phase 1: ì˜ëª»ëœ êµ¬í˜„ ì œê±°

#### 1.1 Rust Backend ì •ë¦¬

```rust
// src-tauri/src/lib.rs - ì‚­ì œí•  ë¶€ë¶„
#[tauri::command]
async fn sample_from_mcp_server(
    server_name: String,
    prompt: String,
    options: Option<serde_json::Value>,
) -> Result<MCPResponse, String> {
    // ì „ì²´ í•¨ìˆ˜ ì‚­ì œ
}
```

```rust
// src-tauri/src/mcp/server.rs - ì‚­ì œí•  ë¶€ë¶„
impl MCPServerManager {
    pub async fn sample_from_model(
        &self,
        server_name: &str,
        request: SamplingRequest,
    ) -> MCPResponse {
        // ì „ì²´ ë©”ì„œë“œ ì‚­ì œ
    }
}
```

#### 1.2 Frontend ì •ë¦¬

```typescript
// src/lib/rust-backend-client.ts - ì‚­ì œí•  ë¶€ë¶„
export async function sampleFromModel(
  serverName: string,
  prompt: string,
  options?: SamplingOptions,
): Promise<SamplingResponse> {
  // ì „ì²´ í•¨ìˆ˜ ì‚­ì œ
}
```

```typescript
// src/context/MCPServerContext.tsx - ì‚­ì œí•  ë¶€ë¶„
sampleFromModel: (
  serverName: string,
  prompt: string,
  options?: SamplingOptions,
) => Promise<SamplingResponse>;
```

### Phase 2: ì˜¬ë°”ë¥¸ íƒ€ì… ì •ì˜

#### 2.1 MCP ìŠ¤í™ ì¤€ìˆ˜ íƒ€ì…

```typescript
// src/lib/mcp-types.ts - ì¶”ê°€í•  ë¶€ë¶„
export interface SamplingRequestEvent {
  requestId: string;
  serverName: string;
  method: 'sampling/createMessage';
  params: {
    messages: SamplingMessage[];
    modelPreferences?: ModelPreferences;
    systemPrompt?: string;
    includeContext?: 'none' | 'thisServer' | 'allServers';
    temperature?: number;
    maxTokens?: number;
    stopSequences?: string[];
  };
}

export interface SamplingMessage {
  role: 'user' | 'assistant' | 'system';
  content: ContentBlock[];
}
```

### Phase 3: Tauri Events êµ¬í˜„

#### 3.1 Backend ì´ë²¤íŠ¸ ë°œì†¡

```rust
// src-tauri/src/mcp/server.rs - ì¶”ê°€í•  ë¶€ë¶„
impl MCPServerManager {
    pub async fn request_sampling(
        &self,
        app_handle: &AppHandle,
        server_name: &str,
        request: SamplingRequestEvent,
    ) -> Result<SamplingResponse, String> {
        let request_id = Uuid::new_v4().to_string();

        // Frontendë¡œ sampling ìš”ì²­ ì´ë²¤íŠ¸ ì „ì†¡
        app_handle.emit("mcp-sampling-request", &request)
            .map_err(|e| format!("Failed to emit sampling request: {e}"))?;

        // ì‘ë‹µ ëŒ€ê¸° ë¡œì§
        // ...
    }
}
```

#### 3.2 Frontend ì´ë²¤íŠ¸ ì²˜ë¦¬

```typescript
// src/hooks/use-mcp-sampling.ts - ìƒˆ íŒŒì¼
export const useMCPSampling = () => {
  const { submit } = useChatContext();

  useEffect(() => {
    const unlisten = listen('mcp-sampling-request', async (event) => {
      const samplingRequest = event.payload as SamplingRequestEvent;
      // LLM í˜¸ì¶œ ë° ì‘ë‹µ ì²˜ë¦¬
      const response = await handleSamplingRequest(samplingRequest);
      await invoke('respond_to_sampling', {
        requestId: samplingRequest.requestId,
        response,
      });
    });

    return () => unlisten.then((fn) => fn());
  }, []);
};
```

### Phase 4: UI Action ì™„ì„±

```tsx
// src/components/MessageRenderer.tsx - ìˆ˜ì •í•  ë¶€ë¶„
const handleUIAction = useCallback(
  async (result: UIActionResult) => {
    logger.debug('UI action received', {
      type: result.type,
      payload: result.payload,
    });

    switch (result.type) {
      case 'tool': {
        try {
          await executeToolCall({
            id: createId(),
            type: 'function',
            function: {
              name: result.payload.toolName,
              arguments: JSON.stringify(result.payload.params),
            },
          });
        } catch (error) {
          logger.error('Tool call failed', { error });
        }
        break;
      }

      case 'intent': {
        const intentMessage: Message = {
          id: createId(),
          role: 'user',
          content: stringToMCPContentArray(
            `User intent: ${result.payload.intent}`,
          ),
          sessionId: currentSession?.id || '',
        };
        await submit([intentMessage]);
        break;
      }

      case 'prompt': {
        const userMessage: Message = {
          id: createId(),
          role: 'user',
          content: stringToMCPContentArray(result.payload.prompt),
          sessionId: currentSession?.id || '',
        };
        await submit([userMessage]);
        break;
      }

      case 'link': {
        await handleLinkClick(
          new MouseEvent('click') as React.MouseEvent,
          result.payload.url,
        );
        break;
      }

      case 'notify': {
        // ì•Œë¦¼ì„ ì‹œìŠ¤í…œ ë©”ì‹œì§€ë¡œ ì¶”ê°€
        addMessage({
          id: createId(),
          role: 'system',
          content: stringToMCPContentArray(`ğŸ”” ${result.payload.message}`),
          sessionId: currentSession?.id || '',
        });
        break;
      }
    }
  },
  [executeToolCall, submit, handleLinkClick, addMessage, currentSession],
);
```

---

## ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ê´€ ì½”ë“œ

### 1. **ê¸°ì¡´ Chat ì‹œìŠ¤í…œ**

- **íŒŒì¼**: `src/context/ChatContext.tsx`
- **ì£¼ìš” ê¸°ëŠ¥**: ë©”ì‹œì§€ í ê´€ë¦¬, pending ìƒíƒœ ì œì–´
- **ì¸í„°í˜ì´ìŠ¤**: `submit()`, `addToMessageQueue()`, `handleUIAction()`

### 2. **Unified MCP ì‹œìŠ¤í…œ**

- **íŒŒì¼**: `src/hooks/use-unified-mcp.ts`
- **ì£¼ìš” ê¸°ëŠ¥**: ë‹¤ì¤‘ MCP ë°±ì—”ë“œ í†µí•© ê´€ë¦¬
- **ì¸í„°í˜ì´ìŠ¤**: `executeToolCall()`, ë„êµ¬ íƒ€ì… resolution

### 3. **AI Service ì‹œìŠ¤í…œ**

- **íŒŒì¼**: `src/hooks/use-ai-service.ts`
- **ì£¼ìš” ê¸°ëŠ¥**: LLM í†µì‹  ë° ìŠ¤íŠ¸ë¦¬ë° ì²˜ë¦¬
- **ì¸í„°í˜ì´ìŠ¤**: `submit(messages, systemPrompt)`

### 4. **ê¸°ì¡´ Tauri Commands**

- **íŒŒì¼**: `src-tauri/src/lib.rs`
- **ì£¼ìš” ê¸°ëŠ¥**: Frontend-Backend í†µì‹  íŒ¨í„´
- **ì¬ì‚¬ìš© íŒ¨í„´**: `#[tauri::command]`, ì—ëŸ¬ ì²˜ë¦¬

### 5. **MCP íƒ€ì… ì‹œìŠ¤í…œ**

- **íŒŒì¼**: `src/lib/mcp-types.ts`, `src-tauri/src/mcp/types.rs`
- **ì£¼ìš” ê¸°ëŠ¥**: MCP í”„ë¡œí† ì½œ íƒ€ì… ì •ì˜
- **í™•ì¥ í¬ì¸íŠ¸**: ìƒˆë¡œìš´ sampling íƒ€ì… ì¶”ê°€

### 6. **ë¸Œë¼ìš°ì € ì„œë¹„ìŠ¤ ì°¸ì¡°**

- **íŒŒì¼**: `src-tauri/src/services/interactive_browser_server.rs`
- **ì£¼ìš” ê¸°ëŠ¥**: AppHandle ì‚¬ìš© íŒ¨í„´, ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
- **ì¬ì‚¬ìš© íŒ¨í„´**: Tauri window/event ê´€ë¦¬

---

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

1. **High Priority**: ì˜ëª»ëœ êµ¬í˜„ ì œê±° ë° íƒ€ì… ì •ì˜ (Phase 1, 2)
2. **Medium Priority**: Tauri Events ê¸°ë°˜ í†µì‹  êµ¬í˜„ (Phase 3)
3. **Medium Priority**: UI Action ì²˜ë¦¬ ì™„ì„± (Phase 4)
4. **Low Priority**: í†µí•© í…ŒìŠ¤íŠ¸ ë° ìµœì í™”

ì´ ê³„íšì„ í†µí•´ MCP ìŠ¤í™ì„ ì¤€ìˆ˜í•˜ëŠ” ì™„ì „í•œ Sampling ì‹œìŠ¤í…œê³¼ UI ìƒí˜¸ì‘ìš© ê¸°ëŠ¥ì„ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.
