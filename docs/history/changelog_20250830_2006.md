# Changelog: 2025-08-30 20:06

## Overview

This update delivers a comprehensive overhaul of the file attachment and content storage system, addressing multiple critical bugs related to race conditions, UI state inconsistency, and data duplication. The system is now significantly more robust, reliable, and predictable, especially when handling multiple files and rapid session changes.

## Key Changes by File

### 1. `src/context/ResourceAttachmentContext.tsx`

- **State Management Rearchitecture**:
  - Introduced two distinct states for file attachments:
    - `pendingFiles`: Tracks files that are currently being uploaded but are not yet confirmed by a user action (e.g., sending a message). This provides immediate UI feedback.
    - `sessionFiles`: Represents the single source of truth for files that have been successfully stored and are associated with the current session.
- **Race Condition Prevention**:
  - Implemented an `isFileOperationInProgress` flag to prevent session-change-triggered data refreshes from colliding with ongoing file uploads or deletions.
- **Batch Uploads**:
  - Added an `addFilesBatch` function to process multiple file drops as a single transaction, avoiding race conditions where multiple state refreshes would overwrite each other.
- **Scoped Duplicate Prevention**:
  - Replaced the global filename-based duplicate check with a `Map<storeId, Set<string>>` to prevent duplicate uploads only *within the same session*, allowing the same file to be attached to different sessions.

### 2. `src/lib/web-mcp/modules/content-store.ts` & `src/lib/db.ts`

- **Content De-duplication**:
  - Implemented a content-hashing mechanism (`content-hash.ts`) to identify and prevent duplicate file content *within the same storeId*.
  - The database schema was upgraded to version 6, adding a `contentHash` field and a `[storeId+contentHash]` compound index to `fileContents` for efficient duplicate lookups.
- **Graceful Error Handling**:
  - The `getServiceContext` function now handles transient "Invalid sessionId" errors gracefully during session transitions by logging at a `debug` level instead of `error`.

### 3. `src/features/chat/Chat.tsx`

- **UI State Correction**:
  - The chat attachment list (`ChatAttachedFiles`) now correctly displays `pendingFiles`, ensuring the list only shows newly-added files that are part of the current message composition.
  - The file drop handler (`processFileDrop`) was refactored to use the new `addFilesBatch` function, improving reliability for multi-file drops.
- **Improved Cleanup Logic**:
  - Submitting a message now calls `clearPendingFiles` instead of `clearFiles`, correctly removing only the in-flight attachments from the UI while preserving the already-saved `sessionFiles`.

### 4. `src/features/tools/index.tsx`

- **Session Transition Safety**:
  - Added a validation check to ensure a `currentSession.id` exists before attempting to fetch service contexts, preventing errors during rapid session switching.

## Potential Issues & Suggestions

- **Outdated Error Message**: The error message in `ResourceAttachmentContext.tsx` for duplicate files still implies that duplicates are checked globally ("This file content has already been uploaded in another session"). This should be updated to reflect the new per-session de-duplication logic to avoid user confusion.

## Conclusion

This was a critical and well-executed refactoring. It resolves complex state management and race condition issues, leading to a much more stable and intuitive user experience for file attachments. The introduction of content hashing and batch processing establishes a solid foundation for future enhancements.
