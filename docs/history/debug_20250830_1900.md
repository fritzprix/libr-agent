# Debug Plan: 파일 첨부 UI 미반영 및 세션 동기화 문제 (sessionId 에러 포함)

## 문제의 발생 경로

1. 사용자가 파일을 Drag & Drop하여 첨부
2. 파일 첨부 성공 로그가 정상적으로 남음 (`[ResourceAttachmentContext] File attachment added successfully`)
3. 첨부 직후 세션(storeId)이 변경됨 (`[SessionHistoryContext] current session`)
4. 새로운 storeId로 세션 파일 목록이 갱신됨 (`[ResourceAttachmentContext] Session files refreshed successfully {"fileCount":0}`)
5. UI에서 파일 첨부 리스트/상단 파일함 모두 비어 있음 (fileCount: 0)
6. getServiceContext에서 Invalid sessionId 에러 발생 (`[Error] [content-store][ERROR] Invalid sessionId in getServiceContext`)

## 해결 이후 상태

- 파일 첨부 시 UI에 즉시 반영되어 첨부 파일이 표시됨
- SessionFilesPopover에서 실제 첨부 파일 개수가 정확하게 표시됨
- getServiceContext에서 sessionId가 올바르게 전달되어 에러가 발생하지 않음
- 세션 변경 시 기존 첨부 파일이 유지되고 새로운 세션으로 이전됨
- 서버 응답과 UI 상태가 일치하여 fileCount가 정확하게 표시됨
- 파일 첨부/제거 시 실시간 UI 갱신 보장

## 관련 이슈에 대한 웹 검색 쿼리

- "React context state synchronization with async operations"
- "File upload state management in React multiple components"
- "React drag drop duplicate file handling"
- "Frontend state vs backend database consistency"
- "React context provider state persistence across session changes"
- "File attachment list synchronization React"
- "Invalid sessionId error in web applications"
- "Session management and state synchronization React"

## 문제의 원인에 대한 가설

### 가설 1: getServiceContext 호출 시 sessionId가 올바르게 전달되지 않음

**관련 코드 및 경로**: `src/lib/web-mcp/modules/content-store.ts` (getServiceContext 함수)

- getServiceContext 함수가 내부적으로 sessionId를 받아야 하는데, 전달된 값이 undefined 또는 올바르지 않은 객체임
- 이로 인해 content-store에서 파일 목록을 가져오지 못하고, refreshSessionFiles가 항상 빈 배열을 반환함
- 결과: UI에서 파일 첨부 리스트/상단 파일함 모두 비어 있음

### 가설 2: 세션(storeId) 변경 타이밍 문제

**관련 코드 및 경로**: `src/context/ResourceAttachmentContext.tsx` (refreshSessionFiles, 세션 변경 useEffect)

- 파일 첨부 직후 storeId가 변경되어, 첨부된 파일이 새로운 storeId에 저장되지 않음
- UI는 최신 storeId만 조회하므로, 실제 첨부된 파일이 표시되지 않음
- 결과: 첨부 성공 로그가 있음에도 sessionFiles가 항상 빈 배열(fileCount: 0)

### 가설 3: 서버 응답/DB 저장 문제

**관련 코드 및 경로**: `src/lib/web-mcp/modules/content-store.ts` (addContent, listContent 함수)

- 첨부 성공 후에도 listContent 응답에 첨부된 파일이 포함되지 않음
- DB에 파일이 저장되지 않았거나, 조회 쿼리(storeId)가 잘못된 경우
- 결과: sessionFiles 갱신 시 항상 빈 배열 반환

### 가설 4: ResourceAttachmentContext의 세션 동기화 문제

**관련 코드 및 경로**: `src/context/ResourceAttachmentContext.tsx` (useEffect, refreshSessionFiles)

- 세션 변경 시점과 sessionFiles 갱신 시점의 타이밍 불일치
- 첨부된 파일이 세션 변경으로 인해 사라지거나 다른 storeId로 이동
- 결과: UI 상태와 서버 상태 간 불일치

## 추가 분석 및 확인이 필요한 사항

1. getServiceContext 호출 시 sessionId 값 상세 로그 추가
2. 세션 변경 타이밍 로그 추가 (첨부 전후 storeId 비교)
3. 서버의 listContent 응답 내용 상세 로그
4. DB에 파일이 정상적으로 저장되는지 직접 확인
5. 중복 드롭 이벤트 발생 빈도 및 원인 분석
6. 파일 첨부 성공 후 sessionFiles 갱신 결과 로그
7. storeId 일관성 검증 (첨부 시점 vs 조회 시점)
8. 세션 변경이 파일 첨부에 미치는 영향 분석

## Debugging History Section

### 가설 탐색 기록 원칙

- 각 가설에 대해 변경을 시도할 때마다 이 섹션에 기록
- 기록 형식: 가설 → 변경 상세 내역 → 해결 여부 → 결과 분석 및 새로운 탐색 방향
- 변경 시도 전/후의 코드 스니핏 포함
- 로그 및 테스트 결과 첨부

#### 기록 예시 템플릿

```markdown
가설 [번호]: [가설 내용]

**변경 상세 내역**
- 파일: [파일 경로]
- 변경 부분: [구체적인 코드 라인/함수]
- 변경 내용: [무엇을 어떻게 변경했는지 상세 설명]

**해결 여부**: [해결됨/부분 해결/미해결]

**결과 분석 및 새로운 탐색 방향**
- [변경 결과에 대한 분석]
- [새로운 가설이나 추가 분석 방향]
- [관련 로그/스크린샷 첨부]
```

## Debugging History Section

### 가설 1: getServiceContext 호출 시 sessionId가 올바르게 전달되지 않음

**변경 상세 내역**
- 파일: `src/features/tools/index.tsx`, `src/lib/web-mcp/modules/content-store.ts`
- 변경 부분: 
  1. Line 248-271: buildToolPrompt 함수에서 sessionId 유효성 체크 추가
  2. Line 983-987: getServiceContext 에러를 debug 레벨로 변경

**문제점 확인**:
1. 파일 첨부 시 `ensureStoreExists()`가 `updateSession()` 호출
2. 세션 업데이트 중 `buildToolPrompt()`가 실행되어 `getServiceContext` 호출
3. 세션 전환 중 `getCurrentSession()`이 null 또는 id 없는 세션 반환
4. `sessionId: undefined`로 `getServiceContext` 호출 → "Invalid sessionId" 에러 발생
5. 결과: 파일 첨부 성공했으나 에러 로그 발생 및 UI 상태 불일치

**해결 여부**: 해결됨

**변경 내용**:
1. **조건부 Service Context 호출**: `currentSession?.id`가 유효할 때만 `getServiceContext` 호출
2. **그레이스풀 에러 처리**: 에러 로그를 debug 레벨로 변경하여 정상적인 상황으로 간주
3. **명확한 디버그 로그**: 세션이 없을 때 스킵한다는 로그 추가
4. **반환 메시지 개선**: 더 사용자 친화적인 메시지로 변경

**결과 분석**:
- 세션 전환 중 race condition 해결
- 불필요한 에러 로그 제거
- Service context는 세션이 안정화된 후 정상 호출됨
- Lint 및 Build 성공, Content Store 테스트 통과

### 최종 해결 사항

**구현된 수정사항**:
1. **Session Validation**: 유효한 세션이 있을 때만 service context 호출
2. **Graceful Degradation**: 세션 없을 때 기본값 반환 (에러가 아닌 정상 동작)
3. **로그 레벨 최적화**: 임시적인 세션 부재를 debug로 처리
4. **UI 일관성**: 세션 전환 중에도 안정적인 동작 보장

**테스트 결과**:
- Lint 검사 통과
- Build 성공 (6.22s)
- Content Store 중복 처리 테스트 통과 (4개 테스트 모두 성공)

### 현재 상태

**✅ 해결 완료** - sessionId 전달 문제 및 세션 동기화 race condition 해결됨

**주요 개선점**:
- 세션 전환 중 안정적인 동작
- 불필요한 에러 로그 제거  
- Service context 호출 최적화
- UI와 서버 상태 일관성 향상
