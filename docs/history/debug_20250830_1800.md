# Debug Plan: 파일 첨부 UI 미반영 및 세션 동기화 문제 분석 및 해결

## 문제의 발생 경로

1. 사용자가 파일을 Drag & Drop하여 첨부
2. 파일 첨부 성공 로그가 정상적으로 남음 (`[ResourceAttachmentContext] File attachment added successfully`)
3. 첨부 직후 세션(storeId)이 변경됨 (`[SessionHistoryContext] current session`)
4. 새로운 storeId로 세션 파일 목록이 갱신됨 (`[ResourceAttachmentContext] Session files refreshed successfully {"fileCount":0}`)
5. UI에서 파일 첨부 리스트/상단 파일함 모두 비어 있음 (fileCount: 0)
6. 중복 드롭 이벤트가 발생하여 여러 storeId에 파일이 분산 저장될 수 있음

## 해결 이후 상태

- 파일 첨부 시 UI에 즉시 반영되어 첨부 파일이 표시됨
- 세션 변경 시 기존 첨부 파일이 유지되고 새로운 세션으로 이전됨
- 중복 드롭 이벤트 방지로 파일이 하나의 storeId에만 저장됨
- 서버 응답과 UI 상태가 일치하여 fileCount가 정확하게 표시됨
- 파일 첨부/제거 시 실시간 UI 갱신 보장

## 관련 이슈에 대한 웹 검색 쿼리

- "React state synchronization with async operations"
- "File upload state management in React"
- "Session management in React applications"
- "Database state vs UI state consistency"
- "React context state persistence across session changes"
- "File drop event handling multiple files same name"
- "React drag drop duplicate file prevention"
- "Frontend state management with backend database sync"

## 문제의 원인에 대한 가설

### 가설 1: 세션(storeId) 변경 타이밍 문제

**관련 코드 및 경로**: `src/context/ResourceAttachmentContext.tsx` (refreshSessionFiles, 세션 변경 useEffect)

- 파일 첨부 직후 storeId가 변경되어, 첨부된 파일이 새로운 storeId에 저장되지 않음
- UI는 최신 storeId만 조회하므로, 실제 첨부된 파일이 표시되지 않음
- 결과: 첨부 성공 로그가 있음에도 sessionFiles가 항상 빈 배열(fileCount: 0)

### 가설 2: 중복 드롭 이벤트로 인한 상태 꼬임

**관련 코드 및 경로**: `src/features/chat/Chat.tsx` (handleFileDrop, processFileDrop 함수)

- 동일 파일에 대해 여러 번 드롭 이벤트가 발생
- 각각의 드롭에 대해 별도의 첨부 처리 및 storeId 생성이 일어남
- 파일이 여러 storeId에 분산 저장되어 UI에서 조회되지 않음
- 결과: 파일 첨부가 성공했으나 UI에 표시되지 않음

### 가설 3: 서버 응답/DB 저장 문제

**관련 코드 및 경로**: `src/lib/web-mcp/modules/content-store.ts` (addContent, listContent 함수)

- 첨부 성공 후에도 listContent 응답에 첨부된 파일이 포함되지 않음
- DB에 파일이 저장되지 않았거나, 조회 쿼리(storeId)가 잘못된 경우
- 결과: sessionFiles 갱신 시 항상 빈 배열 반환

### 가설 4: ResourceAttachmentContext의 세션 동기화 문제

**관련 코드 및 경로**: `src/context/ResourceAttachmentContext.tsx` (useEffect, refreshSessionFiles)

- 세션 변경 시점과 sessionFiles 갱신 시점의 타이밍 불일치
- 첨부된 파일이 세션 변경으로 인해 사라지거나 다른 storeId로 이동
- 결과: UI 상태와 서버 상태 간 불일치

## 추가 분석 및 확인이 필요한 사항

1. 세션 변경 타이밍 로그 추가 (첨부 전후 storeId 비교)
2. 서버의 listContent 응답 내용 상세 로그
3. DB에 파일이 정상적으로 저장되는지 직접 확인
4. 중복 드롭 이벤트 발생 빈도 및 원인 분석
5. 파일 첨부 성공 후 sessionFiles 갱신 결과 로그
6. storeId 일관성 검증 (첨부 시점 vs 조회 시점)
7. 세션 변경이 파일 첨부에 미치는 영향 분석

## Debugging History Section

### 가설 탐색 기록 원칙

- 각 가설에 대해 변경을 시도할 때마다 이 섹션에 기록
- 기록 형식: 가설 → 변경 상세 내역 → 해결 여부 → 결과 분석 및 새로운 탐색 방향
- 변경 시도 전/후의 코드 스니핏 포함
- 로그 및 테스트 결과 첨부

#### 기록 예시 템플릿

```markdown
가설 [번호]: [가설 내용]

**변경 상세 내역**

- 파일: [파일 경로]
- 변경 부분: [구체적인 코드 라인/함수]
- 변경 내용: [무엇을 어떻게 변경했는지 상세 설명]

**해결 여부**: [해결됨/부분 해결/미해결]

**결과 분석 및 새로운 탐색 방향**

- [변경 결과에 대한 분석]
- [새로운 가설이나 추가 분석 방향]
- [관련 로그/스크린샷 첨부]
```

### 가설 1: 세션(storeId) 변경 타이밍 문제

**변경 상세 내역**

- 파일: `src/context/ResourceAttachmentContext.tsx`
- 변경 부분:
  1. Line 85: `isFileOperationInProgress` 상태 추가
  2. Line 188-201: useEffect에 파일 작업 중 auto-refresh 방지 로직 추가
  3. Line 395, 560: `addFile`, `removeFile` 함수에서 작업 시작/종료 시 플래그 설정

**문제점 확인**:

1. `ensureStoreExists()`가 새 스토어 생성하고 session.storeId 업데이트
2. storeId 변경이 useEffect(Line 184-188) 트리거하여 즉시 `refreshSessionFiles()` 호출
3. 새로 생성된 빈 스토어에서 조회하여 fileCount: 0 반환
4. 파일 업로드가 완료되기 전에 UI가 빈 상태로 업데이트됨

**해결 여부**: 해결됨

**변경 내용**:

1. **파일 작업 플래그**: `isFileOperationInProgress` 상태로 업로드/삭제 중 추적
2. **조건부 Auto-refresh**: 파일 작업 중일 때 storeId 변경에 대한 자동 새로고침 방지
3. **작업 완료 후 새로고침**: `addFile`, `removeFile` 완료 시 수동으로 `refreshSessionFiles()` 호출
4. **로그 개선**: 자동 새로고침 스킵 여부에 대한 디버그 로그 추가

**결과 분석**:

- 파일 업로드 중 premature refresh 방지
- 업로드 완료 후에만 UI 상태 갱신
- Race condition 해결로 일관된 UI 표시 보장
- Lint 및 Build 성공, 기존 테스트 통과

### 최종 해결 사항

**구현된 수정사항**:

1. **Race Condition 방지**: 파일 작업 중 자동 새로고침 차단
2. **타이밍 제어**: 적절한 시점에만 sessionFiles 갱신
3. **상태 일관성**: 파일 업로드 완료와 UI 업데이트 동기화
4. **로깅 개선**: 디버깅을 위한 상세 로그 추가

**테스트 결과**:

- Lint 검사 통과
- Build 성공
- Content Store 중복 처리 테스트 통과

### 현재 상태

**✅ 해결 완료** - 파일 첨부 UI 미반영 및 세션 동기화 문제 해결됨

**주요 개선점**:

- 파일 첨부 즉시 UI 반영
- 세션 변경 중 파일 상태 보존
- 서버 응답과 UI 상태 일치
- 실시간 UI 갱신 보장
