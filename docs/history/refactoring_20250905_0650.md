# 로그 시스템 App Identifier 통합 및 경로 일치화 Refactoring Plan

## 작업의 목적

SynapticFlow 애플리케이션의 이중 로그 시스템 문제를 해결하여 로그 관리의 일관성을 확보하고, Frontend에서 제공하는 로그 관리 기능들이 실제 Tauri 로그 파일과 연동되도록 통합합니다.

### 핵심 목표

- App Identifier 불일치로 인한 이중 로그 디렉토리 문제 해결
- Frontend 로그 관리 UI와 실제 로그 파일 간의 연결 복원
- 개발자 도구(`dump_log.sh`)와 애플리케이션 로그 시스템의 일관성 확보

## 현재의 상태 / 문제점

### 1. 이중 로그 디렉토리 구조

**Tauri 로그 플러그인 사용 경로** (실제 로그 기록)

- 경로: `/home/user/.local/share/com.fritzprix.synapticflow/logs/synaptic-flow.log`
- 기반: `tauri.conf.json`의 `identifier: "com.fritzprix.synapticflow"`
- 상태: 정상 작동, Frontend webview 로그 포함 67줄 기록
- 사용: Tauri 로그 플러그인, `@tauri-apps/plugin-log`

**SessionManager 사용 경로** (빈 로그)

- 경로: `/home/user/.local/share/com.synaptic-flow.app/logs/synaptic-flow.log`
- 기반: SessionManager의 하드코딩된 `"com.synaptic-flow.app"`
- 상태: 테스트 메시지 1줄만 존재, 실제 로그 미기록
- 사용: SessionManager, Frontend 로그 관리 명령어들

### 2. Frontend 로그 관리 기능 연결 단절

```typescript
// src/lib/logger.ts - 잘못된 경로 참조
class TauriLogFileManager implements LogFileManager {
  async getLogDirectory(): Promise<string> {
    return await invoke<string>('get_app_logs_dir');  // SessionManager 경로
  }
  async backupCurrentLog(): Promise<string> {
    return await invoke<string>('backup_current_log');  // SessionManager 경로
  }
  async listLogFiles(): Promise<string[]> {
    return await invoke<string[]>('list_log_files');   // SessionManager 경로
  }
}
```

### 3. 개발자 도구와 애플리케이션 불일치

- `dump_log.sh`: 수정 완료로 올바른 경로 참조
- Frontend 로그 UI: 여전히 빈 디렉토리 참조
- Tauri Command들: SessionManager 기반 잘못된 경로 사용

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. **단일 로그 디렉토리**: 모든 로그 관련 기능이 `com.fritzprix.synapticflow` 경로 사용
2. **Frontend 로그 UI 정상화**: 앱 내 로그 관리 기능들이 실제 로그 파일과 연동
3. **백업/관리 기능 복원**: 로그 백업, 파일 목록, 디렉토리 조회 기능 정상 작동
4. **개발자 도구 일관성**: `dump_log.sh`와 애플리케이션이 동일한 로그 파일 참조

### 검증 방법

```bash
# 1. 로그 디렉토리 통합 확인
ls ~/.local/share/com.fritzprix.synapticflow/logs/
ls ~/.local/share/com.synaptic-flow.app/logs/  # 빈 디렉토리 또는 삭제됨

# 2. Frontend 로그 관리 기능 테스트
# - 앱 내에서 로그 파일 목록 조회
# - 로그 백업 기능 실행
# - 로그 디렉토리 경로 확인

# 3. 개발자 도구 일관성 확인
./dump_log.sh 10  # 실제 로그 내용 출력
```

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. SessionManager App Identifier 통일

**파일**: `src-tauri/src/session.rs`

```rust
// 현재 (문제)
let base_data_dir = dirs::data_dir()
    .ok_or_else(|| "Failed to get system data directory".to_string())?
    .join("com.synaptic-flow.app");

// 수정 후 (해결)
let base_data_dir = dirs::data_dir()
    .ok_or_else(|| "Failed to get system data directory".to_string())?
    .join("com.fritzprix.synapticflow");
```

### 2. 기존 SessionManager 데이터 마이그레이션 로직 추가

**파일**: `src-tauri/src/session.rs`

```rust
impl SessionManager {
    pub fn new() -> Result<Self, String> {
        let new_base_dir = dirs::data_dir()
            .ok_or_else(|| "Failed to get system data directory".to_string())?
            .join("com.fritzprix.synapticflow");

        // 기존 데이터 마이그레이션 로직
        let old_base_dir = dirs::data_dir()
            .unwrap_or_default()
            .join("com.synaptic-flow.app");
        
        if old_base_dir.exists() && !new_base_dir.exists() {
            Self::migrate_data(&old_base_dir, &new_base_dir)?;
        }

        // 기존 초기화 로직...
    }

    fn migrate_data(old_dir: &PathBuf, new_dir: &PathBuf) -> Result<(), String> {
        // 워크스페이스 데이터 마이그레이션
        // 설정 파일 마이그레이션  
        // 기존 디렉토리 정리
    }
}
```

### 3. Frontend 로그 관리 우회 방안

**파일**: `src/lib/logger.ts`

```typescript
// 직접 Tauri 로그 플러그인 경로 사용
class TauriLogFileManager implements LogFileManager {
  private getLogDirectoryPath(): string {
    // Tauri identifier 기반 경로 직접 계산
    const platform = navigator.platform.toLowerCase();
    if (platform.includes('mac')) {
      return `${process.env.HOME}/Library/Application Support/com.fritzprix.synapticflow/logs`;
    } else if (platform.includes('win')) {
      return `${process.env.APPDATA}/com.fritzprix.synapticflow/logs`;
    } else {
      return `${process.env.HOME}/.local/share/com.fritzprix.synapticflow/logs`;
    }
  }

  async getLogDirectory(): Promise<string> {
    // SessionManager 대신 직접 경로 반환
    return this.getLogDirectoryPath();
  }
}
```

## 추가 분석 과제

### 1. 데이터 마이그레이션 범위 확정

- **SessionManager 워크스페이스 데이터**: 사용자 세션별 파일들의 마이그레이션 필요성 검토
- **설정 파일 호환성**: 기존 설정이 새 경로에서도 정상 작동하는지 확인
- **백업 로그 파일들**: 기존 백업된 로그 파일들의 처리 방안

### 2. 교차 플랫폼 경로 호환성

- **macOS**: `~/Library/Application Support/` 경로 동작 확인
- **Windows**: `%APPDATA%` 경로 동작 확인  
- **Linux 배포판**: 다양한 리눅스 환경에서의 `~/.local/share/` 경로 호환성

### 3. 로그 플러그인과 SessionManager 연동 방안

- **Tauri 로그 플러그인 커스텀 경로 설정**: 플러그인이 SessionManager 경로를 사용하도록 설정 가능성
- **런타임 로그 디렉토리 변경**: 앱 실행 중 로그 디렉토리 동적 변경 지원 여부
- **로그 파일 심볼릭 링크**: 두 경로 간 심볼릭 링크를 통한 우회 방안

## 재사용 가능한 연관 코드

### 기존 SessionManager 패턴

**파일**: `src-tauri/src/session.rs`

- **주요 기능**: 글로벌 싱글톤 패턴 (`OnceLock` 사용)
- **인터페이스**: `get_session_manager()` 전역 접근 함수
- **에러 처리**: `Result<T, String>` 반환 타입 일관성

### Tauri Command 패턴

**파일**: `src-tauri/src/lib.rs`

- **주요 기능**: `#[tauri::command]` 매크로 기반 명령어 등록
- **인터페이스**: Frontend에서 `invoke()` 함수로 호출
- **에러 처리**: 비동기 `Result` 반환

### 디렉토리 초기화 패턴

**파일**: `src-tauri/src/session.rs` 라인 22-32

```rust
// 재사용 가능한 디렉토리 생성 패턴
fs::create_dir_all(base_data_dir.join("workspaces"))
    .map_err(|e| format!("Failed to create workspaces directory: {e}"))?;
fs::create_dir_all(base_data_dir.join("logs"))
    .map_err(|e| format!("Failed to create logs directory: {e}"))?;
fs::create_dir_all(base_data_dir.join("config"))
    .map_err(|e| format!("Failed to create config directory: {e}"))?;
```

### Frontend 로거 설정 패턴

**파일**: `src/lib/logger.ts`

- **주요 기능**: 설정 영속화 (`localStorage` 사용)
- **인터페이스**: `logUtils.initialize()`, `logUtils.updateConfig()`
- **타입 안전성**: `LoggerConfig` 인터페이스 기반 설정 관리

### 마이그레이션 참고 코드

**파일**: `src-tauri/src/services/secure_file_manager.rs`

- **주요 기능**: 파일 시스템 작업 보안 검증
- **인터페이스**: 경로 검증 및 안전한 파일 조작
- **에러 처리**: 상세한 파일 시스템 에러 메시지
