# MCP Tool 결과 Resource 타입 렌더링 문제 해결

## 작업의 목적

MCP Tool 실행 결과에서 `resource` 타입의 콘텐츠(예: UIResource)가 Message 저장 및 UI 렌더링 과정에서 누락되어 사용자에게 표시되지 않는 문제를 해결합니다. 이를 통해 MCP Tool이 반환하는 다양한 콘텐츠 타입(text, resource, image, audio 등)이 모두 올바르게 저장되고 화면에 렌더링되도록 합니다.

## 현재의 상태 / 문제점

### 1. Tool 결과 저장 시 콘텐츠 손실

- **위치**: `src/context/ChatContext.tsx` 137-139줄 `normalizeContent()` 함수
- **문제**: MCPContent[] 배열에서 `text` 타입만 추출하고 `resource` 타입은 무시
- **결과**: UIResource, 이미지, 오디오 등이 Message.content에서 누락

```typescript
// 현재 문제 코드
const normalizeContent = (rawContent: unknown): string => {
  // ... text 타입만 필터링하고 나머지는 JSON.stringify()
  const textParts = rawContent.filter(
    (item): item is { type: string; text: string } =>
      (item as { type: unknown }).type === 'text',
  );
  // resource, image, audio 등은 무시됨!
};
```

};

### 2. UI 렌더링 체인은 정상 동작

- `MessageBubbleRouter` → `ToolOutputBubble` → `MessageRenderer` → `UIResourceRenderer`
- 단, Message.content에 MCPContent[]가 저장되어야 동작함

### 3. LLM 전달 시 불필요한 타입 포함

- 현재는 string으로 변환되어 문제없지만, MCPContent[] 저장 시 LLM에 불필요한 메타데이터 전달 가능성

## 추가 분석 과제

1. **메시지 전처리 최적화**: `prepareMessagesForLLM()` 함수에서 각 MCPContent 타입별 LLM 최적화 방안 검토
2. **확장 타입 지원**: mcp-full.md에 정의된 추가 콘텐츠 타입들(AudioContent, ImageContent 등)의 UI 렌더링 방식 설계
3. **성능 영향**: 대용량 이미지/오디오 데이터의 Message 저장이 IndexedDB 성능에 미치는 영향 분석

## 변경 이후의 상태 / 해결 판정 기준

### 성공 기준

1. **저장 완성도**: Tool 결과의 모든 MCPContent 타입이 Message.content에 보존됨
2. **UI 렌더링**: resource 타입 콘텐츠가 UIResourceRenderer를 통해 정상 표시됨
3. **LLM 호환성**: AI 서비스 호출 시 적절히 정규화된 텍스트만 전달됨
4. **확장성**: 새로운 MCPContent 타입 추가 시 최소한의 코드 변경으로 지원 가능

### 검증 방법

- Rubiks Cube 게임 링크와 같은 resource 타입 콘텐츠가 클릭 가능한 UI로 렌더링됨
- 메시지 히스토리에서 resource 콘텐츠가 유실되지 않음
- AI 서비스 호출 시 불필요한 메타데이터가 제거된 텍스트만 전달됨

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 1. ChatContext.tsx - Tool 결과 저장 방식 변경

**파일**: `src/context/ChatContext.tsx`
**수정 위치**: 137-139줄

```typescript
// 변경 전
const toolResultMessage: Message = {
  id: createId(),
  assistantId: currentAssistant?.id,
  role: 'tool',
  content: isMCPError(mcpResponse)
    ? `Error: ${mcpResponse.error.message} (Code: ${mcpResponse.error.code})`
    : normalizeContent(mcpResponse.result?.content), // 문제: string 변환
  tool_call_id: toolCall.id,
  sessionId: currentSession?.id || '',
};

// 변경 후
const toolResultMessage: Message = {
  id: createId(),
  assistantId: currentAssistant?.id,
  role: 'tool',
  content: isMCPError(mcpResponse)
    ? `Error: ${mcpResponse.error.message} (Code: ${mcpResponse.error.code})`
    : mcpResponse.result?.content, // MCPContent[] 그대로 저장
  tool_call_id: toolCall.id,
  sessionId: currentSession?.id || '',
};
```

### 2. use-ai-service.ts - LLM 전달용 정규화 추가

**파일**: `src/hooks/use-ai-service.ts`
**수정 위치**: prepareMessagesForLLM 호출 전

```typescript
// 추가할 함수
function normalizeContentForLLM(content: string | MCPContent[]): string {
  if (typeof content === 'string') return content;
  if (Array.isArray(content)) {
    return content
      .filter((item) => item.type === 'text')
      .map((item) => (item as { text: string }).text)
      .join('\n');
  }
  return '';
}

// 적용 위치 (54줄 근처)
const processedMessages = await prepareMessagesForLLM(
  messages.map((msg) => ({
    ...msg,
    content: normalizeContentForLLM(msg.content), // 정규화 적용
  })),
);
```

### 3. normalizeContent 함수 제거 또는 이름 변경

**파일**: `src/context/ChatContext.tsx`
**수정**: 114-132줄의 normalizeContent 함수를 제거하거나 다른 용도로 이름 변경

## 재사용 가능한 연관 코드

### 핵심 인터페이스 및 타입

- **MCPContent 타입**: `src/lib/mcp-types.ts` (75-135줄)
  - MCPTextContent, MCPResourceContent, MCPImageContent, MCPAudioContent
- **Message 인터페이스**: `src/models/chat.ts` (29-42줄)
  - content: string | MCPContent[] 타입 정의

### UI 렌더링 체인

- **MessageBubbleRouter**: `src/features/chat/MessageBubbleRouter.tsx`
  - role === 'tool' 시 ToolOutputBubble로 라우팅
- **ToolOutputBubble**: `src/features/chat/ToolOutputBubble.tsx`
  - MCPContent[] 처리 및 MessageRenderer 호출
- **MessageRenderer**: `src/components/MessageRenderer.tsx` (40-60줄)
  - 타입별 렌더링 분기 (text, resource, image, audio, resource_link)
- **UIResourceRenderer**: `src/components/ui/UIResourceRenderer.tsx`
  - mcp-ui 표준 준수 resource 렌더링

### 메시지 전처리

- **prepareMessagesForLLM**: `src/lib/message-preprocessor.ts` (64-87줄)
  - 첨부파일 메타데이터 추가 처리
  - MCPContent 정규화 로직 확장 지점

### MCP 통신

- **useUnifiedMCP**: `src/hooks/use-unified-mcp.ts`
  - executeToolCall 함수가 MCPContent[] 반환
- **MCP 타입 검증**: `src/lib/mcp-types.ts` (580-590줄)
  - isMCPError 함수 및 응답 검증 로직
