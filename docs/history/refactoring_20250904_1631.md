# Workspace Export ê¸°ëŠ¥ Tauri Command ë°©ì‹ ì „í™˜ Refactoring Plan

## ì‘ì—…ì˜ ëª©ì 

ê¸°ì¡´ Asset Protocol ê¸°ë°˜ export ê¸°ëŠ¥ì„ **Tauri Command ë°©ì‹**ìœ¼ë¡œ ì „í™˜í•˜ì—¬ MCP-UI iframeì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±ëœ íŒŒì¼ì„ ì•ˆì „í•˜ê³  í™•ì‹¤í•˜ê²Œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆë„ë¡ í•œë‹¤.

### í•µì‹¬ ëª©í‘œ

- **Tauri Command ê¸°ë°˜ ë‹¤ìš´ë¡œë“œ**: `window.__TAURI__.invoke()` í˜¸ì¶œë¡œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
- **MCP-UI í˜¸í™˜ì„±**: iframe ë‚´ postMessage í†µì‹ ìœ¼ë¡œ hostì™€ ìƒí˜¸ì‘ìš©
- **ë¸Œë¼ìš°ì € í‘œì¤€ í™œìš©**: íŒŒì¼ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ë¥¼ í†µí•œ ì‚¬ìš©ì ì¹œí™”ì  ë‹¤ìš´ë¡œë“œ
- **ë³´ì•ˆ ê°•í™”**: ì§ì ‘ íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ ëŒ€ì‹  ì œì–´ëœ Tauri command ì‚¬ìš©
- **Asset Protocol ì œì•½ í•´ê²°**: ì •ì  ë¦¬ì†ŒìŠ¤ ì œí•œì„ ìš°íšŒí•œ ë™ì  íŒŒì¼ ì„œë¹™

## í˜„ì¬ì˜ ìƒíƒœ / ë¬¸ì œì 

### 1. Asset Protocol ì œì•½ìœ¼ë¡œ ì¸í•œ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨

- **Tauri Asset Protocol í•œê³„**: `tauri://localhost/workspace/exports/packages/file.zip` í˜•íƒœì˜ URLì´ ë™ì‘í•˜ì§€ ì•ŠìŒ
- **ì •ì  vs ë™ì  ë¦¬ì†ŒìŠ¤**: Asset Protocolì€ ë¹Œë“œíƒ€ì„ ì •ì  ë¦¬ì†ŒìŠ¤ë§Œ ì§€ì›, ëŸ°íƒ€ì„ ìƒì„± íŒŒì¼ ë¶ˆê°€
- **Scope ë¶ˆì¼ì¹˜**: `tauri.conf.json`ì˜ `workspace/**` scopeê°€ ì‹¤ì œ ë™ì  ì„¸ì…˜ ë””ë ‰í† ë¦¬ì™€ ë§¤í•‘ë˜ì§€ ì•ŠìŒ
- **iframe ë³´ì•ˆ ì œì•½**: MCP-UI iframeì—ì„œ ì§ì ‘ì ì¸ íŒŒì¼ ì‹œìŠ¤í…œ ì ‘ê·¼ ë¶ˆê°€

### 2. í˜„ì¬ êµ¬í˜„ì˜ í•œê³„

- **HTML ë‹¤ìš´ë¡œë“œ ë§í¬**: `<a href="tauri://localhost/...">` ë°©ì‹ì´ "asset not found" ì—ëŸ¬ ë°œìƒ
- **ë¸Œë¼ìš°ì € í˜¸í™˜ì„±**: iframe ë‚´ì—ì„œ Tauri asset protocol ì ‘ê·¼ ì œí•œ
- **ì—ëŸ¬ ì²˜ë¦¬ ë¶€ì¡±**: ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì‚¬ìš©ì í”¼ë“œë°± ì—†ìŒ
- **ë³´ì•ˆ ê²€ì¦ ë¯¸í¡**: íŒŒì¼ ê²½ë¡œ ê²€ì¦ì´ Asset Protocolì— ì˜ì¡´

### 3. MCP-UI í†µì‹  êµ¬ì¡° ë¶€ì¬

- **postMessage í•¸ë“¤ëŸ¬ ì—†ìŒ**: iframeì—ì„œ hostë¡œì˜ í†µì‹  ì±„ë„ ë¶€ì¬
- **UI Action ì²˜ë¦¬ ëˆ„ë½**: MCP-UI í‘œì¤€ ì•¡ì…˜ ì²˜ë¦¬ ë¡œì§ ë¯¸êµ¬í˜„
- **ì–‘ë°©í–¥ í†µì‹  ë¶€ì¡±**: hostì—ì„œ iframeìœ¼ë¡œì˜ ê²°ê³¼ í”¼ë“œë°± ë©”ì»¤ë‹ˆì¦˜ ì—†ìŒ

## ì¶”ê°€ ë¶„ì„ ê³¼ì œ

### 1. Tauri File Dialog API í™œìš© ë°©ì•ˆ

- **tauri-plugin-dialog**: ë¸Œë¼ìš°ì € íŒŒì¼ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ ì—°ë™ ë°©ì‹
- **íŒŒì¼ ìŠ¤íŠ¸ë¦¬ë°**: ëŒ€ìš©ëŸ‰ íŒŒì¼ ì²˜ë¦¬ë¥¼ ìœ„í•œ ì²­í¬ ë‹¨ìœ„ ì „ì†¡ ë°©ì‹
- **Progress Callback**: ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë©”ì»¤ë‹ˆì¦˜

### 2. MCP-UI Action í‘œì¤€ ì¤€ìˆ˜

- **Tool Call Action**: iframeì—ì„œ ìƒˆë¡œìš´ MCP Tool í˜¸ì¶œ ë°©ì‹
- **Notification Action**: ë‹¤ìš´ë¡œë“œ ìƒíƒœ ì•Œë¦¼ í‘œì¤€í™”
- **Error Handling**: MCP-UI ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ ì¤€ìˆ˜

### 3. íŒŒì¼ ê´€ë¦¬ ì •ì±… ê°œì„ 

- **ì„ì‹œ íŒŒì¼ ì •ë¦¬**: ë‹¤ìš´ë¡œë“œ ì™„ë£Œ í›„ export íŒŒì¼ ìë™ ì •ë¦¬
- **ë™ì‹œ ë‹¤ìš´ë¡œë“œ**: ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ export ì‹œ ì¶©ëŒ ë°©ì§€
- **ê¶Œí•œ ê²€ì¦**: íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ ì‚¬ì „ ê²€ì¦ ì²´ê³„

## ë³€ê²½ ì´í›„ì˜ ìƒíƒœ / í•´ê²° íŒì • ê¸°ì¤€

### 1. Tauri Command ê¸°ë°˜ ë‹¤ìš´ë¡œë“œ ì‹œìŠ¤í…œ

- **download_workspace_file Command**: íŒŒì¼ ê²½ë¡œë¥¼ ë°›ì•„ ë¸Œë¼ìš°ì € ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
- **export_workspace_zip Command**: ZIP íŒŒì¼ ìƒì„± ë° ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ
- **íŒŒì¼ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸**: ì‚¬ìš©ìê°€ ì €ì¥ ìœ„ì¹˜ ì„ íƒ ê°€ëŠ¥
- **ì‹¤ì‹œê°„ í”¼ë“œë°±**: ë‹¤ìš´ë¡œë“œ ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ ì¦‰ì‹œ í‘œì‹œ

### 2. í–¥ìƒëœ MCP-UI í†µì‹ 

- **postMessage ê¸°ë°˜ í†µì‹ **: iframe â†” host ì–‘ë°©í–¥ í†µì‹  êµ¬í˜„
- **UI Action í‘œì¤€ ì¤€ìˆ˜**: MCP-UI ì•¡ì…˜ í˜•ì‹ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ ìš”ì²­
- **ì—ëŸ¬ í•¸ë“¤ë§**: ìƒì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€ì™€ ì¬ì‹œë„ ì˜µì…˜ ì œê³µ

### 3. ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

- **ì›í´ë¦­ ë‹¤ìš´ë¡œë“œ**: ë²„íŠ¼ í´ë¦­ ì¦‰ì‹œ íŒŒì¼ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
- **ì§„í–‰ ìƒíƒœ í‘œì‹œ**: íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ ì§„í–‰ë¥  ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
- **ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ì•Œë¦¼**: ì„±ê³µì ì¸ ë‹¤ìš´ë¡œë“œ í›„ í™•ì¸ ë©”ì‹œì§€

### 4. íŒì • ê¸°ì¤€

- [ ] `download_workspace_file` Tauri command êµ¬í˜„ ì™„ë£Œ
- [ ] MCP-UI iframeì—ì„œ postMessage í†µì‹  ë™ì‘
- [ ] ë¸Œë¼ìš°ì € íŒŒì¼ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ ì •ìƒ í‘œì‹œ
- [ ] export íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µë¥  100%
- [ ] ì—ëŸ¬ ë°œìƒ ì‹œ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ í‘œì‹œ
- [ ] ëŒ€ìš©ëŸ‰ ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì•ˆì •ì„± í™•ë³´

## ìˆ˜ì •ì´ í•„ìš”í•œ ì½”ë“œ ë° ìˆ˜ì •ë¶€ë¶„

### 1. Tauri Command ì¶”ê°€

**íŒŒì¼**: `src-tauri/src/lib.rs`

```rust
#[tauri::command]
async fn download_workspace_file(
    app_handle: tauri::AppHandle,
    file_path: String,
) -> Result<String, String> {
    use tauri::api::dialog::FileDialogBuilder;

    // SecureFileManagerë¥¼ í†µí•´ workspace ë””ë ‰í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
    let session_manager = get_session_manager();
    let file_manager = session_manager.get_file_manager();
    let workspace_dir = file_manager.base_dir();

    // ìš”ì²­ëœ íŒŒì¼ì˜ ì „ì²´ ê²½ë¡œ êµ¬ì„±
    let full_path = workspace_dir.join(&file_path);

    // íŒŒì¼ ì¡´ì¬ ë° ë³´ì•ˆ ê²€ì¦
    if !full_path.exists() {
        return Err(format!("File not found: {}", file_path));
    }

    if !full_path.starts_with(workspace_dir) {
        return Err("Access denied: Path outside workspace".to_string());
    }

    // íŒŒì¼ëª… ì¶”ì¶œ
    let file_name = full_path.file_name()
        .and_then(|name| name.to_str())
        .unwrap_or("download");

    // íŒŒì¼ ë‚´ìš© ì½ê¸°
    let file_content = match tokio::fs::read(&full_path).await {
        Ok(content) => content,
        Err(e) => return Err(format!("Failed to read file: {}", e)),
    };

    // íŒŒì¼ ì €ì¥ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ ë° ì €ì¥
    let save_result = std::sync::Arc::new(std::sync::Mutex::new(None));
    let save_result_clone = save_result.clone();

    FileDialogBuilder::new()
        .set_file_name(file_name)
        .save_file(move |save_path| {
            if let Some(save_path) = save_path {
                let result = std::fs::write(save_path, &file_content);
                *save_result_clone.lock().unwrap() = Some(result);
            }
        });

    // ê²°ê³¼ ëŒ€ê¸° (ê°„ë‹¨í•œ ë™ê¸°í™”)
    tokio::time::sleep(tokio::time::Duration::from_millis(100)).await;

    match save_result.lock().unwrap().as_ref() {
        Some(Ok(_)) => Ok("File downloaded successfully".to_string()),
        Some(Err(e)) => Err(format!("Failed to save file: {}", e)),
        None => Err("Download cancelled by user".to_string()),
    }
}

#[tauri::command]
async fn export_and_download_zip(
    app_handle: tauri::AppHandle,
    files: Vec<String>,
    package_name: String,
) -> Result<String, String> {
    // ZIP ìƒì„± ë¡œì§ (ê¸°ì¡´ handle_export_zip í™œìš©)
    // ìƒì„± ì™„ë£Œ í›„ ì¦‰ì‹œ download_workspace_file í˜¸ì¶œ

    let session_manager = get_session_manager();
    let file_manager = session_manager.get_file_manager();
    let workspace_dir = file_manager.base_dir();

    // ZIP íŒŒì¼ ìƒì„±
    let timestamp = chrono::Utc::now().format("%Y%m%d_%H%M%S");
    let zip_filename = format!("{}_{}.zip", package_name, timestamp);
    let zip_path = workspace_dir.join("exports/packages").join(&zip_filename);

    // ZIP ìƒì„± ë¡œì§ (ê¸°ì¡´ ì½”ë“œ ì¬ì‚¬ìš©)
    // ... ZIP ìƒì„± ì½”ë“œ ...

    // ìƒì„±ëœ ZIP íŒŒì¼ ì¦‰ì‹œ ë‹¤ìš´ë¡œë“œ
    let relative_path = format!("exports/packages/{}", zip_filename);
    download_workspace_file(app_handle, relative_path).await
}
```

**ë“±ë¡ ì¶”ê°€**:

```rust
.invoke_handler(tauri::generate_handler![
    // ê¸°ì¡´ handlers...
    download_workspace_file,
    export_and_download_zip,
])
```

### 2. HTML UIResource ìˆ˜ì •

**íŒŒì¼**: `src-tauri/src/mcp/builtin/workspace.rs`

```rust
fn create_html_export_ui(
    &self,
    title: &str,
    files: &[String],
    export_type: &str,
    download_path: &str,
) -> String {
    let files_list = files
        .iter()
        .map(|f| format!("<li class='file-item'>{}</li>", html_escape::encode_text(f)))
        .collect::<Vec<_>>()
        .join("");

    format!(
        r#"<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{}</title>
    <style>
        body {{
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }}
        .container {{
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }}
        .download-btn {{
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(33, 150, 243, 0.3);
        }}
        .download-btn:hover {{
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(33, 150, 243, 0.5);
        }}
        .download-btn:disabled {{
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }}
        .status-message {{
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }}
        .success {{ background-color: rgba(76, 175, 80, 0.3); }}
        .error {{ background-color: rgba(244, 67, 54, 0.3); }}
        .loading {{ background-color: rgba(255, 193, 7, 0.3); }}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‰ {}</h1>
        <div class="export-info">
            <h3>ğŸ“¦ Export Type: {}</h3>
            <p>ğŸ“… Created: {}</p>
            <p>ğŸ“ Files: {} items</p>
            <ul>{}</ul>
        </div>
        <div style="text-align: center;">
            <button id="downloadBtn" onclick="downloadFile()" class="download-btn">
                â¬‡ï¸ Download Now
            </button>
            <div id="statusMessage" class="status-message" style="display: none;"></div>
        </div>
    </div>

    <script>
        const downloadBtn = document.getElementById('downloadBtn');
        const statusMessage = document.getElementById('statusMessage');

        async function downloadFile() {{
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'â³ Downloading...';
            showStatus('Preparing download...', 'loading');

            try {{
                // MCP-UI í‘œì¤€ Tool Call Actionìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ ìš”ì²­
                window.parent.postMessage({{
                    type: 'tool',
                    payload: {{
                        toolName: 'download_workspace_file',
                        params: {{
                            filePath: '{}'
                        }}
                    }}
                }}, '*');

                showStatus('Download request sent!', 'success');
            }} catch (error) {{
                console.error('Download failed:', error);
                showStatus('Download failed: ' + error.message, 'error');
                resetButton();
            }}
        }}

        function showStatus(message, type) {{
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.style.display = 'block';
        }}

        function resetButton() {{
            downloadBtn.disabled = false;
            downloadBtn.textContent = 'â¬‡ï¸ Download Now';
        }}

        // Listen for download completion from parent
        window.addEventListener('message', function(event) {{
            if (event.data.type === 'download_complete') {{
                if (event.data.success) {{
                    showStatus('âœ… Download completed successfully!', 'success');
                }} else {{
                    showStatus('âŒ Download failed: ' + event.data.error, 'error');
                }}
                resetButton();
            }}
        }});
    </script>
</body>
</html>"#,
        html_escape::encode_text(title),
        html_escape::encode_text(title),
        html_escape::encode_text(export_type),
        chrono::Utc::now().format("%Y-%m-%d %H:%M:%S UTC"),
        files.len(),
        files_list,
        html_escape::encode_text(download_path)
    )
}
```

### 3. Frontend MCP-UI Action Handler ì¶”ê°€

**íŒŒì¼**: `src/components/ui/UIResourceRenderer.tsx`

```typescript
const handleUIAction = useCallback(async (event: MessageEvent) => {
  if (event.data.type === 'tool') {
    const { toolName, params } = event.data.payload;

    if (toolName === 'download_workspace_file') {
      try {
        // Tauri command í˜¸ì¶œ
        const result = await invoke('download_workspace_file', {
          filePath: params.filePath,
        });

        // ì„±ê³µ ê²°ê³¼ë¥¼ iframeì— ì „ì†¡
        event.source?.postMessage(
          {
            type: 'download_complete',
            success: true,
            result,
          },
          '*',
        );
      } catch (error) {
        // ì—ëŸ¬ ê²°ê³¼ë¥¼ iframeì— ì „ì†¡
        event.source?.postMessage(
          {
            type: 'download_complete',
            success: false,
            error: error.toString(),
          },
          '*',
        );
      }
    }
  }
}, []);

useEffect(() => {
  window.addEventListener('message', handleUIAction);
  return () => window.removeEventListener('message', handleUIAction);
}, [handleUIAction]);
```

## ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ê´€ ì½”ë“œ

### ê¸°ì¡´ í™œìš© ê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸

**íŒŒì¼**: `src/components/ui/UIResourceRenderer.tsx`

- **ê¸°ëŠ¥**: MCP-UI iframe ë Œë”ë§ ë° postMessage í†µì‹ 
- **ì¸í„°í˜ì´ìŠ¤**: `UIResource` íƒ€ì…, `onUIAction` ì½œë°±
- **ì¬ì‚¬ìš©**: postMessage ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í™•ì¥

**íŒŒì¼**: `src-tauri/src/mcp/builtin/workspace.rs`

- **ê¸°ëŠ¥**: Export ë””ë ‰í† ë¦¬ ê´€ë¦¬, ZIP ìƒì„± ë¡œì§
- **ì¬ì‚¬ìš©**: `ensure_exports_directory()`, ZIP ìƒì„± ì½”ë“œ
- **ì¸í„°í˜ì´ìŠ¤**: `handle_export_file()`, `handle_export_zip()` ë©”ì„œë“œ

**íŒŒì¼**: `src-tauri/src/services/mod.rs`

- **ê¸°ëŠ¥**: SecureFileManagerë¥¼ í†µí•œ ì•ˆì „í•œ íŒŒì¼ ì ‘ê·¼
- **ì¬ì‚¬ìš©**: íŒŒì¼ ê²½ë¡œ ê²€ì¦, ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë””ë ‰í† ë¦¬ ê´€ë¦¬
- **ì¸í„°í˜ì´ìŠ¤**: `validate_path()`, `base_dir()` ë©”ì„œë“œ

### í™•ì¥ í•„ìš”í•œ íƒ€ì… ì •ì˜

**íŒŒì¼**: `src/models/chat.ts`

```typescript
interface UIAction {
  type: 'tool' | 'prompt' | 'notify' | 'link';
  payload: {
    toolName?: string;
    params?: Record<string, any>;
    prompt?: string;
    message?: string;
    url?: string;
  };
}

interface DownloadResult {
  type: 'download_complete';
  success: boolean;
  result?: string;
  error?: string;
}
```

**íŒŒì¼**: `src-tauri/src/lib.rs`

- **í™•ì¥**: Tauri command ë“±ë¡ ë¦¬ìŠ¤íŠ¸ì— ìƒˆë¡œìš´ download commands ì¶”ê°€
- **ì¬ì‚¬ìš©**: ê¸°ì¡´ ì„¸ì…˜ ê´€ë¦¬ ë° íŒŒì¼ ë§¤ë‹ˆì € ì¸ìŠ¤í„´ìŠ¤

ì´ ê³„íšì„ í†µí•´ Asset Protocolì˜ ì œì•½ì„ ì™„ì „íˆ ìš°íšŒí•˜ê³ , MCP-UI í‘œì¤€ì„ ì¤€ìˆ˜í•˜ëŠ” ì•ˆì •ì ì¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œìŠ¤í…œì„ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
