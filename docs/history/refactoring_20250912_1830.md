# WorkspaceFilesPanel 파일 드롭 우선순위 개선 리팩토링 계획

## 작업의 목적

Chat 화면에서 WorkspaceFilesPanel이 활성화되어 있을 때, 사용자가 파일을 드래그앤드롭하면 ChatInput이 아닌 WorkspaceFilesPanel에서 우선적으로 처리되도록 개선하여 직관적인 사용자 경험을 제공한다.

## 현재의 상태 / 문제점

### 현재 동작

- 모든 파일 드롭 이벤트가 `useFileAttachment` 훅의 Tauri webview 레벨 이벤트 핸들러에서 처리됨
- WorkspaceFilesPanel이 활성화되어 있어도 파일 드롭이 항상 ChatInput 첨부 파일로만 처리됨
- WorkspaceFilesPanel의 HTML DOM 드롭 이벤트가 실행되지 않음

### 근본 원인

1. **이벤트 처리 우선순위 문제**: Tauri의 `getCurrentWebview().onDragDropEvent()`가 HTML DOM의 `onDrop` 이벤트보다 먼저 실행됨
2. **전역 이벤트 가로채기**: `useFileAttachment`가 webview 전체의 드롭 이벤트를 무조건적으로 처리
3. **제한적인 드롭 영역**: WorkspaceFilesPanel의 드롭 이벤트가 특정 DOM 요소(파일 노드, 업로드 박스)에만 바인딩되어 있음

### 코드 분석 결과

```typescript
// useFileAttachment.ts - 문제 코드
useEffect(() => {
  const setupDragDrop = async () => {
    const webview = getCurrentWebview();
    unlisten = await webview.onDragDropEvent((event) => {
      // WorkspacePanel 상태 고려 없이 모든 드롭 이벤트 처리
      if (event.payload.type === 'drop') {
        handleFileDrop(event.payload.paths);
      }
    });
  };
}, []); // WorkspacePanel 상태를 의존성에 포함하지 않음
```

## 추가 분석 과제

1. **Tauri 드롭 이벤트 위치 정보**: Tauri의 `onDragDropEvent`에서 마우스 위치 정보를 제공하는지 확인
2. **이벤트 전파 메커니즘**: Tauri webview 이벤트와 HTML DOM 이벤트 간의 상호작용 분석
3. **성능 영향도**: 조건부 이벤트 처리가 드롭 성능에 미치는 영향 측정

## 변경 이후의 상태 / 해결 판정 기준

### 기대 동작

1. **WorkspaceFilesPanel 활성화 상태**: 파일 드롭 시 WorkspaceFilesPanel에서 처리하여 워크스페이스에 파일 업로드
2. **WorkspaceFilesPanel 비활성화 상태**: 파일 드롭 시 ChatInput에서 처리하여 채팅 첨부 파일로 등록
3. **시각적 피드백**: 드롭 가능한 영역에 대한 명확한 시각적 안내

### 판정 기준

- [ ] WorkspaceFilesPanel이 열려있을 때 패널 영역에 파일 드롭 시 워크스페이스에 파일이 업로드됨
- [ ] WorkspaceFilesPanel이 열려있을 때 채팅 영역에 파일 드롭 시 ChatInput 첨부로 처리됨
- [ ] WorkspaceFilesPanel이 닫혀있을 때 모든 파일 드롭이 ChatInput 첨부로 처리됨
- [ ] 드롭 영역에 대한 적절한 시각적 피드백 제공
- [ ] 기존 기능에 영향 없음 (채팅 첨부, 워크스페이스 업로드 모두 정상 동작)

## 수정이 필요한 코드 및 수정부분의 코드 스니펫

### 1. useFileAttachment.ts - 조건부 드롭 처리 로직 추가

**파일 경로**: `src/features/chat/hooks/useFileAttachment.ts`

**현재 코드**:

```typescript
import React, { useCallback, useEffect, useRef, useState } from 'react';
import { getCurrentWebview } from '@tauri-apps/api/webview';
import { useSessionContext } from '@/context/SessionContext';

export function useFileAttachment() {
  // ... 기존 코드 ...

  useEffect(() => {
    let unlisten: (() => void) | undefined;

    const setupDragDrop = async () => {
      try {
        const webview = getCurrentWebview();
        unlisten = await webview.onDragDropEvent((event) => {
          if (event.payload.type === 'drop') {
            setDragState('none');
            handleFileDrop(event.payload.paths);
          }
        });
      } catch (error) {
        logger.error('Failed to setup drag and drop listener:', error);
      }
    };

    setupDragDrop();
  }, []);
}
```

**수정 코드**:

```typescript
import React, { useCallback, useEffect, useRef, useState } from 'react';
import { getCurrentWebview } from '@tauri-apps/api/webview';
import { useSessionContext } from '@/context/SessionContext';
import { useChatWorkspace } from '../context/ChatWorkspaceContext';

export function useFileAttachment() {
  const { showWorkspacePanel } = useChatWorkspace();
  // ... 기존 코드 ...

  useEffect(() => {
    let unlisten: (() => void) | undefined;

    const setupDragDrop = async () => {
      try {
        const webview = getCurrentWebview();
        unlisten = await webview.onDragDropEvent((event) => {
          if (event.payload.type === 'enter') {
            const isValid = validateFiles(event.payload.paths);
            setDragState(isValid ? 'valid' : 'invalid');
          } else if (event.payload.type === 'drop') {
            // WorkspacePanel이 활성화되어 있으면 드롭 이벤트를 무시
            if (showWorkspacePanel) {
              logger.debug(
                'Workspace panel active, ignoring drop event for chat attachment',
              );
              setDragState('none');
              return;
            }
            setDragState('none');
            handleFileDrop(event.payload.paths);
          } else if (event.payload.type === 'leave') {
            setDragState('none');
          }
        });
      } catch (error) {
        logger.error('Failed to setup drag and drop listener:', error);
      }
    };

    setupDragDrop();
  }, [showWorkspacePanel, handleFileDrop, validateFiles]);
}
```

### 2. WorkspaceFilesPanel.tsx - 패널 전체 드롭 영역 확장

**파일 경로**: `src/features/chat/components/WorkspaceFilesPanel.tsx`

**현재 코드**:

```tsx
return (
  <DndContext
    sensors={sensors}
    onDragStart={handleDragStart}
    onDragOver={handleDragOver}
    onDragEnd={handleDragEnd}
  >
    <Card className="w-80 h-full flex flex-col bg-background/95 backdrop-blur border-border/50">
      {/* ... 기존 내용 ... */}
    </Card>
  </DndContext>
);
```

**수정 코드**:

```tsx
return (
  <DndContext
    sensors={sensors}
    onDragStart={handleDragStart}
    onDragOver={handleDragOver}
    onDragEnd={handleDragEnd}
  >
    <Card
      className="w-80 h-full flex flex-col bg-background/95 backdrop-blur border-border/50"
      data-workspace-panel
      onDragOver={(e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'copy';
      }}
      onDrop={(e) => {
        e.preventDefault();
        e.stopPropagation(); // 이벤트 버블링 방지
        if (e.dataTransfer.files.length > 0) {
          logger.info('Files dropped on workspace panel');
          handleFilesDrop(e.dataTransfer.files, rootPath);
        }
      }}
    >
      {/* ... 기존 내용 ... */}
    </Card>
  </DndContext>
);
```

### 3. 드롭 상태 시각적 피드백 개선

**파일 경로**: `src/features/chat/components/WorkspaceFilesPanel.tsx`

**추가 코드**:

```tsx
const [isDragOver, setIsDragOver] = useState(false);

// Card 컴포넌트에 드래그 상태 스타일 추가
<Card
  className={`w-80 h-full flex flex-col bg-background/95 backdrop-blur border-border/50 transition-colors
    ${isDragOver ? 'border-blue-500 border-2 bg-blue-50/10' : ''}
  `}
  data-workspace-panel
  onDragEnter={(e) => {
    e.preventDefault();
    setIsDragOver(true);
  }}
  onDragLeave={(e) => {
    e.preventDefault();
    // 자식 요소로의 이동이 아닌 실제 패널 벗어남인지 확인
    if (!e.currentTarget.contains(e.relatedTarget as Node)) {
      setIsDragOver(false);
    }
  }}
  onDragOver={(e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
  }}
  onDrop={(e) => {
    e.preventDefault();
    e.stopPropagation();
    setIsDragOver(false);
    if (e.dataTransfer.files.length > 0) {
      logger.info('Files dropped on workspace panel');
      handleFilesDrop(e.dataTransfer.files, rootPath);
    }
  }}
>
```

## 재사용 가능한 연관 코드

### 관련 파일 및 주요 기능

1. **ChatWorkspaceContext.tsx** (`src/features/chat/context/ChatWorkspaceContext.tsx`)
   - `showWorkspacePanel` 상태 관리
   - WorkspacePanel 표시/숨김 제어

2. **Chat.tsx** (`src/features/chat/Chat.tsx`)
   - 전체 채팅 레이아웃 구조
   - WorkspaceFilesPanel과 ChatInput 배치 관리

3. **ChatInput.tsx** (`src/features/chat/components/ChatInput.tsx`)
   - `useFileAttachment` 훅 사용
   - 채팅 입력 및 파일 첨부 처리

4. **logger.ts** (`src/lib/logger.ts`)
   - 디버깅 및 로깅 유틸리티
   - 드롭 이벤트 추적에 활용

### 인터페이스 및 타입

```typescript
// ChatWorkspaceContext 인터페이스
interface ChatWorkspaceContextValue {
  showWorkspacePanel: boolean;
  setShowWorkspacePanel: (show: boolean) => void;
}

// 파일 드롭 이벤트 타입
interface TauriDragDropEvent {
  payload: {
    type: 'enter' | 'drop' | 'leave';
    paths: string[];
    position?: { x: number; y: number };
  };
}
```

### 재사용 가능한 패턴

1. **조건부 이벤트 처리 패턴**: 다른 패널에서도 유사한 우선순위 로직 적용 가능
2. **드롭 영역 확장 패턴**: 다른 컴포넌트에서 전체 영역 드롭 지원 시 재사용
3. **시각적 피드백 패턴**: 드래그 상태에 따른 UI 변화 로직

## Test Code 추가 및 수정 필요 부분에 대한 가이드

### 1. 단위 테스트 추가

**파일 경로**: `src/features/chat/hooks/__tests__/useFileAttachment.test.tsx`

```typescript
describe('useFileAttachment with WorkspacePanel', () => {
  test('should ignore drop events when workspace panel is active', async () => {
    const mockChatWorkspace = { showWorkspacePanel: true };

    // useFileAttachment 훅 테스트
    // WorkspacePanel 활성화 상태에서 드롭 이벤트 무시 확인
  });

  test('should handle drop events when workspace panel is inactive', async () => {
    const mockChatWorkspace = { showWorkspacePanel: false };

    // useFileAttachment 훅 테스트
    // WorkspacePanel 비활성화 상태에서 정상 처리 확인
  });
});
```

### 2. 통합 테스트 추가

**파일 경로**: `src/features/chat/components/__tests__/WorkspaceFilesPanel.integration.test.tsx`

```typescript
describe('WorkspaceFilesPanel File Drop Integration', () => {
  test('should upload files when dropped on panel area', async () => {
    // WorkspaceFilesPanel 렌더링
    // 파일 드롭 시뮬레이션
    // 파일 업로드 확인
  });

  test('should show visual feedback during drag', async () => {
    // 드래그 상태 시뮬레이션
    // 시각적 피드백 확인
  });
});
```

### 3. E2E 테스트 시나리오

**파일 경로**: `src/test/e2e/file-drop.spec.ts`

```typescript
describe('File Drop Priority E2E', () => {
  test('workspace panel priority when active', async () => {
    // 1. WorkspacePanel 활성화
    // 2. 파일 드롭
    // 3. 워크스페이스에 파일 업로드 확인
    // 4. ChatInput에 첨부되지 않음 확인
  });

  test('chat input fallback when workspace panel inactive', async () => {
    // 1. WorkspacePanel 비활성화
    // 2. 파일 드롭
    // 3. ChatInput에 파일 첨부 확인
  });
});
```

### 4. 테스트 실행 및 검증 가이드

```bash
# 단위 테스트 실행
pnpm test src/features/chat/hooks/useFileAttachment.test.tsx

# 통합 테스트 실행
pnpm test src/features/chat/components/WorkspaceFilesPanel.integration.test.tsx

# E2E 테스트 실행
pnpm test:e2e src/test/e2e/file-drop.spec.ts

# 전체 테스트 및 빌드 검증
pnpm refactor:validate
```

### 5. 수동 테스트 체크리스트

- [ ] WorkspacePanel 열린 상태에서 패널 영역에 파일 드롭 → 워크스페이스 업로드
- [ ] WorkspacePanel 열린 상태에서 채팅 영역에 파일 드롭 → 채팅 첨부 (예상되지 않음, 조건부 처리 후)
- [ ] WorkspacePanel 닫힌 상태에서 파일 드롭 → 채팅 첨부
- [ ] 드래그 중 시각적 피드백 확인
- [ ] 다중 파일 드롭 정상 처리
- [ ] 지원되지 않는 파일 형식 에러 처리

---

**작성일**: 2025년 9월 12일 18:30  
**작성자**: GitHub Copilot  
**브랜치**: fix/mcp-ui  
**연관 이슈**: WorkspaceFilesPanel 파일 드롭 우선순위 개선
