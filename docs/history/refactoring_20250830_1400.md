# Refactoring Plan: MCP Tool 응답 전달 경로 타입 안전성 강화

## 1. 작업의 목적

- MCP tool 응답이 전달되는 전체 경로 (모듈 → worker → proxy → provider → UI)의 타입 안전성과 일관성을 강화한다.
- 각 MCP 모듈의 tool 함수 반환 타입을 MCPResponse와 호환되도록 강제하여, 타입 불일치로 인한 런타임 에러를 방지한다.
- MCP 표준에 맞는 일관된 응답 구조를 유지하여, 각 레이어에서 타입 캐스팅 없이 안전하게 응답을 처리할 수 있도록 한다.

## 2. 현재의 상태 / 문제점

- 각 MCP 모듈의 tool 함수 반환 타입이 제각각 (Promise<unknown> 또는 구체 타입)으로, MCPResponse와 일치하지 않음.
- MCP worker에서 tool 결과를 그대로 result에 넣어 MCPResponse 구조가 일관되지 않음.
- MCP proxy에서 generic T로 반환하여 타입 추적이 어려움.
- WebMCPToolProvider에서 result를 text로 변환하거나 JSON.stringify로 감싸서 MCPResponse로 반환하는 등 일관성 부족.
- 전체 경로에서 타입 안전성이 보장되지 않아, 클라이언트에서 타입 캐스팅/검증이 필요함.

## 3. 추가 분석 과제 (선택적)

- 각 MCPTool의 input/output 타입을 명확히 정의하고, MCPResponse에 result 타입을 generic으로 지정 (MCPResponse<T>)하는 방안 검토.
- 기존 tool 함수들의 반환 타입을 MCPResponse로 마이그레이션할 때의 호환성 및 영향 범위 분석.
- MCP worker와 proxy 간의 타입 검증 로직 추가 방안 연구.

## 4. 변경 이후의 상태 / 해결 판정 기준

- 모든 MCP 모듈의 tool 함수가 Promise<MCPResponse>를 반환하도록 통일.
- MCP worker/proxy/provider/UI에서 MCPResponse만 처리하도록 일관성 확보.
- 각 레이어에서 타입 캐스팅 없이 안전하게 응답 처리 가능.
- MCP 표준에 맞는 일관된 응답 구조 유지.
- 변경 후, 전체 경로에서 타입 안전성이 보장되어 런타임 에러 감소 및 개발 생산성 향상.

## 5. 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 5.1 파일 경로: `/home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/modules/planning-server.ts`

**현재 코드 (callTool 메서드):**

```typescript
async callTool(name: string, args: unknown): Promise<unknown> {
  const typedArgs = args as Record<string, unknown>;
  switch (name) {
    case 'create_goal':
      return state.createGoal(
        typedArgs.name as string,
        typedArgs.description as string,
      );
    // ...다른 case들도 동일하게 구체 타입 반환...
  }
}
```

**제안 코드:**

```typescript
async callTool(name: string, args: unknown): Promise<MCPResponse> {
  const typedArgs = args as Record<string, unknown>;
  switch (name) {
    case 'create_goal':
      return normalizeToolResult(
        state.createGoal(
          typedArgs.name as string,
          typedArgs.description as string,
        ),
        'create_goal'
      );
    // ...다른 case들도 normalizeToolResult로 감싸서 MCPResponse 반환...
  }
}
```

### 5.2 파일 경로: `/home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/modules/content-store.ts`

**현재 코드 (callTool 메서드):**

```typescript
async callTool(name: string, args: unknown): Promise<unknown> {
  const typedArgs = args as Record<string, unknown>;
  switch (name) {
    case 'createStore':
      return createStore(typedArgs as CreateStoreInput);
    // ...다른 case들도 동일하게 Promise<구체타입> 반환...
  }
}
```

**제안 코드:**

```typescript
async callTool(name: string, args: unknown): Promise<MCPResponse> {
  const typedArgs = args as Record<string, unknown>;
  switch (name) {
    case 'createStore':
      return normalizeToolResult(
        await createStore(typedArgs as CreateStoreInput),
        'createStore'
      );
    // ...다른 case들도 normalizeToolResult로 감싸서 MCPResponse 반환...
  }
}
```

### 5.3 파일 경로: `/home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/mcp-worker.ts`

**현재 코드 (tool 실행 부분):**

```typescript
const result = await server.callTool(toolName, args);
return { id, result };
```

**제안 코드:**

```typescript
const result = await server.callTool(toolName, args);
return result; // 이미 MCPResponse이므로 그대로 반환
```

### 5.4 파일 경로: `/home/fritzprix/my_works/tauri-agent/src/lib/web-mcp/mcp-proxy.ts`

**현재 코드 (callTool 메서드):**

```typescript
async callTool<T>(toolName: string, args: unknown): Promise<T> {
  // ...메시지 전송 로직...
  return new Promise((resolve, reject) => {
    // ...resolve(response.result) 또는 reject(response.error)...
  });
}
```

**제안 코드:**

```typescript
async callTool(toolName: string, args: unknown): Promise<MCPResponse> {
  // ...메시지 전송 로직...
  return new Promise((resolve, reject) => {
    // ...resolve(response) 또는 reject(response.error)...
  });
}
```

### 5.5 파일 경로: `/home/fritzprix/my_works/tauri-agent/src/features/tools/WebMCPToolProvider.tsx`

**현재 코드 (executeTool 부분):**

```typescript
const result = await proxy.callTool(toolName, args);
// ...result를 text로 변환하거나 JSON.stringify로 감싸서 MCPResponse 반환...
```

**제안 코드:**

```typescript
const result = await proxy.callTool(toolName, args);
return result; // 이미 MCPResponse이므로 그대로 반환
```

## 6. file 규칙

- 변경 내역 및 계획은 `./docs/history/refactoring_{yyyyMMdd_hhmm}.md`에 기록
