# Browser Agent Server MCP í‘œì¤€ ì¤€ìˆ˜ ë° ë°ì´í„° ì €ì¥ ê°œì„  ê³„íš

## ì‘ì—…ì˜ ëª©ì 

`BrowserAgentServer`ì˜ MCP Response êµ¬ì¡°ë¥¼ í‘œì¤€ì— ë§ê²Œ ìˆ˜ì •í•˜ê³ , `extract_data` íˆ´ì—ì„œ ì¶”ì¶œëœ ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ì—¬ MCP í‘œì¤€ì„ ì™„ì „íˆ ì¤€ìˆ˜í•˜ë©´ì„œë„ ì‹¤ìš©ì ì¸ ë°ì´í„° ê´€ë¦¬ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

## í˜„ì¬ì˜ ìƒíƒœ / ë¬¸ì œì 

### 1. **MCP í‘œì¤€ ìœ„ë°˜: ë¹„í‘œì¤€ `data` í•„ë“œ ì‚¬ìš©**

**íŒŒì¼**: `src-tauri/src/mcp/builtin/browser_agent_server.rs` (lines 388-447)

```rust
// âŒ ë¬¸ì œ: MCP í‘œì¤€ì— ì—†ëŠ” data í•„ë“œ ì‚¬ìš©
MCPResponse {
    jsonrpc: "2.0".to_string(),
    id: Some(request_id),
    result: Some(json!({
        "content": [{
            "type": "text",
            "text": format!("âœ… Data extraction successful from session: {}", session_id)
        }],
        "data": {  // â† ì´ í•„ë“œëŠ” MCP í‘œì¤€ì— ì—†ìŒ
            "session_id": session_id,
            "script": script,
            "result": parsed_result
        }
    })),
    error: None,
}
```

- ëª¨ë“  í•¸ë“¤ëŸ¬ì—ì„œ ë¹„í‘œì¤€ `data` í•„ë“œë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒ
- MCP í‘œì¤€ì—ì„œëŠ” `result` ë‚´ì— `content` ë°°ì—´ë§Œ í—ˆìš©ë¨
- í´ë¼ì´ì–¸íŠ¸ê°€ `content` ë°°ì—´ë§Œ ì²˜ë¦¬í•˜ì—¬ ì‹¤ì œ ë°ì´í„°ê°€ í‘œì‹œë˜ì§€ ì•ŠìŒ

### 2. **`extract_data` ê²°ê³¼ê°€ ì˜êµ¬ ì €ì¥ë˜ì§€ ì•ŠìŒ**

- ì¶”ì¶œëœ ë°ì´í„°ê°€ MCP ì‘ë‹µì—ë§Œ í¬í•¨ë˜ê³  íŒŒì¼ë¡œ ì €ì¥ë˜ì§€ ì•ŠìŒ
- í° ë°ì´í„°ì˜ ê²½ìš° ì‘ë‹µ í¬ê¸° ì œí•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ì„±
- ì¶”ì¶œ ê²°ê³¼ì˜ ì¬ì‚¬ìš©ì´ë‚˜ í›„ì† ë¶„ì„ì´ ì–´ë ¤ì›€

### 3. **ëª¨ë“  í•¸ë“¤ëŸ¬ì˜ ì¼ê´€ì„± ë¶€ì¡±**

**ì˜í–¥ë°›ëŠ” í•¸ë“¤ëŸ¬ë“¤**:
- `handle_extract_data` (lines 388-447)
- `handle_create_browser_session` (lines 449-484)
- `handle_click_element` (lines 486-545)
- `handle_input_text` (lines 547-617)
- `handle_navigate_url` (lines 619-669)

## ë³€ê²½ ì´í›„ì˜ ìƒíƒœ / í•´ê²° íŒì • ê¸°ì¤€

### ì„±ê³µ ê¸°ì¤€

1. **MCP í‘œì¤€ ì™„ì „ ì¤€ìˆ˜**: ëª¨ë“  í•¸ë“¤ëŸ¬ì—ì„œ `data` í•„ë“œ ì œê±°, `content` ë°°ì—´ë§Œ ì‚¬ìš©
2. **ë°ì´í„° íŒŒì¼ ì €ì¥**: `extract_data` íˆ´ ì‹¤í–‰ ì‹œ ê²°ê³¼ê°€ JSON íŒŒì¼ë¡œ ì €ì¥ë¨
3. **ìƒëŒ€ ê²½ë¡œ ë°˜í™˜**: MCP íŒŒì¼ì‹œìŠ¤í…œ í˜¸í™˜ì„±ì„ ìœ„í•œ ìƒëŒ€ ê²½ë¡œ ì œê³µ
4. **ì¼ê´€ëœ ì‘ë‹µ êµ¬ì¡°**: ëª¨ë“  íˆ´ì—ì„œ ë™ì¼í•œ ì‘ë‹µ íŒ¨í„´ ì‚¬ìš©

### ê²€ì¦ ë°©ë²•

- `extract_data` íˆ´ ì‹¤í–‰ í›„ `crawl_cache` ë””ë ‰í† ë¦¬ì— JSON íŒŒì¼ ìƒì„± í™•ì¸
- MCP ì‘ë‹µì—ì„œ `data` í•„ë“œê°€ ì™„ì „íˆ ì œê±°ë˜ì—ˆëŠ”ì§€ í™•ì¸
- ìƒëŒ€ ê²½ë¡œê°€ ì˜¬ë°”ë¥´ê²Œ ë°˜í™˜ë˜ëŠ”ì§€ í™•ì¸
- ëª¨ë“  í•¸ë“¤ëŸ¬ê°€ ë™ì¼í•œ ì‘ë‹µ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ í™•ì¸

## ìˆ˜ì •ì´ í•„ìš”í•œ ì½”ë“œ ë° ìˆ˜ì •ë¶€ë¶„ì˜ ì½”ë“œ ìŠ¤ë‹ˆí•

### 1. **`handle_extract_data` ë©”ì„œë“œ ì™„ì „ ì¬êµ¬í˜„**

**íŒŒì¼**: `src-tauri/src/mcp/builtin/browser_agent_server.rs` (lines 388-447)

```rust
// í˜„ì¬ ìƒíƒœ - MCP í‘œì¤€ ìœ„ë°˜
async fn handle_extract_data(&self, args: Value) -> MCPResponse {
    // ... íŒŒë¼ë¯¸í„° ì¶”ì¶œ ë¡œì§ ...

    match self.browser_server.execute_script(session_id, script).await {
        Ok(result) => {
            let parsed_result = match serde_json::from_str::<Value>(&result) {
                Ok(json_val) => json_val,
                Err(_) => json!(result),
            };

            MCPResponse {
                jsonrpc: "2.0".to_string(),
                id: Some(request_id),
                result: Some(json!({
                    "content": [{
                        "type": "text",
                        "text": format!("âœ… Data extraction successful from session: {}", session_id)
                    }],
                    "data": {  // âŒ ë¹„í‘œì¤€ í•„ë“œ
                        "session_id": session_id,
                        "script": script,
                        "result": parsed_result
                    }
                })),
                error: None,
            }
        }
    }
}

// ìˆ˜ì • í›„ - MCP í‘œì¤€ ì¤€ìˆ˜ + íŒŒì¼ ì €ì¥
async fn handle_extract_data(&self, args: Value) -> MCPResponse {
    let request_id = Value::String(Uuid::new_v4().to_string());

    let session_id = match args.get("session_id").and_then(|v| v.as_str()) {
        Some(id) => id,
        None => {
            return MCPResponse {
                jsonrpc: "2.0".to_string(),
                id: Some(request_id),
                result: None,
                error: Some(MCPError {
                    code: -32602,
                    message: "Missing required parameter: session_id".to_string(),
                    data: None,
                }),
            };
        }
    };

    let script = match args.get("script").and_then(|v| v.as_str()) {
        Some(s) => s,
        None => {
            return MCPResponse {
                jsonrpc: "2.0".to_string(),
                id: Some(request_id),
                result: None,
                error: Some(MCPError {
                    code: -32602,
                    message: "Missing required parameter: script".to_string(),
                    data: None,
                }),
            };
        }
    };

    match self.browser_server.execute_script(session_id, script).await {
        Ok(result) => {
            info!("Data extraction successful for session: {}", session_id);
            
            let parsed_result = match serde_json::from_str::<Value>(&result) {
                Ok(json_val) => json_val,
                Err(_) => json!(result),
            };

            let data_size = serde_json::to_string(&parsed_result)
                .map(|s| s.len())
                .unwrap_or(0);

            // âœ… ì¶”ì¶œëœ ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥
            match self.save_extracted_data(session_id, script, &parsed_result).await {
                Ok(saved_path) => {
                    match self.make_relative_path(&saved_path) {
                        Ok(relative_path) => {
                            // âœ… MCP í‘œì¤€ ì¤€ìˆ˜: content ë°°ì—´ë§Œ ì‚¬ìš©
                            MCPResponse {
                                jsonrpc: "2.0".to_string(),
                                id: Some(request_id),
                                result: Some(json!({
                                    "content": [
                                        {
                                            "type": "text",
                                            "text": format!("âœ… Data extraction successful from session: {}", session_id)
                                        },
                                        {
                                            "type": "text",
                                            "text": format!("ğŸ“Š **Data size:** {} bytes", data_size)
                                        },
                                        {
                                            "type": "text",
                                            "text": format!("ğŸ’¾ **Saved extraction data to:** {}", relative_path)
                                        }
                                    ]
                                })),
                                error: None,
                            }
                        }
                        Err(e) => {
                            warn!("Failed to convert to relative path: {}", e);
                            MCPResponse {
                                jsonrpc: "2.0".to_string(),
                                id: Some(request_id),
                                result: Some(json!({
                                    "content": [{
                                        "type": "text",
                                        "text": format!("âœ… Data extraction successful from session: {}\nâš ï¸ Failed to create relative path: {}", session_id, e)
                                    }]
                                })),
                                error: None,
                            }
                        }
                    }
                }
                Err(e) => {
                    warn!("Failed to save extracted data: {}", e);
                    MCPResponse {
                        jsonrpc: "2.0".to_string(),
                        id: Some(request_id),
                        result: Some(json!({
                            "content": [{
                                "type": "text",
                                "text": format!("âœ… Data extraction successful from session: {}\nâš ï¸ Failed to save data: {}", session_id, e)
                            }]
                        })),
                        error: None,
                    }
                }
            }
        }
        Err(e) => {
            warn!("Data extraction failed for session {}: {}", session_id, e);
            
            MCPResponse {
                jsonrpc: "2.0".to_string(),
                id: Some(request_id),
                result: None,
                error: Some(MCPError {
                    code: -32603,
                    message: format!("Script execution failed: {}", e),
                    data: None,
                }),
            }
        }
    }
}
```

### 2. **ë°ì´í„° ì €ì¥ ë©”ì„œë“œ ì¶”ê°€**

**íŒŒì¼**: `src-tauri/src/mcp/builtin/browser_agent_server.rs` (ìƒˆë¡œ ì¶”ê°€)

```rust
/// Save extracted data to JSON file
async fn save_extracted_data(
    &self,
    session_id: &str,
    script: &str,
    extracted_data: &Value,
) -> Result<PathBuf, String> {
    let crawl_dir = self.get_crawl_temp_dir().await?;
    
    // Generate unique filename based on session and timestamp
    let timestamp = chrono::Utc::now().format("%Y%m%d_%H%M%S").to_string();
    let session_short = &session_id[..8.min(session_id.len())];
    let file_name = format!("extraction_{}_{}.json", session_short, timestamp);
    let file_path = crawl_dir.join(file_name);

    // Create extraction result structure
    let extraction_result = json!({
        "session_id": session_id,
        "script": script,
        "extracted_data": extracted_data,
        "extraction_timestamp": chrono::Utc::now().to_rfc3339(),
        "synaptic_flow_version": "1.0.0"
    });

    // Save as formatted JSON
    let json_content = serde_json::to_string_pretty(&extraction_result)
        .map_err(|e| format!("Failed to serialize extraction data: {}", e))?;

    tokio::fs::write(&file_path, json_content)
        .await
        .map_err(|e| format!("Failed to save extraction data: {}", e))?;

    info!("Saved extraction data to: {:?}", file_path);
    Ok(file_path)
}
```

### 3. **ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ë“¤ì˜ `data` í•„ë“œ ì œê±°**

**íŒŒì¼**: `src-tauri/src/mcp/builtin/browser_agent_server.rs`

#### handle_create_browser_session (lines 449-484)

```rust
// í˜„ì¬ ìƒíƒœ
MCPResponse {
    jsonrpc: "2.0".to_string(),
    id: Some(request_id),
    result: Some(json!({
        "content": [{
            "type": "text",
            "text": format!("âœ… Browser session created successfully: {}\nğŸŒ URL: {}", session_id, url)
        }],
        "data": {  // âŒ ì œê±° í•„ìš”
            "session_id": session_id,
            "url": url,
            "title": title.unwrap_or("Browser Session")
        }
    })),
    error: None,
}

// ìˆ˜ì • í›„
MCPResponse {
    jsonrpc: "2.0".to_string(),
    id: Some(request_id),
    result: Some(json!({
        "content": [
            {
                "type": "text",
                "text": format!("âœ… Browser session created successfully: {}", session_id)
            },
            {
                "type": "text",
                "text": format!("ğŸŒ **URL:** {}", url)
            },
            {
                "type": "text",
                "text": format!("ğŸ“ **Title:** {}", title.unwrap_or("Browser Session"))
            }
        ]
    })),
    error: None,
}
```

#### handle_click_element (lines 486-545)

```rust
// í˜„ì¬ ìƒíƒœ
result: Some(json!({
    "content": [{
        "type": "text",
        "text": format!("âœ… Element clicked successfully: {}\nğŸ¯ Selector: {}", result, selector)
    }],
    "data": {  // âŒ ì œê±° í•„ìš”
        "session_id": session_id,
        "selector": selector,
        "result": result
    }
})),

// ìˆ˜ì • í›„
result: Some(json!({
    "content": [
        {
            "type": "text",
            "text": format!("âœ… Element clicked successfully")
        },
        {
            "type": "text",
            "text": format!("ğŸ¯ **Selector:** {}", selector)
        },
        {
            "type": "text",
            "text": format!("ğŸ“‹ **Result:** {}", result)
        }
    ]
})),
```

#### handle_input_text (lines 547-617)

```rust
// í˜„ì¬ ìƒíƒœ
result: Some(json!({
    "content": [{
        "type": "text",
        "text": format!("âœ… Text input successful: {}\nğŸ“ Text: '{}' into selector: {}", result, text, selector)
    }],
    "data": {  // âŒ ì œê±° í•„ìš”
        "session_id": session_id,
        "selector": selector,
        "text": text,
        "result": result
    }
})),

// ìˆ˜ì • í›„
result: Some(json!({
    "content": [
        {
            "type": "text",
            "text": "âœ… Text input successful"
        },
        {
            "type": "text",
            "text": format!("ğŸ¯ **Selector:** {}", selector)
        },
        {
            "type": "text",
            "text": format!("ğŸ“ **Text:** '{}'", text)
        },
        {
            "type": "text",
            "text": format!("ğŸ“‹ **Result:** {}", result)
        }
    ]
})),
```

#### handle_navigate_url (lines 619-669)

```rust
// í˜„ì¬ ìƒíƒœ
result: Some(json!({
    "content": [{
        "type": "text",
        "text": format!("âœ… Navigation successful: {}\nğŸŒ Navigated to: {}", result, url)
    }],
    "data": {  // âŒ ì œê±° í•„ìš”
        "session_id": session_id,
        "url": url,
        "result": result
    }
})),

// ìˆ˜ì • í›„
result: Some(json!({
    "content": [
        {
            "type": "text",
            "text": "âœ… Navigation successful"
        },
        {
            "type": "text",
            "text": format!("ğŸŒ **Navigated to:** {}", url)
        },
        {
            "type": "text",
            "text": format!("ğŸ“‹ **Result:** {}", result)
        }
    ]
})),
```

### 4. **handle_crawl_pageì˜ `data` í•„ë“œë„ ì œê±°**

**íŒŒì¼**: `src-tauri/src/mcp/builtin/browser_agent_server.rs` (lines 267-320)

```rust
// í˜„ì¬ ìƒíƒœ
MCPResponse {
    jsonrpc: "2.0".to_string(),
    id: Some(request_id),
    result: Some(json!({
        "content": [{
            "type": "text",
            "text": status_message
        }],
        "data": response_data  // âŒ ì œê±° í•„ìš”
    })),
    error: None,
}

// ìˆ˜ì • í›„
MCPResponse {
    jsonrpc: "2.0".to_string(),
    id: Some(request_id),
    result: Some(json!({
        "content": [
            {
                "type": "text",
                "text": status_message
            },
            {
                "type": "text",
                "text": format!("ğŸ“Š **Extracted {} selectors**", selectors.len())
            },
            {
                "type": "text",
                "text": format!("â° **Crawled at:** {}", chrono::Utc::now().to_rfc3339())
            }
        ]
    })),
    error: None,
}
```

## êµ¬í˜„ ìˆœì„œ

1. **ë°ì´í„° ì €ì¥ ë©”ì„œë“œ êµ¬í˜„** (`save_extracted_data` ì¶”ê°€)
2. **handle_extract_data ë©”ì„œë“œ ì™„ì „ ì¬êµ¬í˜„** (íŒŒì¼ ì €ì¥ + MCP í‘œì¤€ ì¤€ìˆ˜)
3. **ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ë“¤ì˜ data í•„ë“œ ì œê±°** (create_browser_session, click_element, input_text, navigate_url)
4. **handle_crawl_pageì˜ data í•„ë“œ ì œê±°**
5. **í…ŒìŠ¤íŠ¸ ë° ê²€ì¦**

## ì˜ˆìƒ ì†Œìš” ì‹œê°„

- ë°ì´í„° ì €ì¥ ë©”ì„œë“œ êµ¬í˜„: 1ì‹œê°„
- handle_extract_data ì¬êµ¬í˜„: 1ì‹œê°„
- ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ë“¤ ìˆ˜ì •: 2ì‹œê°„
- í…ŒìŠ¤íŠ¸ ë° ê²€ì¦: 1ì‹œê°„
- **ì´ ì˜ˆìƒ ì‹œê°„: 5ì‹œê°„**

## ìœ„í—˜ ìš”ì†Œ

- **ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ í˜¸í™˜ì„±**: `data` í•„ë“œì— ì˜ì¡´í•˜ëŠ” ì½”ë“œê°€ ìˆì„ ê²½ìš° ì˜í–¥
- **íŒŒì¼ ì‹œìŠ¤í…œ ê¶Œí•œ**: íŒŒì¼ ì €ì¥ ì‹œ ê¶Œí•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ì„±
- **ë””ìŠ¤í¬ ê³µê°„**: ì¶”ì¶œ ë°ì´í„° ëˆ„ì ìœ¼ë¡œ ì¸í•œ ì €ì¥ ê³µê°„ ì‚¬ìš©ëŸ‰ ì¦ê°€

## ì¶”ê°€ ê³ ë ¤ì‚¬í•­

- ì¶”ì¶œëœ ë°ì´í„° íŒŒì¼ì˜ ì •ê¸°ì ì¸ ì •ë¦¬ ë©”ì»¤ë‹ˆì¦˜ í•„ìš”
- íŒŒì¼ëª… ì¶©ëŒ ë°©ì§€ë¥¼ ìœ„í•œ ë” ì •êµí•œ ë„¤ì´ë° ê·œì¹™ ê³ ë ¤
- í° ë°ì´í„° ì²˜ë¦¬ ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì í™” í•„ìš”
- MCP í‘œì¤€ ì¤€ìˆ˜ë¡œ ë‹¤ë¥¸ MCP í´ë¼ì´ì–¸íŠ¸ì™€ì˜ í˜¸í™˜ì„± í–¥ìƒ
