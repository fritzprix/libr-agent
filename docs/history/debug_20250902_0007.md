# Debug Plan: Claude Extended Thinking API 메시지 포맷 오류

## 문제의 발생 경로

1. **사용자 요청**: "go to hackernews and research top 10 stories"
2. **AI 응답 생성**: Claude Sonnet 4 모델로 assistant 메시지 생성 (thinking 블록 + tool_calls 포함)
3. **Tool 실행**: `builtin_planning_server__create_goal` tool 성공적으로 실행
4. **Tool 결과 메시지 추가**: role: 'tool'인 메시지가 이력에 추가됨
5. **다음 AI 호출 시도**: 메시지 배열을 Claude API에 전송
6. **API 오류 발생**:
   ```
   messages.1.content.0.type: Expected `thinking` or `redacted_thinking`, but found `tool_use`.
   When `thinking` is enabled, a final `assistant` message must start with a thinking block
   ```

## 해결 이후 상태

- Claude Extended Thinking API 규칙을 만족하는 메시지 포맷으로 변환
- assistant 메시지의 첫 번째 content 블록이 항상 `thinking` 타입이 되도록 보장
- tool 결과 이후에도 연속적인 AI 대화가 정상적으로 진행
- thinking 블록이 메시지 이력 관리 과정에서 유실되지 않음

## 관련 이슈에 대한 웹 검색 쿼리

- "Anthropic Claude Extended Thinking API message format requirements"
- "Claude thinking block tool_use tool_result order"
- "Anthropic API messages.content.type thinking redacted_thinking"
- "Claude 4 thinking enabled assistant message format"

## 문제의 원인에 대한 가설

### 가설 1: Anthropic 메시지 변환 시 thinking 블록 누락

**관련 코드**: `src/lib/ai-service/anthropic.ts`의 `convertToAnthropicMessages` 메서드

- **세부 내용**: assistant 메시지를 Anthropic 포맷으로 변환할 때, `thinking` 필드가 있어도 content 배열의 첫 번째 블록으로 추가되지 않음
- **확인 방법**: `convertToAnthropicMessages` 메서드에서 thinking 블록 처리 로직 확인

### 가설 2: 메시지 이력 저장 시 thinking 필드 유실

**관련 코드**: `src/context/SessionHistoryContext.tsx`의 `addMessage`, `addMessages` 메서드

- **세부 내용**: Message 객체를 IndexedDB에 저장하거나 메모리에 저장할 때 thinking 필드가 직렬화/역직렬화 과정에서 누락
- **확인 방법**: 저장된 메시지 객체에 thinking 필드가 올바르게 포함되어 있는지 확인

### 가설 3: AI 서비스 응답 메시지 생성 시 thinking 필드 처리 오류

**관련 코드**: `src/hooks/use-ai-service.ts`의 `submit` 메서드

- **세부 내용**: AI 응답을 Message 객체로 변환할 때 thinking 필드가 올바르게 설정되지 않거나, 스트리밍 중에 thinking 내용이 올바르게 수집되지 않음
- **확인 방법**: 응답 메시지 생성 로직에서 thinking 필드 처리 부분 확인

### 가설 4: 메시지 전처리 과정에서 thinking 블록 제거

**관련 코드**: `src/hooks/use-ai-service.ts`의 `prepareMessagesForLLM` 함수

- **세부 내용**: LLM에 전달하기 전 메시지 전처리 과정에서 thinking 관련 내용이 제거되거나 변형됨
- **확인 방법**: `prepareMessagesForLLM` 함수의 메시지 처리 로직 확인

### 가설 5: 컨텍스트 윈도우 제한으로 인한 메시지 잘림

**관련 코드**: `src/hooks/use-ai-service.ts`의 컨텍스트 윈도우 처리 부분

- **세부 내용**: 메시지가 컨텍스트 윈도우 크기를 초과할 때 메시지를 자르는 과정에서 thinking 블록이 제거됨
- **확인 방법**: 컨텍스트 윈도우 제한 로직에서 assistant 메시지 처리 방식 확인

## 추가 분석 및 확인이 필요한 사항

1. **Message 타입 정의 확인**: `src/models/chat.ts`에서 Message 인터페이스에 thinking 필드가 올바르게 정의되어 있는지 확인
2. **Anthropic API 응답 파싱**: AI 서비스에서 Anthropic API 응답을 파싱할 때 thinking 내용이 올바르게 추출되는지 확인
3. **Tool 실행 후 메시지 플로우**: Tool 결과 메시지 추가 후 다음 AI 호출까지의 전체 메시지 플로우 추적
4. **다른 모델과의 동작 비교**: Claude 3.5 Sonnet 등 thinking 미지원 모델에서는 정상 동작하는지 확인
5. **IndexedDB 저장/복원**: 메시지가 IndexedDB에 저장되고 복원될 때 thinking 필드가 유지되는지 확인

## Debugging History Section

### 작업자를 위한 지침

이 섹션에서는 debugging 진행 과정을 다음 원칙에 따라 기록해주세요:

**각 시도마다 다음 형식으로 기록:**

#### [시도 번호] - [날짜/시간]

- **가설**: 어떤 가설을 검증하려고 했는지
- **변경 상세 내역**:
  - 관련 코드 위치: `파일경로:라인번호`
  - 변경 부분 상세: 구체적인 코드 변경 내용
- **해결 여부**: 성공/실패/부분적 성공
- **결과에 대한 분석**:
  - 예상과 다른 결과가 나온 이유
  - 새롭게 발견된 정보
  - 다음 탐색 방향 제시

**예시:**

#### [시도 1] - 2025-09-02 00:30

- **가설**: Anthropic 메시지 변환 시 thinking 블록이 content 배열 첫 번째로 추가되지 않음
- **변경 상세 내역**:
  - 관련 코드 위치: `src/lib/ai-service/anthropic.ts:45-60`
  - 변경 부분 상세: convertToAnthropicMessages 메서드에서 thinking 블록을 content 배열 맨 앞에 추가하는 로직 구현
- **해결 여부**: 부분적 성공
- **결과에 대한 분석**:
  - API 오류는 해결되었으나, thinking 내용이 중복으로 표시됨
  - Message 타입에서 thinking 필드와 content 배열의 thinking 블록 간 관계 정리 필요
  - 다음: Message 타입 정의 및 thinking 필드 처리 로직 통합 검토

---

**중요**: 각 디버깅 시도 후 반드시 이 섹션을 업데이트하여 진행 상황을 추적할 수 있도록 해주세요.
