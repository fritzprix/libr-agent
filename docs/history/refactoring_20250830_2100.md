# Refactoring Plan: 사용자 중복 파일 에러 메시지 정정

## 작업의 목적

파일 첨부 시스템의 사용자 경험 개선을 위해, 중복 파일 업로드 시 표시되는 에러 메시지를 실제 시스템 동작과 일치하도록 정정한다. 현재 메시지는 전역 중복 금지를 암시하지만, 실제로는 세션(storeId)별 중복 방지 정책을 따르고 있어 사용자 혼동을 방지하고 정확한 안내를 제공한다.

## 현재의 상태 / 문제점

- **문제점**: `ResourceAttachmentContext.tsx`의 `addFile` 함수에서 중복 컨텐츠 감지 시 사용자에게 표시되는 에러 메시지가 다음과 같음:

  ```text
  "This file content has already been uploaded in another session. The same content can only be uploaded once across all sessions."
  ```

- **실제 동작과의 불일치**: 시스템은 SHA-256 해시 기반으로 동일 컨텐츠를 **같은 세션(storeId) 내에서만** 중복 방지함. 다른 세션에서는 동일 컨텐츠의 재업로드를 허용함.
- **영향**: 사용자가 메시지를 보고 전역 중복 금지로 오해하여 불필요한 혼동을 겪을 수 있음.

## 추가 분석 과제

- 중복 감지 로직의 정확성 검증: `content-store.ts`의 `findByHashAndStore` 함수가 storeId별로 올바르게 동작하는지 확인.
- 사용자 메시지 일관성 검토: 다른 에러 메시지들도 실제 동작과 일치하는지 전체 검토.

## 변경 이후의 상태 / 해결 판정 기준

- **해결 판정 기준**:
  - 중복 에러 메시지가 "동일 세션 내 중복 방지" 정책을 정확히 반영함.
  - 메시지가 사용자에게 혼동을 주지 않고, 실제 시스템 동작을 명확히 안내함.
  - 코드 변경 후 테스트에서 중복 시나리오가 올바른 메시지를 표시함.

## 수정이 필요한 코드 및 수정부분의 코드 스니핏

### 대상 파일: `src/context/ResourceAttachmentContext.tsx`

**수정 위치**: `addFile` 함수 내 중복 처리 에러 블록 (약 620-630줄 근처)

**현재 코드**:

```typescript
// Handle duplicate document errors gracefully
if (
  errorMsg.includes('Duplicate document encountered') ||
  errorMsg.includes('winkBM25S') ||
  errorMsg.includes('Duplicate document')
) {
  logger.warn('Duplicate file content detected by server', {
    filename: actualFilename,
    sessionId: currentSession?.id,
    error: errorMsg,
    filesInCurrentSession: sessionFiles.length,
  });

  // Check if we already have this file in our current session's state
  const existingFile = sessionFiles.find(
    (f) => f.filename === actualFilename,
  );
  if (existingFile) {
    logger.info('Returning existing file from current session', {
      contentId: existingFile.contentId,
      filename: existingFile.filename,
      sessionId: currentSession?.id,
    });
    return existingFile;
  }

  // File exists globally but not in current session - inform user
  throw new Error(
    `This file content has already been uploaded in another session. The same content can only be uploaded once across all sessions. File: "${actualFilename}"`,
  );
}
```

**수정 후 코드**:

```typescript
// Handle duplicate document errors gracefully
if (
  errorMsg.includes('Duplicate document encountered') ||
  errorMsg.includes('winkBM25S') ||
  errorMsg.includes('Duplicate document')
) {
  logger.warn('Duplicate file content detected by server', {
    filename: actualFilename,
    sessionId: currentSession?.id,
    error: errorMsg,
    filesInCurrentSession: sessionFiles.length,
  });

  // Check if we already have this file in our current session's state
  const existingFile = sessionFiles.find(
    (f) => f.filename === actualFilename,
  );
  if (existingFile) {
    logger.info('Returning existing file from current session', {
      contentId: existingFile.contentId,
      filename: existingFile.filename,
      sessionId: currentSession?.id,
    });
    return existingFile;
  }

  // File exists in another session but not in current session - inform user
  throw new Error(
    `This file content has already been uploaded in the current session. The same content can only be uploaded once within the same session. File: "${actualFilename}"`,
  );
}
```

**변경 사항 설명**:

- 에러 메시지를 "another session"에서 "current session"으로 변경
- "across all sessions"에서 "within the same session"으로 변경
- 실제 시스템 동작(세션별 중복 방지)을 정확히 반영하여 사용자 혼동 방지
